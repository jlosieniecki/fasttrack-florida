<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Florida FAST Math | Procedural Level 5 Engine</title>
    <style>
        :root {
            --cam-blue: #003366; --cam-light-blue: #e6f0fa; --cam-gray: #f4f4f4;
            --border: #cccccc; --text: #333333; --focus: #ff9900;
        }
        * { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; }
        body { margin: 0; padding: 0; background: var(--cam-gray); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* DASHBOARD */
        #dashboard { display: flex; height: 100vh; }
        .sidebar { width: 340px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .logo-area { padding: 25px; background: var(--cam-blue); color: white; }
        .logo-area h1 { margin: 0; font-size: 1.3rem; letter-spacing: 0.5px; }
        .menu-scroll { flex: 1; overflow-y: auto; padding: 10px; }
        .cat-title { font-size: 0.8rem; text-transform: uppercase; color: #666; font-weight: bold; margin: 15px 0 5px 5px; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        .std-btn { display: block; width: 100%; text-align: left; padding: 10px; margin-bottom: 2px; background: transparent; border: 1px solid transparent; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #333; }
        .std-btn:hover { background: var(--cam-light-blue); }
        .std-btn small { display: block; font-size: 0.75rem; margin-top: 3px; color: #666; }

        .main-dash { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; text-align: center; background: white; }
        .mock-btn { padding: 18px 40px; font-size: 1.2rem; font-weight: bold; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s; }
        .mock-btn:hover { background: #0056b3; transform: translateY(-2px); }

        /* CAMBIUM TEST INTERFACE */
        #test-interface { display: none; height: 100vh; flex-direction: column; background: white; }
        
        .top-nav { background: var(--cam-blue); color: white; height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; flex-shrink: 0; }
        .nav-left { display: flex; gap: 15px; align-items: center; }
        .nav-right { display: flex; gap: 10px; }
        .nav-btn { background: transparent; border: 1px solid white; color: white; padding: 6px 15px; cursor: pointer; font-size: 0.9rem; border-radius: 3px; }
        .nav-btn:hover { background: rgba(255,255,255,0.2); }
        .nav-btn.primary { background: white; color: var(--cam-blue); font-weight: bold; }
        
        .test-body { flex: 1; display: flex; overflow: hidden; }
        .pane { flex: 1; overflow-y: auto; padding: 40px; position: relative; }
        .stimulus-pane { border-right: 2px solid var(--border); background: #fafafa; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .response-pane { background: white; display: flex; flex-direction: column; }

        .q-text { font-size: 1.25rem; line-height: 1.6; margin-bottom: 25px; }

        /* TEI Elements */
        .visual-stage svg { max-width: 100%; height: auto; overflow: visible; margin-bottom: 15px; }
        .clk-slice { cursor: pointer; transition: 0.1s; }
        .clk-slice:hover { stroke: var(--focus); stroke-width: 3px; }
        .bar-zone { cursor: pointer; }
        .bar-zone:hover rect { fill: #b2dfdb; }
        
        .hot-text { cursor: pointer; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; margin: 0 3px; background: white; display: inline-block; font-weight: bold;}
        .hot-text:hover { border-color: #666; background: #e9ecef; }
        .hot-text.selected { background: var(--cam-blue); color: white; border-color: var(--cam-blue); }
        .inline-drop { font-size: 1.1rem; padding: 6px 10px; border: 2px solid #666; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 0 4px; }

        /* Radio & Checkbox */
        .opt-list { display: flex; flex-direction: column; gap: 12px; }
        .opt-list.grid { display: grid; grid-template-columns: 1fr 1fr; }
        .opt-item { display: flex; align-items: center; padding: 15px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 1.1rem; background: white;}
        .opt-item:hover { background: var(--cam-light-blue); }
        .opt-item.selected { border-color: var(--cam-blue); background: var(--cam-light-blue); box-shadow: inset 0 0 0 1px var(--cam-blue); }
        .opt-icon { width: 22px; height: 22px; border: 2px solid #666; margin-right: 15px; display: flex; justify-content: center; align-items: center; border-radius: 50%; flex-shrink: 0;}
        .multi .opt-icon { border-radius: 3px; }
        .selected .opt-icon { background: var(--cam-blue); border-color: var(--cam-blue); }
        .selected .opt-icon::after { content:''; width:8px; height:8px; background:white; border-radius:50%; }
        .multi.selected .opt-icon::after { content:'✔'; background:none; color:white; font-size:14px; font-weight:bold; }

        /* Matrix TEI */
        .matrix-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .matrix-table th, .matrix-table td { border: 1px solid var(--border); padding: 12px; text-align: center; }
        .matrix-table th { background: var(--cam-light-blue); font-size: 1.1rem; }
        .matrix-cb { width: 24px; height: 24px; cursor: pointer; }

        /* Tables */
        .tei-table { border-collapse: collapse; margin: 0 auto 20px; font-size: 1.2rem; background: white; }
        .tei-table td, .tei-table th { border: 2px solid #ccc; padding: 15px 30px; text-align: center; }
        .tei-table th { background: #e6f0fa; }
        
        /* Equation Input & Soft Keypad */
        .eq-input { width: 100%; max-width: 250px; padding: 15px; font-size: 1.5rem; border: 2px solid #666; border-radius: 4px; outline: none; text-align: center; margin: 5px; background: white;}
        .eq-input:focus { border-color: var(--focus); box-shadow: 0 0 5px var(--focus); background: #fffde7; }
        .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-width: 400px; background: #e9ecef; padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .key-btn { padding: 15px; font-size: 1.2rem; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .key-btn:hover { background: #d0d5db; }
        .key-btn.op { background: #cfd8dc; }
        .key-btn.wide { grid-column: span 2; }

        /* Feedback Overlay */
        #feedback-overlay { position: fixed; bottom: 30px; right: 30px; padding: 20px 40px; border-radius: 8px; font-size: 1.3rem; font-weight: bold; color: white; display: none; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .correct-fb { background: #28a745; }
        .wrong-fb { background: #dc3545; }
    </style>
</head>
<body>

<div id="dashboard">
    <div class="sidebar">
        <div class="logo-area">
            <h1>FAST Mathematics</h1>
            <p>Level 5 Procedural Engine</p>
        </div>
        <div class="menu-scroll" id="menu"></div>
    </div>
    <div class="main-dash">
        <h2 style="font-size:2rem; color:var(--cam-blue); margin-bottom:10px;">Florida B.E.S.T. Assessment</h2>
        <p style="max-width: 600px; font-size: 1.2rem; line-height: 1.6; margin-bottom: 40px; color:#555;">
            Welcome to the ultimate unlimited simulator. This engine features procedural word problems, dynamic level 4/5 logic, repaired visual symmetry engines, and an active-focus Cambium soft-keypad.
        </p>
        <button class="mock-btn" onclick="App.startTest()">Launch Mock FAST Test</button>
    </div>
</div>

<div id="test-interface">
    <div class="top-nav">
        <div class="nav-left">
            <strong id="test-title" style="font-size:1.1rem;">Practice</strong>
            <span id="q-counter" style="opacity: 0.8; font-size: 1rem; border-left:1px solid #aaa; padding-left:15px;">Q 1</span>
        </div>
        <div class="nav-right">
            <button class="nav-btn" onclick="App.exitToMenu()">Save & Pause</button>
            <button class="nav-btn primary" id="btn-check" onclick="App.check()" disabled>Submit Answer &rarr;</button>
        </div>
    </div>
    <div class="test-body">
        
        <div class="pane stimulus-pane" id="stimulus-pane"></div>
        
        <div class="pane response-pane">
            <div class="q-text" id="q-text"></div>
            <div id="q-response-area"></div>
            
            <div id="keypad-container" style="display:none; margin-top:20px; padding-top:20px; border-top:2px dashed #ccc;">
                <p style="margin: 0 0 10px 0; font-size: 0.9rem; color: #666;">On-Screen Keypad (Click a box above to type)</p>
                <div class="keypad">
                    <button class="key-btn" onclick="App.typeKey('1')">1</button>
                    <button class="key-btn" onclick="App.typeKey('2')">2</button>
                    <button class="key-btn" onclick="App.typeKey('3')">3</button>
                    <button class="key-btn op" onclick="App.typeKey('+')">+</button>
                    <button class="key-btn" onclick="App.typeKey('4')">4</button>
                    <button class="key-btn" onclick="App.typeKey('5')">5</button>
                    <button class="key-btn" onclick="App.typeKey('6')">6</button>
                    <button class="key-btn op" onclick="App.typeKey('-')">-</button>
                    <button class="key-btn" onclick="App.typeKey('7')">7</button>
                    <button class="key-btn" onclick="App.typeKey('8')">8</button>
                    <button class="key-btn" onclick="App.typeKey('9')">9</button>
                    <button class="key-btn op" onclick="App.typeKey('*')">×</button>
                    <button class="key-btn" onclick="App.typeKey('0')">0</button>
                    <button class="key-btn" onclick="App.typeKey('.')">.</button>
                    <button class="key-btn op" onclick="App.typeKey('/')">/</button>
                    <button class="key-btn op" onclick="App.typeKey('÷')">÷</button>
                    <button class="key-btn op wide" onclick="App.typeKey('BACK')">&larr; Delete</button>
                    <button class="key-btn op wide" onclick="App.typeKey('CLEAR')">Clear Box</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="feedback-overlay"></div>

<script>
// ==========================================
// 1. ENGINE UTILITIES & PROCEDURAL GENERATORS
// ==========================================
const Utils = {
    rInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
    pick: (arr) => arr[Math.floor(Math.random() * arr.length)],
    shuffle: (arr) => arr.sort(() => Math.random() - 0.5),
    
    // Procedural Dictionaries
    name: () => Utils.pick(["Maria", "Leo", "Sam", "Chloe", "Jamal", "Zoe", "David", "Mia"]),
    item: () => Utils.pick(["books", "stickers", "marbles", "cards", "shells", "coins"]),
    container: () => Utils.pick(["boxes", "bags", "packs", "jars"]),

    // Crash-Proof 4-Option Generator
    genOpts: (corr, genFn) => {
        const s = new Set([corr.toString()]);
        let failsafe = 0;
        
        while(s.size < 4 && failsafe < 200) { 
            const val = genFn().toString();
            if(val !== corr.toString()) s.add(val); 
            failsafe++; 
        }
        
        // String vs Number Fallback
        let fallback = 1;
        while(s.size < 4) {
            if(!isNaN(corr)) {
                s.add((Number(corr) + fallback).toString());
            } else {
                s.add(corr.toString() + " (Alt " + fallback + ")"); // Prevents NaN crash
            }
            fallback++;
        }
        return Array.from(s).sort(() => Math.random() - 0.5).map(x => ({t:x, c:x===corr.toString()}));
    },

    numWords: (n) => {
        const o=['','one','two','three','four','five','six','seven','eight','nine'];
        const ty=['','','twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];
        const te=['ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'];
        if(n===0) return 'zero';
        let s='';
        if(n>=1000){s+=o[Math.floor(n/1000)]+' thousand '; n%=1000;}
        if(n>=100){s+=o[Math.floor(n/100)]+' hundred '; n%=100;}
        if(n>=20){s+=ty[Math.floor(n/10)]+(n%10!==0?' ':'')+o[n%10];}
        else if(n>=10){s+=te[n-10];}
        else if(n>0){s+=o[n];}
        return s.trim();
    }
};

// ==========================================
// 2. TEI RENDERER (Cambium Specific)
// ==========================================
const TEI = {
    // Interactive Graphs
    barGraph: (a, b) => {
        const max = Math.max(a,b) + 3; const step = 150/max;
        let s = `<line x1="30" y1="180" x2="170" y2="180" stroke="black" stroke-width="2"/><line x1="30" y1="10" x2="30" y2="180" stroke="black" stroke-width="2"/>`;
        s += `<rect id="barA" x="50" y="180" width="40" height="0" fill="#003366" /><text x="70" y="195" text-anchor="middle" font-weight="bold">A</text>`;
        for(let i=1; i<=max; i++) s += `<g class="bar-zone" onclick="document.getElementById('barA').setAttribute('height', ${i*step}); document.getElementById('barA').setAttribute('y', ${180-i*step}); App.data.a=${i}; App.enableBtn();"><rect x="50" y="${180-i*step}" width="40" height="${step}" fill="transparent" stroke="#ccc" stroke-dasharray="2" /></g>`;
        s += `<rect id="barB" x="110" y="180" width="40" height="0" fill="#ff9900" /><text x="130" y="195" text-anchor="middle" font-weight="bold">B</text>`;
        for(let i=1; i<=max; i++) s += `<g class="bar-zone" onclick="document.getElementById('barB').setAttribute('height', ${i*step}); document.getElementById('barB').setAttribute('y', ${180-i*step}); App.data.b=${i}; App.enableBtn();"><rect x="110" y="${180-i*step}" width="40" height="${step}" fill="transparent" stroke="#ccc" stroke-dasharray="2" /></g>`;
        for(let i=0; i<=max; i+=2) s += `<text x="25" y="${180-i*step + 5}" font-size="10" text-anchor="end">${i}</text>`;
        return `<svg width="250" height="250" viewBox="0 0 200 200">${s}</svg><p style="color:#666;font-size:0.9rem;">(Click grid lines to set bar height)</p>`;
    },

    fracCirc: (n, d) => {
        let p = '';
        for(let i=0; i<d; i++) {
            const s = (i*360)/d, e = ((i+1)*360)/d;
            const x1 = 100 + 90 * Math.sin(Math.PI*s/180), y1 = 100 - 90 * Math.cos(Math.PI*s/180);
            const x2 = 100 + 90 * Math.sin(Math.PI*e/180), y2 = 100 - 90 * Math.cos(Math.PI*e/180);
            p += `<path d="M100 100 L${x1} ${y1} A90 90 0 0 1 ${x2} ${y2} Z" fill="white" stroke="#333" stroke-width="2" class="clk-slice" onclick="this.setAttribute('fill', this.getAttribute('fill')==='white'?'#ff9900':'white'); App.enableBtn();" />`;
        }
        return `<svg width="200" height="200" viewBox="0 0 200 200"><circle cx="100" cy="100" r="90" fill="#fff"/>${p}</svg><p style="color:#666; font-size:0.9rem;">(Click pieces to shade)</p>`;
    },

    dropdown: (parts) => { 
        return parts.map(p => {
            if(p.opts) {
                const options = `<option value="">[ Select ]</option>` + p.opts.map(o => `<option value="${o}">${o}</option>`).join('');
                return `<select class="inline-drop" data-c="${p.c}" onchange="App.enableBtn()">${options}</select>`;
            }
            return `<span>${p.t}</span>`;
        }).join('');
    },

    hotText: (parts) => { 
        return parts.map((p, i) => {
            if(p.hot) return `<span class="hot-text" data-c="${p.c}" onclick="this.classList.toggle('selected'); App.enableBtn();">${p.t}</span>`;
            return `<span>${p.t}</span>`;
        }).join('');
    },

    matrix: (rows, cols, answers) => { 
        let h = `<table class="matrix-table"><tr><th></th>`;
        cols.forEach(c => h += `<th>${c}</th>`); h += `</tr>`;
        rows.forEach((r, rIdx) => {
            h += `<tr><td><strong>${r}</strong></td>`;
            cols.forEach((c, cIdx) => {
                h += `<td><input type="checkbox" class="matrix-cb" data-corr="${answers[rIdx].includes(cIdx)}" onchange="App.enableBtn()"></td>`;
            });
            h += `</tr>`;
        });
        return h + `</table>`;
    },

    // Geometry Visuals (Repaired Symmetry Lines)
    geoShapes: (t, symType) => {
        // symType: 'correct', 'wrong', or null
        const s = 'fill="#e6f0fa" stroke="#003366" stroke-width="3"';
        let line = '';
        if (symType === 'correct') line = `<line x1="50" y1="5" x2="50" y2="95" stroke="red" stroke-width="4" stroke-dasharray="6"/>`;
        if (symType === 'wrong') line = `<line x1="10" y1="20" x2="90" y2="80" stroke="red" stroke-width="4" stroke-dasharray="6"/>`;
        
        if(t==='perp') return `<svg width="100" height="100"><line x1="50" y1="10" x2="50" y2="90" stroke="black" stroke-width="3"/><line x1="10" y1="50" x2="90" y2="50" stroke="black" stroke-width="3"/><rect x="50" y="50" width="10" height="10" fill="none" stroke="black"/></svg>`;
        if(t==='para') return `<svg width="100" height="100"><line x1="30" y1="20" x2="30" y2="80" stroke="black" stroke-width="3"/><line x1="70" y1="20" x2="70" y2="80" stroke="black" stroke-width="3"/></svg>`;
        if(t==='trap') return `<svg width="100" height="100"><path d="M20 80 L80 80 L60 30 L40 30 Z" ${s}/>${line}</svg>`;
        if(t==='rect') return `<svg width="100" height="100"><rect x="10" y="30" width="80" height="40" ${s}/>${line}</svg>`;
        if(t==='tri') return `<svg width="100" height="100"><path d="M10 80 L90 80 L50 20 Z" ${s}/>${line}</svg>`;
        return `<svg width="100" height="100"><rect x="20" y="20" width="60" height="60" ${s}/>${line}</svg>`;
    },

    // Area Models
    areaModel: (h, w1, w2) => `<svg width="${(w1+w2)*20+40}" height="${h*20+40}"><rect x="20" y="20" width="${w1*20}" height="${h*20}" fill="#b2dfdb" stroke="#003366" stroke-width="2"/><text x="${20+(w1*20)/2}" y="${20+(h*20)/2+5}" text-anchor="middle" font-weight="bold">${h}x${w1}</text><rect x="${20+w1*20}" y="20" width="${w2*20}" height="${h*20}" fill="#ffe0b2" stroke="#ff9900" stroke-width="2"/><text x="${20+w1*20+(w2*20)/2}" y="${20+(h*20)/2+5}" text-anchor="middle" font-weight="bold">${h}x${w2}</text></svg>`,
    lShape: (w1,h1,w2,h2) => { const sc=25; return `<svg width="${(w1+w2)*sc+40}" height="${(h1+h2)*sc+40}"><path d="M20 20 H${20+w1*sc} V${20+h1*sc} H${20+(w1+w2)*sc} V${20+(h1+h2)*sc} H20 Z" fill="#e6f0fa" stroke="#003366" stroke-width="3"/><text x="${20+w1*sc/2}" y="15" text-anchor="middle" font-weight="bold">${w1}</text><text x="10" y="${20+(h1+h2)*sc/2}" text-anchor="middle" font-weight="bold">${h1+h2}</text><text x="${20+w1*sc+w2*sc/2}" y="${20+h1*sc-5}" text-anchor="middle" font-weight="bold">${w2}</text><text x="${20+(w1+w2)*sc+10}" y="${20+h1*sc+h2*sc/2}" text-anchor="middle" font-weight="bold">${h2}</text></svg>`; },
    rulerQuarter: (len) => { let t=''; for(let i=0;i<=5;i++){ t+=`<line x1="${20+i*40}" y1="30" x2="${20+i*40}" y2="60" stroke="black" stroke-width="2"/>`; if(i<5) t+=`<line x1="${40+i*40}" y1="35" x2="${40+i*40}" y2="60" stroke="black"/><line x1="${30+i*40}" y1="45" x2="${30+i*40}" y2="60" stroke="black"/><line x1="${50+i*40}" y1="45" x2="${50+i*40}" y2="60" stroke="black"/>`; t+=`<text x="${20+i*40}" y="25" text-anchor="middle" font-weight="bold">${i}</text>`; } return `<svg width="250" height="90"><rect x="20" y="60" width="200" height="20" fill="#f4f4f4" stroke="black"/><rect x="20" y="65" width="${len*40}" height="10" fill="#ff9900" stroke="black"/>${t}</svg>`; },
    clock: (h,m) => { let t=''; for(let i=0;i<60;i++) t+=`<line x1="50" y1="6" x2="50" y2="${i%5?7:10}" transform="rotate(${i*6} 50 50)" stroke="#333" stroke-width="${i%5?1:2}"/>`; return `<svg width="150" height="150" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" stroke="#333" fill="#fff" stroke-width="2"/>${t}<line x1="50" y1="50" x2="50" y2="28" stroke="black" stroke-width="4" stroke-linecap="round" transform="rotate(${(h%12)*30+m*0.5} 50 50)"/><line x1="50" y1="50" x2="50" y2="15" stroke="#cc0000" stroke-width="2" stroke-linecap="round" transform="rotate(${m*6} 50 50)"/><circle cx="50" cy="50" r="4"/></svg>`; }
};

// ==========================================
// 3. MASTER QUESTION BANK (Procedural & Infinite)
// ==========================================
const Bank = {
    // --- NSO ---
    "MA.3.NSO.1.1": { desc: "Read/Write/Expanded", scenarios: [
        { type: 'drop', gen: () => { const n=Utils.rInt(2000,9000); const h=Math.floor((n%1000)/100); return { text:"<b>Level 5 Error Analysis:</b> A student expanded the number incorrectly. Fix the error.", right: TEI.dropdown([{t:`${n} = ${Math.floor(n/1000)*1000} + `}, {opts:[h, h*10, h*100], c:h*100}, {t:` + ${n%100}`}]), fb:`The digit ${h} is in the hundreds place, meaning ${h*100}.` }; }},
        { type: 'radio', gen: () => { const n=Utils.rInt(1000,9999); return { text: `Select the correct word form for the number ${n}.`, options: Utils.genOpts(Utils.numWords(n), ()=>Utils.numWords(Utils.rInt(1000,9999))), fb:"Read the thousands, hundreds, tens, and ones."}; }}
    ]},
    "MA.3.NSO.1.2": { desc: "Compose/Decompose", scenarios: [
        { type: 'eq', gen: () => { const h=Utils.rInt(12, 25), t=Utils.rInt(15, 45); return { text: `<b>Level 5 Rigor (Regrouping):</b><br>What number is formed by combining ${h} hundreds, ${t} tens, and 5 ones?`, ans: (h*100+t*10+5).toString(), fb:`Multiply hundreds by 100, tens by 10, then add: ${h*100} + ${t*10} + 5.`}; }}
    ]},
    "MA.3.NSO.1.3": { desc: "Compare", scenarios: [
        { type: 'hot', gen: () => { const a=Utils.rInt(1000,4000), b=a+Utils.rInt(10,50); return { text: `Select the correct symbol to compare the numbers:`, right: `${a} ` + TEI.hotText([{t:" > ",hot:true,c:false},{t:" < ",hot:true,c:true},{t:" = ",hot:true,c:false}]) + ` ${b}`, fb:`${a} is less than ${b}.`}; }}
    ]},
    "MA.3.NSO.1.4": { desc: "Rounding", scenarios: [
        { type: 'multi', gen: () => { const t=Utils.rInt(2,8)*100; return { text: `Select <strong>ALL</strong> numbers that round to ${t} when rounded to the nearest 100.`, options: Utils.shuffle([{t:(t-10).toString(),c:true},{t:(t+40).toString(),c:true},{t:(t+60).toString(),c:false},{t:(t-60).toString(),c:false}]), fb:`Any number from ${t-50} to ${t+49} rounds to ${t}.`}; }}
    ]},
    "MA.3.NSO.2.1": { desc: "Add/Sub Multi-Digit", scenarios: [
        { type: 'eq', gen: () => { const a=Utils.rInt(2000,5000), b=Utils.rInt(1000,1999); return { text: `Find the exact difference:<br><br>${a} - ${b} = [ ? ]`, ans: (a-b).toString(), fb:"Use the standard algorithm and regroup carefully."}; }},
        { type: 'drop', gen: () => { const a=Utils.rInt(1000,4000), b=Utils.rInt(1000,4000); return { text: `<b>Level 5 Error Analysis:</b><br>A student added ${a} + ${b} and got ${(a+b)-100}. What mistake did they make?`, right: TEI.dropdown([{t:"They forgot to regroup the "}, {opts:["ones", "tens", "hundreds", "thousands"], c:"hundreds"}, {t:" place."}]), fb:"The error is exactly 100 off, meaning a hundreds regroup was missed."}; }}
    ]},
    "MA.3.NSO.2.2": { desc: "Mult/Div Facts", scenarios: [
        { type: 'eq', gen: () => { const a=Utils.rInt(7,12), b=Utils.rInt(7,12); return { text: `Solve the multiplication fact:<br><br>${a} x ${b} = [ ? ]`, ans: (a*b).toString(), fb:"Recall your math facts from 0-12."}; }}
    ]},
    "MA.3.NSO.2.3": { desc: "Mult by 10s", scenarios: [
        { type: 'eq', gen: () => { const a=Utils.rInt(4,9), b=Utils.pick([20,30,40,50,60,70,80]); return { text: `Solve:<br><br>${a} x ${b} = [ ? ]`, ans: (a*b).toString(), fb:`Multiply ${a} x ${b/10}, then attach the zero.`}; }}
    ]},
    "MA.3.NSO.2.4": { desc: "Mult 1dx2d", scenarios: [
        { type: 'eq', gen: () => { const a=Utils.rInt(3,8), b=Utils.rInt(13,25), n=Utils.name(), itm=Utils.item(); return { text: `${n} has ${b} bags. Each bag contains exactly ${a} ${itm}. How many ${itm} does ${n} have in total?`, ans:(a*b).toString(), fb:`Multiply ${b} x ${a} using the standard algorithm.`}; }}
    ]},

    // --- ALGEBRA (AR) ---
    "MA.3.AR.1.1": { desc: "Distributive Prop", scenarios: [
        { type: 'radio', gen: () => { const a=Utils.rInt(4,9), b=Utils.rInt(12,18); return { left: TEI.areaModel(a,10,b-10), text: `Which expression represents the Area Model shown?`, options: Utils.shuffle([{t:`(${a}x10) + (${a}x${b-10})`,c:true},{t:`${a} + 10 + ${b-10}`,c:false},{t:`(${a}x10) x (${a}x${b-10})`,c:false},{t:`${a} x 100`,c:false}]), fb:"The distributive property adds the two sub-areas together." }; }}
    ]},
    "MA.3.AR.1.2": { desc: "Multi-Step Probs", scenarios: [
        { type: 'eq', gen: () => { const a=Utils.rInt(3,6), b=Utils.rInt(4,8), c=Utils.rInt(2,10), n=Utils.name(), itm=Utils.item(); return { text: `<b>Level 5 Multi-Step:</b><br>${n} buys ${a} packs of ${itm}. Each pack has ${b} ${itm}. ${n} then gives ${c} ${itm} to a friend. How many ${itm} are left?`, ans: ((a*b)-c).toString(), fb:`Step 1: ${a} x ${b}. Step 2: Subtract ${c}.`}; }}
    ]},
    "MA.3.AR.2.1": { desc: "Inverse Ops", scenarios: [
        { type: 'hot', gen: () => { const a=Utils.rInt(6,9), p=a*Utils.rInt(6,9); return { text: `Select the related equation that can be used to solve <strong>${p} ÷ ${a} = ?</strong>`, right: TEI.hotText([{t:`${a} x ? = ${p}`,hot:true,c:true},{t:" / "},{t:`${p} - ${a} = ?`,hot:true,c:false},{t:" / "},{t:`${a} + ? = ${p}`,hot:true,c:false}]), fb:"Multiplication and division are inverse (opposite) operations."}; }}
    ]},
    "MA.3.AR.2.2": { desc: "Equality", scenarios: [
        { type: 'drop', gen: () => { const a=Utils.rInt(4,8), b=Utils.rInt(4,8); return { text:"Make the equation true.", right: TEI.dropdown([{t:`${a} x ${b} = `},{opts:[a*b, a+b, a*b+10],c:a*b},{t:` + 0`}]), fb:`Both sides must evaluate to ${a*b}.`}; }}
    ]},
    "MA.3.AR.2.3": { desc: "Missing Factor", scenarios: [
        { type: 'eq', gen: () => { const a=Utils.rInt(6,9), p=a*Utils.rInt(4,9); return { text: `Find the missing factor in the equation:<br><br>${a} x [ ? ] = ${p}`, ans: (p/a).toString(), fb:`Divide the product (${p}) by the known factor (${a}).`}; }}
    ]},
    "MA.3.AR.3.1": { desc: "Even/Odd", scenarios: [
        { type: 'radio', gen: () => { const n=Utils.rInt(10,99); return { text:`Is the number ${n} Even or Odd?`, options:[{t:"Even",c:n%2===0},{t:"Odd",c:n%2!==0},{t:"Both",c:false},{t:"Neither",c:false}], fb:"Look at the digit in the ones place." }; }}
    ]},
    "MA.3.AR.3.2": { desc: "Multiples", scenarios: [
        { type: 'multi', gen: () => { const base = Utils.pick([3,4,6]); return { text: `Select ALL numbers that are multiples of ${base}.`, options: Utils.shuffle([{t:(base*2).toString(),c:true},{t:(base*5).toString(),c:true},{t:(base*2+1).toString(),c:false},{t:(base*3-1).toString(),c:false}]), fb:`Skip count by ${base}s.`}; }}
    ]},
    "MA.3.AR.3.3": { desc: "Patterns", scenarios: [
        { type: 'table', gen: () => { const r=Utils.pick([4,5]), n=Utils.name(), itm=Utils.item(); return { text:`${n} collects ${r} ${itm} every day. Complete the table to show the pattern.`, inputs:[1, 2, 3], outputs:[r, r*2, '?'], missing:2, ans:(r*3).toString(), fb:`The rule is multiply the day by ${r}.`}; }}
    ]},

    // --- FRACTIONS (FR) ---
    "MA.3.FR.1.1": { desc: "Visual Fractions", scenarios: [
        { type: 'interact', gen: () => { const d=Utils.pick([4,6,8]), n=Utils.rInt(1,d-1); return { left: TEI.fracCirc(n,d), text:`Shade the visual model to represent <strong>${n}/${d}</strong>.`, check: ()=>document.querySelectorAll('path[fill="#ff9900"]').length===n, fb:`You must click and shade exactly ${n} out of the ${d} slices.`}; }}
    ]},
    "MA.3.FR.1.2": { desc: "Unit/Whole", scenarios: [
        { type: 'radio', gen: () => { return { text: "Which fraction is equivalent to exactly 1 whole?", options: Utils.shuffle([{t:"4/4",c:true},{t:"4/1",c:false},{t:"1/4",c:false},{t:"3/4",c:false}]), fb:"When the numerator and denominator are the same, it equals 1 whole."}; }}
    ]},
    "MA.3.FR.1.3": { desc: "Word Form", scenarios: [
        { type: 'hot', gen: () => { return { text: "Select the numerical fraction for <strong>'Five-Eighths'</strong>.", right: TEI.hotText([{t:"8/5",hot:true,c:false},{t:", "},{t:"5/8",hot:true,c:true},{t:", "},{t:"1/8",hot:true,c:false}]), fb:"The numerator is 5, the denominator is 8."}; }}
    ]},
    "MA.3.FR.2.1": { desc: "Compare", scenarios: [
        { type: 'radio', gen: () => { const d1=Utils.pick([3,4]), d2=Utils.pick([6,8]); return { text: `Compare the fractions: 1/${d1} and 1/${d2}.`, options: Utils.shuffle([{t:`1/${d1} > 1/${d2}`,c:true},{t:`1/${d1} < 1/${d2}`,c:false},{t:`1/${d1} = 1/${d2}`,c:false},{t:`1/${d2} > 1/${d1}`,c:false}]), fb:"A smaller denominator means the whole is cut into fewer, larger pieces."}; }}
    ]},
    "MA.3.FR.2.2": { desc: "Equivalence", scenarios: [
        { type: 'matrix', gen: () => { return { text: "Classify each fraction in the grid.", right: TEI.matrix(["2/4", "3/4", "4/8"], ["Equal to 1/2", "NOT Equal to 1/2"], [[0],[1],[0]]), fb:"If the top number is exactly half of the bottom number, it equals 1/2."}; }}
    ]},

    // --- GEOMETRY (GR) ---
    "MA.3.GR.1.1": { desc: "Points/Lines", scenarios: [
        { type: 'radio', gen: () => { return { text: "Which image shows <strong>Perpendicular Lines</strong>?", options: Utils.shuffle([{t:TEI.geoShapes('perp', null),c:true},{t:TEI.geoShapes('para', null),c:false},{t:TEI.geoShapes('trap', null),c:false},{t:TEI.geoShapes('tri', null),c:false}]), fb:"Perpendicular lines form a 90-degree square corner."}; }}
    ]},
    "MA.3.GR.1.2": { desc: "Attributes", scenarios: [
        { type: 'matrix', gen: () => { return { text: "Match the shapes to their mathematical attributes.", right: TEI.matrix(["Square", "Trapezoid"], ["4 Right Angles", "Parallel Sides"], [[0,1],[1]]), fb:"Squares have both right angles and parallel sides. Trapezoids only have parallel sides."}; }}
    ]},
    "MA.3.GR.1.3": { desc: "Symmetry", scenarios: [
        { type: 'radio', gen: () => { return { text: "Which figure shows a correctly drawn <strong>line of symmetry</strong> (the red dashed line)?", options: Utils.shuffle([{t:TEI.geoShapes('rect','correct'),c:true},{t:TEI.geoShapes('trap','wrong'),c:false},{t:TEI.geoShapes('para','wrong'),c:false},{t:TEI.geoShapes('tri','wrong'),c:false}]), fb:"The line must divide the shape into two perfect mirror images."}; }}
    ]},
    "MA.3.GR.2.1": { desc: "Area", scenarios: [
        { type: 'eq', gen: () => { const w=Utils.rInt(4,7), h=Utils.rInt(3,5); return { left: TEI.tiled(w,h), text: "Find the Area of the tiled rectangle.", ans:(w*h).toString(), fb:"Count all the squares, or multiply the length by the width."}; }}
    ]},
    "MA.3.GR.2.2": { desc: "Distributive Area", scenarios: [
        { type: 'radio', gen: () => { const a=Utils.rInt(4,8), b=Utils.rInt(12,15); return { text: `Which expression shows the area of a ${a}x${b} rectangle broken apart using the distributive property?`, options: Utils.shuffle([{t:`(${a}x10) + (${a}x${b-10})`,c:true},{t:`${a}+10+${b-10}`,c:false},{t:`(${a}x10) x (${a}x${b-10})`,c:false},{t:`${a}x10`,c:false}]), fb:`Decompose the larger number (${b}) into 10 and ${b-10}.`}; }}
    ]},
    "MA.3.GR.2.3": { desc: "Perimeter", scenarios: [
        { type: 'eq', gen: () => { const w=Utils.rInt(3,7), l=Utils.rInt(5,9), p=2*w+2*l; return { text: `<b>Level 5 Rigor:</b> The perimeter of a rectangle is ${p}. The width is ${w}. What is the length?`, ans:l.toString(), fb:`Subtract 2 widths (${w*2}) from ${p}, then divide the remainder by 2.`}; }}
    ]},
    "MA.3.GR.2.4": { desc: "Composite Area", scenarios: [
        { type: 'eq', gen: () => { const w1=Utils.rInt(3,6), h1=Utils.rInt(4,8), w2=Utils.rInt(2,5), h2=Utils.rInt(2,4); return { left: TEI.lShape(w1,h1,w2,h2), text: "<b>Level 5 Rigor:</b> Find the Total Area of this composite figure.", ans:((w1*(h1+h2))+(w2*h2)).toString(), fb:"Decompose the figure into two non-overlapping rectangles and add their areas."}; }}
    ]},

    // --- MEASUREMENT (M) ---
    "MA.3.M.1.1": { desc: "Tools & Measure", scenarios: [
        { type: 'radio', gen: () => { const l=Utils.pick([2.25, 3.5, 4.75]); return { left: TEI.rulerQuarter(l), text: "To the nearest quarter inch, what is the length of the orange bar?", options: Utils.shuffle([{t:`${l} in`,c:true},{t:`${l+0.25} in`,c:false},{t:`${Math.floor(l)} in`,c:false},{t:`${l-0.25} in`,c:false}]), fb:"Count the tick marks carefully past the whole number."}; }}
    ]},
    "MA.3.M.1.2": { desc: "Mass/Vol", scenarios: [
        { type: 'eq', gen: () => { const w=Utils.rInt(6,12), c=Utils.rInt(3,7), n=Utils.name(); return { text: `${n} has ${c} jugs of water. Each jug holds exactly ${w} Liters. How many Liters does ${n} have in total?`, ans:(w*c).toString(), fb:`Multiply ${w} by ${c}.`}; }}
    ]},
    "MA.3.M.2.1": { desc: "Time", scenarios: [
        { type: 'radio', gen: () => { const h=Utils.rInt(1,11), m=Utils.pick([15,30,45]); return { left: TEI.clock(h,m), text: "What time is shown on the analog clock?", options: Utils.shuffle([{t:`${h}:${m}`,c:true},{t:`${h+1}:${m}`,c:false},{t:`${h}:${m===15?45:15}`,c:false},{t:`${h===1?12:h-1}:${m}`,c:false}]), fb:"The short hand points to the hour, the long red hand points to the minutes."}; }}
    ]},
    "MA.3.M.2.2": { desc: "Elapsed Time", scenarios: [
        { type: 'eq', gen: () => { const s=Utils.rInt(1,5), e=Utils.pick([15,25,35,45]); return { text: `<b>Level 5 Rigor:</b> A movie ended at ${s}:${e} PM. It was exactly ${e} minutes long. What time did the movie start?`, ans:s.toString() + "00", fb:`Work backwards from the end time.`}; }}
    ]},

    // --- DATA (DP) ---
    "MA.3.DP.1.1": { desc: "Graphing", scenarios: [
        { type: 'interact', gen: () => { const a=Utils.rInt(4,8), diff=Utils.rInt(1,3); return { left: TEI.barGraph(a, a-diff), text: `<b>Level 5 Multi-Step:</b> Class A has ${a} students. Class B has ${diff} FEWER students than Class A. Click the grid to build a bar graph representing both classes.`, check:()=>App.data.a===a && App.data.b===(a-diff), fb:`Solve for B first: ${a} - ${diff} = ${a-diff}. Then click the grid to set the heights.`}; }}
    ]},
    "MA.3.DP.1.2": { desc: "Interpret", scenarios: [
        { type: 'eq', gen: () => { const k=Utils.pick([2,5,10]), count=Utils.rInt(3,8); return { text: `A pictograph key states that 1 Circle = ${k} students. If Class A has ${count} circles, how many students are in Class A?`, ans:(k*count).toString(), fb:`Multiply the number of circles (${count}) by the key value (${k}).`}; }}
    ]}
};

// ==========================================
// 4. APP CONTROLLER & KEYPAD LOGIC
// ==========================================
const App = {
    currStd: null, currQ: null, score: 0, mode: 'practice', qCount: 1,
    history: {}, data: {}, activeInput: null, // Tracks which box is clicked

    init: function() {
        const m = document.getElementById('menu');
        const order = ["MA.3.NSO", "MA.3.AR", "MA.3.FR", "MA.3.GR", "MA.3.M", "MA.3.DP"];
        order.forEach(prefix => {
            const h = document.createElement('div'); h.className = 'cat-title'; h.innerText = prefix; m.appendChild(h);
            Object.keys(Bank).filter(k => k.startsWith(prefix)).forEach(id => {
                const b = document.createElement('div'); b.className = 'std-btn';
                b.innerHTML = `<strong>${id}</strong><br><small>${Bank[id].desc}</small>`;
                b.onclick = () => { document.querySelectorAll('.std-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); App.startPractice(id); };
                m.appendChild(b);
            });
        });
    },

    startPractice: function(id) {
        this.mode = 'practice';
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('test-interface').style.display = 'flex';
        this.load(id);
    },

    startTest: function() {
        this.mode = 'test'; this.score = 0; this.qCount = 1;
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('test-interface').style.display = 'flex';
        document.querySelectorAll('.std-btn').forEach(x=>x.classList.remove('active'));
        this.nextTestQ();
    },

    exitToMenu: function() {
        document.getElementById('test-interface').style.display = 'none';
        document.getElementById('dashboard').style.display = 'flex';
    },

    nextTestQ: function() {
        const r = Math.random();
        let p = "MA.3.NSO"; if(r>0.25) p="MA.3.AR"; if(r>0.50) p="MA.3.FR"; if(r>0.75) p=Utils.pick(["MA.3.GR", "MA.3.M", "MA.3.DP"]);
        this.load(Utils.pick(Object.keys(Bank).filter(k => k.startsWith(p))), true);
    },

    load: function(id, isTest=false) {
        this.currStd = id; this.data = {}; this.activeInput = null;
        document.getElementById('test-title').innerText = isTest ? `FAST Mock Test` : `Practice: ${id}`;
        document.getElementById('q-counter').innerText = isTest ? `Q ${this.qCount}` : ``;
        
        // Procedural Rotation Logic (Never crashes, never ends)
        const count = Bank[id].scenarios.length;
        if (!this.history[id] || this.history[id].length >= count) this.history[id] = []; 
        let next; do { next = Math.floor(Math.random() * count); } while (this.history[id].includes(next) && count > 1);
        this.history[id].push(next);

        // Generate Question Data Dynamically
        const q = Bank[id].scenarios[next].gen();
        this.currQ = q; this.currQ.type = Bank[id].scenarios[next].type;

        // Reset UI Panels
        const stim = document.getElementById('stimulus-pane');
        const resp = document.getElementById('q-response-area');
        const kp = document.getElementById('keypad-container');
        stim.innerHTML = ''; resp.innerHTML = ''; kp.style.display = 'none';
        
        if(q.left) { stim.innerHTML = q.left; stim.style.display = 'flex'; } 
        else { stim.style.display = 'none'; }

        document.getElementById('q-text').innerHTML = q.text;

        // Render Question Types
        if(q.type === 'radio' || q.type === 'multi') {
            const list = document.createElement('div'); 
            list.className = q.options[0].t.includes('<svg') ? 'opt-list grid' : 'opt-list';
            
            q.options.forEach((o,i) => {
                const el = document.createElement('div'); el.className = `opt-item ${q.type}`;
                el.innerHTML = `<div class="opt-icon"></div> <div>${o.t}</div>`;
                el.onclick = () => {
                    if(q.type === 'radio') {
                        list.querySelectorAll('.opt-item').forEach(b => b.classList.remove('selected'));
                        el.classList.add('selected'); App.sel = i;
                    } else {
                        el.classList.toggle('selected'); o.sel = !o.sel;
                    }
                    App.enableBtn();
                };
                list.appendChild(el);
            });
            resp.appendChild(list);
        } 
        else if (q.type === 'eq') {
            resp.innerHTML = `<input type="text" id="inp_eq" class="eq-input" placeholder="Type answer here..." onclick="App.activeInput='inp_eq'" onkeyup="App.enableBtn()">`;
            this.activeInput = 'inp_eq'; // Set default focus
            kp.style.display = 'block'; 
        } 
        else if (q.type === 'table') {
            let h = `<table class="tei-table"><tr><th>Input</th><th>Output</th></tr>`;
            q.inputs.forEach((val, i) => { 
                h += `<tr><td>${val}</td><td>${i === q.missing ? `<input id="inp_tbl" class="eq-input" style="padding:5px; font-size:1.2rem; width:100px;" type="text" onclick="App.activeInput='inp_tbl'" onkeyup="App.enableBtn()">` : q.outputs[i]}</td></tr>`; 
            });
            resp.innerHTML = h + `</table>`;
            this.activeInput = 'inp_tbl';
            kp.style.display = 'block';
        }
        else if (q.type === 'interact' || q.type === 'drop' || q.type === 'hot' || q.type === 'matrix') {
            resp.innerHTML = q.right || '';
            if(q.type === 'matrix') { document.querySelectorAll('.matrix-cb').forEach(cb => { cb.onchange = () => App.enableBtn(); }); }
        }

        const btn = document.getElementById('btn-check');
        btn.innerText = "Submit Answer \u2192"; btn.disabled = true;
    },

    typeKey: function(k) {
        if(!this.activeInput) return;
        const inp = document.getElementById(this.activeInput);
        if(k === 'CLEAR') inp.value = '';
        else if(k === 'BACK') inp.value = inp.value.slice(0,-1);
        else inp.value += k;
        App.enableBtn();
    },

    enableBtn: function() { document.getElementById('btn-check').disabled = false; },

    check: function() {
        let ok = false; const q = this.currQ;
        
        if(q.type === 'radio') ok = q.options[App.sel] && q.options[App.sel].c;
        if(q.type === 'multi') ok = q.options.every(o => !!o.sel === o.c);
        if(q.type === 'eq') ok = document.getElementById('inp_eq').value.trim() === q.ans;
        if(q.type === 'table') ok = document.getElementById('inp_tbl').value.trim() === q.ans;
        if(q.type === 'interact') ok = q.check();
        
        if(q.type === 'hot') {
            const spans = document.querySelectorAll('.hot-text'); ok = true;
            spans.forEach(s => { if(s.classList.contains('selected') !== (s.dataset.c === "true")) ok = false; });
        }
        if(q.type === 'drop') {
            const sels = document.querySelectorAll('.inline-drop'); ok = true;
            sels.forEach(s => { if(s.value !== s.dataset.c) ok = false; });
        }
        if(q.type === 'matrix') {
            const cbs = document.querySelectorAll('.matrix-cb'); ok = true;
            cbs.forEach(cb => { if(cb.checked !== (cb.dataset.corr === "true")) ok = false; });
        }

        const fb = document.getElementById('feedback-overlay');
        fb.className = ok ? 'correct-fb' : 'wrong-fb';
        fb.innerText = ok ? "Correct!" : "Incorrect.";
        fb.style.display = 'block';
        setTimeout(() => { fb.style.display = 'none'; }, 1500);

        if(ok) { this.score++; document.getElementById('score').innerText = `Score: ${this.score}`; }
        this.qCount++;

        setTimeout(() => {
            if(this.mode === 'test') this.nextTestQ();
            else this.load(this.currStd);
        }, 1500);
    }
};

App.init();
</script>
</body>
</html>
