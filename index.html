<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAST Gr3 Acc | Gold Master Simulator</title>
    <style>
        :root {
            --primary: #004d40;
            --accent: #e65100;
            --bg: #f4f6f8;
            --text: #263238;
            --border: #cfd8dc;
            --white: #ffffff;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 350px; background: var(--white); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; height: 100vh; }
        .logo-area { padding: 20px; background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        .logo-area h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
        .logo-area p { margin: 5px 0 0; font-size: 0.8rem; opacity: 0.8; }
        
        .sim-btn {
            margin: 15px; padding: 15px; background: var(--accent); color: white; text-align: center;
            border-radius: 6px; font-weight: bold; cursor: pointer; border: 2px solid #ef6c00;
            transition: transform 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .sim-btn:hover { transform: translateY(-2px); }

        .menu-scroll { flex: 1; overflow-y: auto; padding: 0 15px 20px; }
        .menu-cat { 
            font-size: 0.75rem; text-transform: uppercase; color: #78909c; font-weight: 800; 
            margin: 25px 0 5px; border-bottom: 2px solid #eee; padding-bottom: 5px;
        }
        .std-btn { 
            display: block; width: 100%; text-align: left; padding: 10px 12px; margin-bottom: 4px; 
            background: #fff; border: 1px solid #eee; border-radius: 4px; cursor: pointer; transition: 0.1s;
            font-size: 0.85rem;
        }
        .std-btn:hover { background: #e0f2f1; border-color: var(--primary); }
        .std-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .std-btn small { display: block; font-size: 0.7rem; margin-top: 3px; opacity: 0.7; }

        /* MAIN */
        .main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 30px; }
        .q-container { 
            background: white; padding: 40px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); max-width: 950px; margin: 0 auto; width: 100%; 
            border-top: 6px solid var(--primary);
        }
        .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        .badge { background: #eceff1; color: #455a64; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; }
        
        .q-text { font-size: 1.3rem; line-height: 1.6; margin-bottom: 30px; color: #263238; }
        .visual-stage { background: #fafafa; border: 2px dashed #cfd8dc; border-radius: 8px; padding: 30px; margin-bottom: 30px; display: flex; justify-content: center; align-items: center; }

        /* INPUTS */
        .options-list { display: grid; gap: 12px; }
        .opt-btn { 
            display: flex; align-items: center; padding: 18px; border: 2px solid #e0e0e0; border-radius: 8px; 
            background: white; cursor: pointer; font-size: 1.1rem; transition: 0.2s;
        }
        .opt-btn:hover { border-color: #b0bec5; background: #f5f5f5; }
        .opt-btn.selected { border-color: var(--primary); background: #e0f2f1; box-shadow: inset 0 0 0 1px var(--primary); }
        
        .icon { width: 22px; height: 22px; border: 2px solid #546e7a; margin-right: 15px; display: flex; justify-content: center; align-items: center; }
        .radio .icon { border-radius: 50%; }
        .check .icon { border-radius: 4px; }
        .selected .radio .icon { border-color: var(--primary); background: var(--primary); }
        .selected .check .icon { border-color: var(--primary); background: var(--primary); }
        .selected .radio .icon::after { content:''; width: 10px; height: 10px; background: white; border-radius: 50%; }
        .selected .check .icon::after { content:'âœ”'; color: white; font-size: 14px; font-weight: bold; }

        .eq-input { width: 100%; padding: 15px; font-size: 1.4rem; border: 2px solid #455a64; border-radius: 6px; }
        
        .tei-table { border-collapse: collapse; margin: 0 auto; }
        .tei-table td, .tei-table th { border: 1px solid #555; padding: 10px 20px; text-align: center; font-size: 1.1rem; }
        .tei-table input { width: 100px; padding: 5px; font-size: 1.1rem; text-align: center; border: 2px solid #000; }

        .feedback { margin-top: 25px; padding: 20px; border-radius: 8px; display: none; }
        .feedback.correct { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
        .feedback.wrong { background: #ffebee; color: #b71c1c; border: 1px solid #ffcdd2; }

        .btn-action { margin-top: 25px; padding: 12px 30px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 1rem; font-weight: bold; cursor: pointer; float: right; }
        .btn-action:disabled { background: #b0bec5; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-area">
            <h1>FAST Grade 3 Acc.</h1>
            <p>Gold Master Build v5.0</p>
        </div>
        <div class="sim-btn" onclick="App.startSim()">ðŸš€ Start Full Test Sim</div>
        <div class="menu-scroll" id="menu"></div>
    </div>

    <div class="main">
        <div class="q-container">
            <div class="q-header">
                <span class="badge" id="q-badge">Select a Standard</span>
                <span style="color:#78909c; font-weight:600;" id="score-display">Score: 0</span>
            </div>
            <div class="q-text" id="q-prompt">
                <strong>Welcome to the Master Simulator.</strong><br>
                Includes Multi-Mode generators for every standard to prevent repetition.<br>
                Click a standard to begin.
            </div>
            <div class="visual-stage" id="q-visual" style="display:none;"></div>
            <div class="options-list" id="q-options"></div>
            <div class="feedback" id="q-feedback"></div>
            <button class="btn-action" id="btn-action" onclick="App.check()" disabled>Check Answer</button>
        </div>
    </div>

    <script>
        // --- 1. CORE UTILITIES ---
        const Utils = {
            rInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
            pick: (arr) => arr[Math.floor(Math.random() * arr.length)],
            shuffle: (arr) => arr.sort(() => Math.random() - 0.5),

            // Ensure 4 unique options for MCQs
            genOptions: (correct, genFunc) => {
                const opts = new Set();
                opts.add(correct);
                let safe = 0;
                while(opts.size < 4 && safe < 50) {
                    const val = genFunc();
                    if(val !== correct) opts.add(val);
                    safe++;
                }
                return Array.from(opts).sort(() => Math.random() - 0.5);
            },

            numToWords: (n) => {
                const ones = ['','one','two','three','four','five','six','seven','eight','nine'];
                const tens = ['','','twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];
                const teens = ['ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'];
                if(n===0) return 'zero';
                let str = '';
                if(n>=1000){str+=ones[Math.floor(n/1000)]+' thousand '; n%=1000;}
                if(n>=100){str+=ones[Math.floor(n/100)]+' hundred '; n%=100;}
                if(n>=20){str+=tens[Math.floor(n/10)]+(n%10!==0?' ':'')+ones[n%10];}
                else if(n>=10){str+=teens[n-10];}
                else if(n>0){str+=ones[n];}
                return str.trim();
            },

            // --- SVG ENGINE ---
            svg: {
                clock: (h, m) => {
                    const hDeg = (h%12)*30 + m*0.5, mDeg = m*6;
                    let ticks = Array.from({length:60},(_,i)=>`<line x1="50" y1="6" x2="50" y2="${i%5?7:10}" transform="rotate(${i*6} 50 50)" stroke="#333" stroke-width="${i%5?1:2}"/>`).join('');
                    return `<svg width="150" height="150" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" stroke="#333" stroke-width="2" fill="white"/>${ticks}<line x1="50" y1="50" x2="50" y2="28" stroke="black" stroke-width="3" transform="rotate(${hDeg} 50 50)"/><line x1="50" y1="50" x2="50" y2="15" stroke="red" stroke-width="2" transform="rotate(${mDeg} 50 50)"/><circle cx="50" cy="50" r="3" fill="#333"/></svg>`;
                },
                rect: (w, h) => `<svg width="200" height="120" viewBox="0 0 200 120"><rect x="20" y="10" width="${w*15}" height="${h*15}" fill="#e0f2f1" stroke="#004d40" stroke-width="2"/><text x="${20+w*7.5}" y="95" text-anchor="middle">${w} ft</text><text x="10" y="${10+h*7.5}" text-anchor="middle">${h} ft</text></svg>`,
                tiledRect: (w, h) => {
                    let s = ''; 
                    for(let i=0;i<w;i++) for(let j=0;j<h;j++) s+=`<rect x="${20+i*20}" y="${20+j*20}" width="20" height="20" fill="#e0f2f1" stroke="#004d40" stroke-width="1"/>`;
                    return `<svg width="${w*20+40}" height="${h*20+40}">${s}</svg>`;
                },
                fraction: (n, d) => `<svg width="120" height="120" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" stroke="#000" fill="#fff"/><path d="M50 50 L50 5 A45 45 0 ${d==2||(d==4&&n>2)?1:0} 1 ${50+45*Math.sin(2*Math.PI*n/d)} ${50-45*Math.cos(2*Math.PI*n/d)} Z" fill="#e65100" stroke="#000" opacity="${n>0?1:0}"/></svg>`,
                fractionLine: (n,d) => `<svg width="300" height="60"><line x1="20" y1="30" x2="280" y2="30" stroke="#333" stroke-width="2"/><text x="20" y="50">0</text><text x="280" y="50">1</text><circle cx="${20+(n/d)*260}" cy="30" r="6" fill="#e65100"/></svg>`,
                lShape: (w1,h1,w2,h2) => `<svg width="200" height="180" viewBox="0 0 200 180"><path d="M20 20 H${20+w1*10} V${20+h1*10} H${20+(w1+w2)*10} V${20+(h1+h2)*10} H20 Z" fill="#e0f2f1" stroke="#004d40" stroke-width="2"/><text x="${20+w1*5}" y="15" text-anchor="middle">${w1}</text><text x="10" y="${20+h1*5}" text-anchor="middle">${h1}</text><text x="${20+(w1+w2)*10+10}" y="${20+h1*10+h2*5}" text-anchor="middle">${h2}</text></svg>`,
                pictograph: (k) => `<svg width="250" height="80"><text x="5" y="30">A</text><circle cx="30" cy="25" r="8" fill="orange"/><circle cx="50" cy="25" r="8" fill="orange"/><text x="5" y="60">B</text><circle cx="30" cy="55" r="8" fill="orange"/><text x="100" y="75" font-size="10">Key: O = ${k}</text></svg>`,
                symmetry: (t, s) => {
                    let d = t==='tri' ? "M50 10 L90 90 L10 90 Z" : "M20 30 H80 V70 H20 Z";
                    let l = s ? (t==='tri' ? `<line x1="50" y1="10" x2="50" y2="90" stroke="red" stroke-dasharray="4"/>` : `<line x1="50" y1="30" x2="50" y2="70" stroke="red" stroke-dasharray="4"/>`) : `<line x1="10" y1="20" x2="90" y2="80" stroke="red" stroke-dasharray="4"/>`;
                    return `<svg width="100" height="100"><path d="${d}" fill="#e0f2f1" stroke="black" stroke-width="2"/>${l}</svg>`;
                }
            }
        };

        // --- 3. COMPLETE 33-STANDARD BANK WITH MULTI-MODES ---
        const Bank = {
            "Number Sense (NSO)": [
                { id: "MA.3.NSO.1.1", desc: "Read/Write Numbers", gen: () => {
                    const n = Utils.rInt(1001, 9999);
                    const mode = Math.random() > 0.5 ? 'word' : 'expanded';
                    if (mode === 'word') {
                        const correct = Utils.numToWords(n);
                        const opts = Utils.genOptions(correct, () => Utils.numToWords(Utils.rInt(1000, 9999)));
                        return { text: `Select the <strong>Word Form</strong> for <strong>${n}</strong>.`, type: 'radio', options: opts.map(x=>({t:x,c:x===correct})), fb: "Check place value words." };
                    } else {
                        const correct = `${Math.floor(n/1000)*1000} + ${Math.floor((n%1000)/100)*100} + ${Math.floor((n%100)/10)*10} + ${n%10}`;
                        const d1 = `${Math.floor(n/1000)*1000} + ${Math.floor((n%1000)/100)*10} + ${n%10}`;
                        const d2 = `${Math.floor(n/1000)} + ${Math.floor((n%1000)/100)} + ${Math.floor((n%100)/10)} + ${n%10}`;
                        const d3 = `${Math.floor(n/1000)*1000} + 100 + 10 + 1`;
                        return { text: `Select the <strong>Expanded Form</strong> for <strong>${n}</strong>.`, type: 'radio', options: Utils.shuffle([{t:correct,c:true},{t:d1,c:false},{t:d2,c:false},{t:d3,c:false}]), fb: "Decompose by value." };
                    }
                }},
                { id: "MA.3.NSO.1.2", desc: "Compose/Decompose", gen: () => ({ text: "Which represents <strong>2,400</strong>?", type: 'radio', options: Utils.shuffle([{t:"24 hundreds",c:true},{t:"24 tens",c:false},{t:"2 thousands 4 tens",c:false},{t:"200 tens",c:false}]), fb: "24 x 100 = 2400." })},
                { id: "MA.3.NSO.1.3", desc: "Compare Numbers", gen: () => ({ text: "Select the <strong>TRUE</strong> statement.", type: 'radio', options: Utils.shuffle([{t:"3,040 > 3,004",c:true},{t:"1,200 < 1,099",c:false},{t:"5,600 = 5,060",c:false},{t:"4,000 < 3,999",c:false}]), fb: "Compare from left to right." })},
                { id: "MA.3.NSO.1.4", desc: "Rounding", gen: () => { const n=Utils.rInt(120,880); return { text: `Round <strong>${n}</strong> to the nearest 100.`, type: 'equation', ans: (Math.round(n/100)*100).toString(), fb: "5 or more, round up." }}},
                { id: "MA.3.NSO.2.1", desc: "Add/Sub", gen: () => { const a=Utils.rInt(1000,5000), b=Utils.rInt(100,900); return { text: `Solve: <strong>${a} - ${b}</strong>`, type: 'equation', ans: (a-b).toString(), fb: "Regroup carefully." }}},
                { id: "MA.3.NSO.2.2", desc: "Mult 0-144", gen: () => { const a=Utils.rInt(6,12), b=Utils.rInt(6,12); return { text: `Solve: <strong>${a} Ã— ${b}</strong>`, type: 'equation', ans: (a*b).toString(), fb: "Recall facts." }}},
                { id: "MA.3.NSO.2.3", desc: "Mult by 10s", gen: () => { const a=Utils.rInt(2,9), b=Utils.pick([10,20,30,40,50]); return { text: `Solve: <strong>${a} Ã— ${b}</strong>`, type: 'equation', ans: (a*b).toString(), fb: "Multiply non-zero digits and append 0." }}},
                { id: "MA.3.NSO.2.4", desc: "Mult 1d x 2d", gen: () => { const a=Utils.rInt(3,9), b=Utils.rInt(12,25); return { text: `Solve: <strong>${b} Ã— ${a}</strong>`, type: 'equation', ans: (a*b).toString(), fb: "Use standard algorithm or area model." }}}
            ],
            "Algebra (AR)": [
                { id: "MA.3.AR.1.1", desc: "Distributive Prop", gen: () => ({ text: "Select the expression for <strong>8 Ã— 13</strong>.", type: 'radio', options: Utils.shuffle([{t:"(8Ã—10) + (8Ã—3)",c:true},{t:"(8Ã—10) Ã— (8Ã—3)",c:false},{t:"8 + 10 + 3",c:false},{t:"(8+10) Ã— (8+3)",c:false}]), fb: "Break 13 into 10 + 3." })},
                { id: "MA.3.AR.1.2", desc: "Word Problems", gen: () => ({ text: "A store has 6 boxes. Each box has 8 toys. How many total?", type: 'equation', ans: "48", fb: "6 groups of 8." })},
                { id: "MA.3.AR.2.1", desc: "Inverse Ops", gen: () => ({ text: "Which helps solve <strong>32 Ã· 8 = ?</strong>", type: 'radio', options: Utils.shuffle([{t:"8 Ã— ? = 32",c:true},{t:"32 Ã— 8 = ?",c:false},{t:"8 + ? = 32",c:false},{t:"32 - 8 = ?",c:false}]), fb: "Inverse of division is multiplication." })},
                { id: "MA.3.AR.2.2", desc: "True/False", gen: () => ({ text: "True or False: <strong>5 Ã— 6 = 15 + 15</strong>", type: 'radio', options: [{t:"True",c:true},{t:"False",c:false}], fb: "30 = 30." })},
                { id: "MA.3.AR.2.3", desc: "Missing Factor", gen: () => ({ text: "<strong>? Ã— 9 = 63</strong>", type: 'equation', ans: "7", fb: "63 divided by 9." })},
                { id: "MA.3.AR.3.1", desc: "Even/Odd", gen: () => { const n=Utils.rInt(10,99); const e=n%2===0; return { text: `Is <strong>${n}</strong> Even or Odd?`, type: 'radio', options: [{t:"Even",c:e},{t:"Odd",c:!e}], fb: "Look at ones digit." }}},
                { id: "MA.3.AR.3.2", desc: "Multiples", gen: () => ({ text: "Which is a multiple of 4?", type: 'radio', options: Utils.shuffle([{t:"16",c:true},{t:"14",c:false},{t:"18",c:false},{t:"22",c:false}]), fb: "4, 8, 12, 16..." })},
                { id: "MA.3.AR.3.3", desc: "Table Patterns", gen: () => ({ text: "Rule: Multiply by 3. Input: 5. Output?", type: 'table', inputs:[3,4,5], outputs:[9,12,"?"], missing:2, ans:"15", fb: "5 x 3 = 15." })}
            ],
            "Fractions (FR)": [
                { id: "MA.3.FR.1.1", desc: "Visual Fractions", gen: () => ({ text: "What fraction is shaded?", visual: Utils.svg.fraction(1,4), type: 'radio', options: Utils.shuffle([{t:"1/4",c:true},{t:"3/4",c:false},{t:"1/3",c:false},{t:"4/1",c:false}]), fb: "1 part out of 4." })},
                { id: "MA.3.FR.1.2", desc: "Represent 1", gen: () => ({ text: "Which fraction equals 1?", type: 'radio', options: Utils.shuffle([{t:"3/3",c:true},{t:"3/1",c:false},{t:"1/3",c:false},{t:"0/3",c:false}]), fb: "Numerator equals Denominator." })},
                { id: "MA.3.FR.1.3", desc: "Read/Write Frac", gen: () => ({ text: "Select <strong>Two-Thirds</strong>.", type: 'radio', options: Utils.shuffle([{t:"2/3",c:true},{t:"3/2",c:false},{t:"2/2",c:false},{t:"3/3",c:false}]), fb: "2 is num, 3 is denom." })},
                { id: "MA.3.FR.2.1", desc: "Compare Fractions", gen: () => { const n=Utils.rInt(1,3); return { text: "Identify fraction on line.", visual: Utils.svg.fractionLine(n,4), type: 'radio', options: Utils.shuffle([{t:`${n}/4`,c:true},{t:`${4}/n`,c:false},{t:`1/5`,c:false},{t:`1/2`,c:false}]), fb: "Count segments." }}},
                { id: "MA.3.FR.2.2", desc: "Equivalence", gen: () => ({ text: "Select ALL equivalent to 1/2.", type: 'multi', options: Utils.shuffle([{t:"2/4",c:true},{t:"3/6",c:true},{t:"1/3",c:false},{t:"2/3",c:false}]), fb: "Num is half of Denom." })}
            ],
            "Geometry (GR)": [
                { id: "MA.3.GR.1.1", desc: "Points/Lines", gen: () => ({ text: "Identify this figure.", visual: Utils.svg.lines('ray'), type: 'radio', options: Utils.shuffle([{t:"Ray",c:true},{t:"Line",c:false},{t:"Segment",c:false},{t:"Point",c:false}]), fb: "Starts at point, goes forever." })},
                { id: "MA.3.GR.1.2", desc: "Attributes (Multi-Mode)", gen: () => {
                    const m = Utils.pick(['visual','multi']);
                    if(m==='visual') return { text: "Which is a Trapezoid?", visual: Utils.svg.symmetry('rect', false), type: 'radio', options: Utils.shuffle([{t:"Shape A (Trapezoid)",c:true},{t:"Shape B (Square)",c:false},{t:"Shape C",c:false},{t:"Shape D",c:false}]), fb: "1 pair parallel sides." };
                    return { text: "Select ALL with 4 right angles.", type: 'multi', options: Utils.shuffle([{t:"Square",c:true},{t:"Rectangle",c:true},{t:"Rhombus",c:false},{t:"Triangle",c:false}]), fb: "Rectangles/Squares." };
                }},
                { id: "MA.3.GR.1.3", desc: "Symmetry", gen: () => { const s=Math.random()>0.5; return { text: "Is this a line of symmetry?", visual: Utils.svg.symmetry('tri',s), type: 'radio', options: [{t:"Yes",c:s},{t:"No",c:!s}], fb: "Mirror image." }}},
                { id: "MA.3.GR.2.1", desc: "Area", gen: () => ({ text: "Area of 5x6?", type: 'equation', ans: "30", fb: "L x W." })},
                { id: "MA.3.GR.2.2", desc: "Area Distributive", gen: () => ({ text: "Break 6x12:", type: 'radio', options: Utils.shuffle([{t:"(6x10)+(6x2)",c:true},{t:"(6x6)+(6x6)",c:false},{t:"6+10+2",c:false},{t:"(6x2)+(6x2)",c:false}]), fb: "Break length." })},
                { id: "MA.3.GR.2.3", desc: "Perimeter (Multi-Mode)", gen: () => {
                    const m = Utils.pick(['tiled','word']);
                    if(m==='tiled') return { text: "Find Perimeter.", visual: Utils.svg.tiledRect(4,3), type: 'equation', ans: "14", fb: "Count edges." };
                    return { text: "Rectangle: 5x3. Perimeter?", type: 'equation', ans: "16", fb: "2(5+3)." };
                }},
                { id: "MA.3.GR.2.4", desc: "Composite Area", gen: () => ({ text: "Find Total Area.", visual: Utils.svg.lShape(4,4,2,2), type: 'equation', ans: "20", fb: "Sum of rectangles." })}
            ],
            "Measurement (M)": [
                { id: "MA.3.M.1.1", desc: "Tools", gen: () => ({ text: "Measure pool water?", type: 'radio', options: Utils.shuffle([{t:"Gallons",c:true},{t:"Inches",c:false},{t:"Pounds",c:false},{t:"Cups",c:false}]), fb: "Volume." })},
                { id: "MA.3.M.1.2", desc: "Word Problems", gen: () => ({ text: "Box is 10kg. 2 boxes?", type: 'equation', ans: "20", fb: "10+10." })},
                { id: "MA.3.M.2.1", desc: "Time", gen: () => ({ text: "Time shown?", visual: Utils.svg.clock(4,15), type: 'radio', options: Utils.shuffle([{t:"4:15",c:true},{t:"4:03",c:false},{t:"3:15",c:false},{t:"5:15",c:false}]), fb: "Hour 4, Min 15." })},
                { id: "MA.3.M.2.2", desc: "Elapsed Time", gen: () => ({ text: "1:00 to 1:45?", type: 'radio', options: Utils.shuffle([{t:"45 min",c:true},{t:"30 min",c:false},{t:"15 min",c:false},{t:"1 hour",c:false}]), fb: "Count min." })}
            ],
            "Data (DP)": [
                { id: "MA.3.DP.1.1", desc: "Read Graphs", gen: () => ({ text: "How many in A? Key: O=2", visual: Utils.svg.pictograph(2), type: 'equation', ans: "4", fb: "2 circles x 2." })},
                { id: "MA.3.DP.1.2", desc: "Interpret", gen: () => ({ text: "Total A(4) + B(2)?", visual: Utils.svg.pictograph(2), type: 'equation', ans: "6", fb: "4+2." })}
            ]
        };

        // --- 3. APP ENGINE ---
        const App = {
            mode: 'practice', currentQ: null, score: 0,
            
            init: function() {
                const menu = document.getElementById('menu');
                for(const cat in Bank) {
                    const h = document.createElement('div'); h.className='menu-cat'; h.innerText=cat; menu.appendChild(h);
                    Bank[cat].forEach(std => {
                        const b = document.createElement('div'); b.className='std-btn';
                        b.innerHTML = `<strong>${std.id}</strong><small>${std.desc}</small>`;
                        b.onclick = () => App.loadPractice(std);
                        menu.appendChild(b);
                    });
                }
            },

            startSim: function() {
                this.mode = 'sim'; this.score = 0;
                document.getElementById('q-badge').innerText = "Test Sim Mode";
                this.all = []; for(const c in Bank) Bank[c].forEach(s=>this.all.push(s));
                this.nextSim();
            },
            nextSim: function() { const s=Utils.pick(this.all); this.loadQ(s.gen(), s.id); },
            loadPractice: function(s) { this.mode='practice'; this.currStd=s; this.loadQ(s.gen(), s.id); },

            loadQ: function(q, id) {
                this.currentQ = q;
                document.getElementById('q-prompt').innerHTML = q.text;
                document.getElementById('q-badge').innerText = this.mode==='sim'?"Sim Mode":id;
                const v = document.getElementById('q-visual'); v.innerHTML=q.visual||''; v.style.display=q.visual?'flex':'none';
                
                const list = document.getElementById('q-options'); list.innerHTML='';
                const btn = document.getElementById('btn-action'); btn.innerText="Check"; btn.disabled=true;
                btn.onclick = () => App.check();
                document.getElementById('q-feedback').style.display='none';

                if(q.type === 'radio' || q.type === 'multi') {
                    q.options.forEach((o,i) => {
                        const b = document.createElement('div'); b.className=`opt-btn ${q.type}`;
                        b.innerHTML=`<div class="icon"></div> ${o.t}`;
                        b.onclick = () => {
                             if(q.type==='radio') { document.querySelectorAll('.opt-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); App.sel=i; }
                             else b.classList.toggle('selected');
                             btn.disabled=false;
                        };
                        list.appendChild(b);
                    });
                } else if(q.type === 'equation') {
                    list.innerHTML = `<input id="inp" class="eq-input" placeholder="Answer...">`;
                    setTimeout(()=>document.getElementById('inp').oninput=(e)=>btn.disabled=e.target.value==='',0);
                } else if(q.type === 'table') {
                    let html = `<table class="tei-table"><tr><th>In</th><th>Out</th></tr>`;
                    q.inputs.forEach((val, i) => {
                        const cell = i === q.missing ? `<input type="number" id="tbl-in">` : q.outputs[i];
                        html += `<tr><td>${val}</td><td>${cell}</td></tr>`;
                    });
                    html += `</table>`;
                    list.innerHTML = html;
                    setTimeout(() => document.getElementById('tbl-in').addEventListener('input', () => btn.disabled = false), 0);
                }
            },

            check: function() {
                const q = this.currentQ; let ok=false;
                if(q.type==='radio') ok=q.options[App.sel].c;
                if(q.type==='multi') {
                    const s=[], c=q.options.map((o,i)=>o.c?i:null).filter(x=>x!==null);
                    document.querySelectorAll('.opt-btn').forEach((b,i)=>{if(b.classList.contains('selected'))s.push(i)});
                    if(s.length===c.length && s.every(v=>c.includes(v))) ok=true;
                }
                if(q.type==='equation') ok=document.getElementById('inp').value.trim()===q.ans;
                if(q.type==='table') ok=document.getElementById('tbl-in').value.trim()===q.ans;

                const fb = document.getElementById('q-feedback');
                fb.style.display='block'; fb.className=`feedback ${ok?'correct':'wrong'}`;
                fb.innerHTML = `<strong>${ok?'Correct!':'Incorrect'}</strong><br>${q.fb}`;
                if(ok) document.getElementById('score-display').innerText = `Score: ${++this.score}`;
                
                const btn = document.getElementById('btn-action'); btn.innerText="Next";
                btn.onclick = () => this.mode==='sim'?this.nextSim():this.loadPractice(this.currStd);
            }
        };
        App.init();
    </script>
</body>
</html>
