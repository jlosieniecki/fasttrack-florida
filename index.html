<script>
    // --- STATE MANAGEMENT ---
    let queue = [];
    let currentIndex = 0;
    let userAnswers = {}; 

    // --- HELPER FUNCTIONS ---
    const uuid = () => Math.random().toString(36).substr(2, 9);
    const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    // --- GENERATOR ENGINE (Organized by Reporting Category) ---
    const GENERATORS = {

        /* =========================================================
           CATEGORY 1: NUMBER SENSE (NSO) 
           Benchmarks: NSO.1.1, 1.2, 1.3, 1.4, 2.1
           ========================================================= */

        // MA.3.NSO.1.1: Read/Write Numbers
        // Level 2: Compose using hundreds/tens [cite: 5]
        // Level 5: Identify errors in composition 
        "NSO.1.1": () => {
            const variant = Math.random();
            const n = randInt(1000, 9999);
            
            // Variety A: HOT TEXT (Identify Place Value)
            if (variant < 0.33) {
                const digits = n.toString().split('');
                return {
                    id: uuid(), type: "hot-text", standard: "MA.3.NSO.1.1",
                    text: `Select the digit in the <b>hundreds</b> place.`,
                    sentence: digits, correctIndices: [1], selectable: true
                };
            }
            // Variety B: MULTIPLE CHOICE (Standard Form)
            else if (variant < 0.66) {
                return {
                    id: uuid(), type: "mc", standard: "MA.3.NSO.1.1",
                    text: `Which shows <b>${n.toLocaleString()}</b> in expanded form?`,
                    options: [
                        { txt: `${Math.floor(n/1000)*1000} + ${Math.floor((n%1000)/100)*100} + ${Math.floor((n%100)/10)*10} + ${n%10}`, correct: true },
                        { txt: `${Math.floor(n/1000)*1000} + ${Math.floor((n%1000)/100)} + ${Math.floor((n%100)/10)} + ${n%10}`, correct: false },
                        { txt: `${n} + 100 + 10 + 1`, correct: false },
                        { txt: `${Math.floor(n/1000)} thousands + ${n%10} hundreds`, correct: false }
                    ].sort(() => Math.random() - 0.5)
                };
            }
            // Variety C: ERROR ANALYSIS (Level 5 Skill) 
            else {
                const wrongVal = n + 100;
                return {
                    id: uuid(), type: "mc", standard: "MA.3.NSO.1.1 (Level 5)",
                    text: `Student A wrote <b>${n.toLocaleString()}</b> as "${Math.floor(n/1000)} thousands, ${Math.floor((wrongVal%1000)/100)} hundreds, ${Math.floor((n%100)/10)} tens, and ${n%10} ones." <br><br>Is this correct?`,
                    options: [
                        { txt: "Yes, the value is the same.", correct: false },
                        { txt: `No, they used the wrong digit for the hundreds place.`, correct: true },
                        { txt: "No, they used the wrong digit for the thousands place.", correct: false },
                        { txt: "No, standard form cannot be written in words.", correct: false }
                    ]
                };
            }
        },

        // MA.3.NSO.1.4: Rounding
        // Level 3: Round to nearest 100 
        "NSO.1.4": () => {
            const n = randInt(100, 900);
            const target = Math.round(n/100)*100;
            return {
                id: uuid(), type: "editing", standard: "MA.3.NSO.1.4",
                text: `Round <b>${n}</b> to the nearest hundred.`,
                template: `The number ${n} rounded to the nearest hundred is [DROP1].`,
                dropdowns: { "DROP1": { opts: [(Math.floor(n/100)*100).toString(), (Math.ceil(n/100)*100).toString(), (Math.round(n/10)*10).toString()], ans: target.toString() } }
            };
        },

        /* =========================================================
           CATEGORY 2: FRACTIONAL REASONING (FR) 
           Benchmarks: FR.1.1, 1.2, 1.3, 2.1, 2.2
           ========================================================= */

        // MA.3.FR.1.1: Represent Fractions
        // Level 2: Denominators 2-6 [cite: 5]
        "FR.1.1": () => {
            const den = [3, 4, 6, 8][randInt(0, 3)];
            const num = randInt(1, den - 1);
            return {
                id: uuid(), type: "fraction", standard: "MA.3.FR.1.1",
                text: `Click the model to shade <b>${num}/${den}</b>.`,
                total: den, correctCount: num
            };
        },

        // MA.3.FR.2.1: Comparison
        // Level 3: Compare with same numerator or denominator 
        "FR.2.1": () => {
            // Logic: Compare 1/4 vs 1/6 (Same numerator) OR 2/4 vs 3/4 (Same denominator)
            const type = Math.random() > 0.5 ? 'num' : 'den';
            let f1, f2, sym;
            
            if (type === 'num') {
                const n = randInt(1,3);
                const d1 = 4, d2 = 8;
                f1 = {n:n, d:d1}; f2 = {n:n, d:d2};
                sym = ">"; // Smaller denom is bigger fraction
            } else {
                const d = 6;
                const n1 = 2, n2 = 4;
                f1 = {n:n1, d:d}; f2 = {n:n2, d:d};
                sym = "<";
            }
            
            return {
                id: uuid(), type: "editing", standard: "MA.3.FR.2.1",
                text: `Compare the fractions: <b>${f1.n}/${f1.d}</b> and <b>${f2.n}/${f2.d}</b>`,
                template: `${f1.n}/${f1.d} [DROP1] ${f2.n}/${f2.d}`,
                dropdowns: { "DROP1": { opts: ["<", ">", "="], ans: sym } }
            };
        },

        /* =========================================================
           CATEGORY 3: ALGEBRAIC REASONING (AR) 
           Benchmarks: AR.1.1, 1.2, 2.1, 2.2, 2.3, 3.1, 3.2, 3.3
           ========================================================= */

        // MA.3.AR.1.2: Multi-Step Problems
        // Level 3: One- and two-step problems 
        "AR.1.2": () => {
            const start = randInt(20, 50);
            const sub = randInt(5, 15);
            const add = randInt(5, 15);
            const ans = start - sub + add;
            
            return {
                id: uuid(), type: "equation", standard: "MA.3.AR.1.2",
                text: `Sara has ${start} stickers. She gives ${sub} to a friend. Then she buys ${add} more.<br>How many does she have now?`,
                ans: ans.toString()
            };
        },

        // MA.3.AR.2.3: Missing Factors
        // Level 4: Unknown in any position [cite: 21]
        "AR.2.3": () => {
            const a = randInt(3, 9);
            const b = randInt(4, 9);
            const prod = a * b;
            
            // Randomly hide a, b, or prod
            const hide = randInt(1, 3);
            let txt = "";
            let ans = "";
            
            if(hide===1) { txt = `? × ${b} = ${prod}`; ans = a.toString(); }
            else if(hide===2) { txt = `${a} × ? = ${prod}`; ans = b.toString(); }
            else { txt = `${prod} ÷ ${a} = ?`; ans = b.toString(); }

            return {
                id: uuid(), type: "equation", standard: "MA.3.AR.2.3",
                text: `Find the unknown number.<br><br><b>${txt}</b>`,
                ans: ans
            };
        },

        // MA.3.AR.3.1: Patterns
        // Level 2: Identify patterns [cite: 5]
        "AR.3.1": () => {
            const rule = randInt(2, 5);
            const start = randInt(2, 10);
            const seq = [start, start+rule, start+(rule*2), start+(rule*3)];
            
            return {
                id: uuid(), type: "mc", standard: "MA.3.AR.3.1",
                text: `What is the rule for the pattern?<br><b>${seq.join(", ")}...</b>`,
                options: [
                    { txt: `Add ${rule}`, correct: true },
                    { txt: `Multiply by ${rule}`, correct: false },
                    { txt: `Add ${rule + 1}`, correct: false },
                    { txt: `Subtract ${rule}`, correct: false }
                ].sort(() => Math.random() - 0.5)
            };
        },

        /* =========================================================
           CATEGORY 4: GEOMETRY & DATA (GR/M/DP) 
           Benchmarks: GR.1.1-1.3, GR.2.1-2.4, M.1.1-1.2, M.2.1-2.2, DP.1.1-1.2
           ========================================================= */

        // MA.3.GR.1.2: Attributes of Shapes
        // Level 2: Identifies quadrilaterals 
        // Level 4: Draws/Identifies based on defining attributes [cite: 21]
        "GR.1.2": () => {
            return {
                id: uuid(), type: "multiselect", standard: "MA.3.GR.1.2",
                text: `Select <b>all</b> the shapes that are Quadrilaterals.`,
                options: [
                    { txt: "Square", correct: true },
                    { txt: "Triangle", correct: false },
                    { txt: "Trapezoid", correct: true },
                    { txt: "Pentagon", correct: false },
                    { txt: "Rhombus", correct: true }
                ].sort(() => Math.random() - 0.5)
            };
        },

        // MA.3.M.2.1: Telling Time
        // Level 3: To the minute 
        "M.2.1": () => {
            const h = randInt(1, 12);
            const m = randInt(10, 50); // avoid single digits for simple parsing
            return {
                id: uuid(), type: "mc", standard: "MA.3.M.2.1",
                text: `The clock shows the time ${h}:${m}. select the correct time.`,
                // Note: In a real app we'd draw the clock here using SVG
                options: [
                    { txt: `${h}:${m}`, correct: true },
                    { txt: `${h+1}:${m}`, correct: false },
                    { txt: `${h}:${m-5}`, correct: false },
                    { txt: `${h-1}:${m}`, correct: false }
                ].sort(() => Math.random() - 0.5)
            };
        },

        // MA.3.DP.1.1: Graphing
        // Level 3: Represents data with whole number values 
        "DP.1.1": () => {
            const vals = [randInt(2,10), randInt(2,10), randInt(2,10)];
            return {
                id: uuid(), type: "graphing", standard: "MA.3.DP.1.1",
                text: `Complete the bar graph for the data:<br>A: ${vals[0]}, B: ${vals[1]}, C: ${vals[2]}`,
                labels: ["A", "B", "C"], max: 12, correct: vals
            };
        },
        
        // MA.3.GR.2.4: Perimeter vs Area
        // Level 4: Solves problems involving both [cite: 21]
        "GR.2.4": () => {
            const l = 4, w = 3;
            return {
                id: uuid(), type: "matching", standard: "MA.3.GR.2.4",
                text: `For a rectangle with Length = ${l} and Width = ${w}:`,
                rows: ["Area", "Perimeter"],
                cols: ["12", "14", "7"],
                validate: (r, c) => (r===0 && c===0) || (r===1 && c===1)
            };
        }
    };

    // --- RENDER LOGIC (Unchanged from previous, but ensures all types handled) ---
    // (Ensure you keep the renderQ functions for 'editing', 'hot-text', 'fraction', etc.)
    
    // ... [Insert the Render Logic from the previous artifact here if not already present] ...

    // --- SESSION CONTROLLER ---
    window.startTest = (mode, count) => {
        queue = []; userAnswers = {}; currentIndex = 0;
        let keys = Object.keys(GENERATORS);

        // Filter by Reporting Category if needed
        if(mode !== 'ALL') {
             // Example: if mode is 'NSO', filter keys that start with 'NSO'
             keys = keys.filter(k => k.startsWith(mode));
        }

        if(keys.length === 0) { alert("No questions available for this category yet."); return; }

        for(let i=0; i<count; i++) {
            let k = keys[Math.floor(Math.random()*keys.length)];
            queue.push(GENERATORS[k]());
        }

        document.getElementById('screen-menu').classList.remove('active');
        document.getElementById('screen-test').classList.add('active');
        renderQ();
    };
    
    // ... [Keep nextQ, prevQ, and render functions] ...
    
    /* NOTE: You must ensure the renderQ function handles all types: 
       'mc', 'editing', 'hot-text', 'fraction', 'graphing', 'multiselect', 'equation', 'matching'
    */

</script>
