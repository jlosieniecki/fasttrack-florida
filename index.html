<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Florida FAST Math | Multi-Part Level 5 Simulator</title>
    <style>
        :root {
            --cam-blue: #003366; --cam-light-blue: #e6f0fa; --cam-gray: #f4f4f4;
            --border: #cccccc; --text: #333333; --focus: #ff9900;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; padding: 0; background: var(--cam-gray); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* DASHBOARD */
        #dashboard { display: flex; height: 100vh; }
        .sidebar { width: 340px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .logo-area { padding: 25px; background: var(--cam-blue); color: white; }
        .logo-area h1 { margin: 0; font-size: 1.3rem; letter-spacing: 0.5px; }
        .menu-scroll { flex: 1; overflow-y: auto; padding: 15px 10px; }
        .cat-title { font-size: 0.85rem; text-transform: uppercase; color: #546e7a; font-weight: 800; margin: 15px 0 5px 5px; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        .std-btn { display: block; width: 100%; text-align: left; padding: 10px; margin-bottom: 4px; background: transparent; border: 1px solid transparent; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #333; transition: 0.1s; }
        .std-btn:hover { background: var(--cam-light-blue); border-color: #b2dfdb; }
        .std-btn small { display: block; font-size: 0.75rem; margin-top: 3px; color: #666; }

        .main-dash { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; text-align: center; background: white; }
        .mock-btn { padding: 20px 50px; font-size: 1.3rem; font-weight: bold; background: #0056b3; color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,86,179,0.3); transition: 0.2s; }
        .mock-btn:hover { background: #004494; transform: translateY(-2px); }

        /* CAMBIUM TEST INTERFACE */
        #test-interface { display: none; height: 100vh; flex-direction: column; background: white; }
        .top-nav { background: var(--cam-blue); color: white; height: 55px; display: flex; justify-content: space-between; align-items: center; padding: 0 25px; flex-shrink: 0; }
        .nav-left { display: flex; gap: 20px; align-items: center; }
        .nav-right { display: flex; gap: 15px; }
        .nav-btn { background: transparent; border: 1px solid white; color: white; padding: 8px 20px; cursor: pointer; font-size: 0.95rem; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.2); }
        .nav-btn.primary { background: white; color: var(--cam-blue); }
        .nav-btn.primary:hover { background: #e0e0e0; }
        
        .test-body { flex: 1; display: flex; overflow: hidden; }
        .pane { flex: 1; overflow-y: auto; padding: 40px; position: relative; }
        .stimulus-pane { border-right: 3px solid var(--border); background: #fafafa; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; max-width: 45%; }
        .response-pane { background: white; display: flex; flex-direction: column; }

        .q-text { font-size: 1.35rem; line-height: 1.6; margin-bottom: 20px; color: #212529; }

        /* TASK BLOCKS (Part A / Part B) */
        .task-block { background: #fff; border: 1px solid var(--border); border-left: 4px solid var(--cam-blue); border-radius: 4px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .task-label { font-weight: bold; font-size: 1.1rem; color: var(--cam-blue); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* TEI Elements */
        .visual-stage svg { max-width: 100%; height: auto; overflow: visible; margin-bottom: 15px; }
        .clk-slice { cursor: pointer; transition: 0.1s; }
        .clk-slice:hover { stroke: var(--focus); stroke-width: 3px; opacity: 0.9; }
        .bar-zone { cursor: pointer; }
        .bar-zone:hover rect { fill: rgba(0, 51, 102, 0.2); }
        
        .hot-text { cursor: pointer; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; margin: 0 3px; background: white; display: inline-block; font-weight: bold; color: #0056b3; text-decoration: underline; }
        .hot-text:hover { border-color: #0056b3; background: #e6f0fa; }
        .hot-text.selected { background: #0056b3; color: white; border-color: #0056b3; text-decoration: none; }
        
        .inline-drop { font-size: 1.15rem; padding: 6px 12px; border: 2px solid #546e7a; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 0 4px; background: #f8f9fa; }

        /* Radio & Checkbox */
        .opt-list { display: flex; flex-direction: column; gap: 10px; }
        .opt-list.grid { display: grid; grid-template-columns: 1fr 1fr; }
        .opt-item { display: flex; align-items: center; padding: 15px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 1.1rem; background: white; transition: 0.1s;}
        .opt-item:hover { background: var(--cam-light-blue); border-color: #90caf9; }
        .opt-item.selected { border-color: var(--cam-blue); background: var(--cam-light-blue); box-shadow: inset 0 0 0 1px var(--cam-blue); }
        .opt-icon { width: 22px; height: 22px; border: 2px solid #666; margin-right: 15px; display: flex; justify-content: center; align-items: center; border-radius: 50%; flex-shrink: 0;}
        .multi .opt-icon { border-radius: 4px; }
        .selected .opt-icon { background: var(--cam-blue); border-color: var(--cam-blue); }
        .selected .opt-icon::after { content:''; width:10px; height:10px; background:white; border-radius:50%; }
        .multi.selected .opt-icon::after { content:'✔'; background:none; color:white; font-size:16px; font-weight:bold; }

        /* Matrix TEI */
        .matrix-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 1.1rem; }
        .matrix-table th, .matrix-table td { border: 1px solid var(--border); padding: 12px; text-align: center; }
        .matrix-table th { background: var(--cam-light-blue); font-weight: bold; color: var(--cam-blue); }
        .matrix-cb { width: 24px; height: 24px; cursor: pointer; }
        
        /* Equation Input & Soft Keypad */
        .eq-input { width: 100%; max-width: 200px; padding: 12px; font-size: 1.4rem; border: 2px solid #666; border-radius: 6px; outline: none; text-align: center; margin: 5px; background: white; font-weight: bold; transition: 0.2s;}
        .eq-input.active-focus { border-color: var(--focus); box-shadow: 0 0 8px rgba(255,153,0,0.5); background: #fffde7; }
        
        .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; max-width: 400px; background: #e9ecef; padding: 15px; border-radius: 8px; border: 1px solid #ced4da; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .key-btn { padding: 12px; font-size: 1.2rem; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .key-btn:hover { background: #d0d5db; }
        .key-btn:active { transform: scale(0.95); }
        .key-btn.op { background: #cfd8dc; color: #003366; }
        .key-btn.wide { grid-column: span 2; }

        /* Feedback Overlay */
        #feedback-overlay { position: fixed; bottom: 40px; right: 40px; padding: 25px 50px; border-radius: 8px; font-size: 1.5rem; font-weight: bold; color: white; display: none; z-index: 1000; box-shadow: 0 8px 25px rgba(0,0,0,0.4); }
        .correct-fb { background: #28a745; }
        .wrong-fb { background: #dc3545; }
    </style>
</head>
<body>

<div id="dashboard">
    <div class="sidebar">
        <div class="logo-area">
            <h1>FAST Mathematics</h1>
            <p>Multi-Part ALD 5 Engine</p>
        </div>
        <div class="menu-scroll" id="menu"></div>
    </div>
    <div class="main-dash">
        <h2 style="font-size:2.5rem; color:var(--cam-blue); margin-bottom:15px;">Florida B.E.S.T. Simulator</h2>
        <p style="max-width: 650px; font-size: 1.25rem; line-height: 1.6; margin-bottom: 40px; color:#555;">
            Welcome to the ultimate unlimited simulator. Features include <strong>Multi-Part (Part A/B) Logic</strong>, rotating syntactic word problems, raw-data data analysis, and reverse-engineering Level 5 rigor.
        </p>
        <button class="mock-btn" onclick="App.startTest()">Launch Authentic Mock Test</button>
    </div>
</div>

<div id="test-interface">
    <div class="top-nav">
        <div class="nav-left">
            <strong id="test-title" style="font-size:1.2rem; letter-spacing: 1px;">Practice</strong>
            <span id="q-counter" style="opacity: 0.9; font-size: 1.1rem; border-left:2px solid #888; padding-left:15px;">Q 1</span>
        </div>
        <div class="nav-right">
            <button class="nav-btn">⚑ Flag</button>
            <button class="nav-btn" onclick="App.exitToMenu()">Pause / Save</button>
            <button class="nav-btn primary" id="btn-check" onclick="App.check()" disabled>Submit & Next &rarr;</button>
        </div>
    </div>
    <div class="test-body">
        <div class="pane stimulus-pane" id="stimulus-pane"></div>
        <div class="pane response-pane">
            <div class="q-text" id="q-text"></div>
            <div id="q-response-area"></div>
            
            <div id="keypad-container" style="display:none;">
                <div class="keypad">
                    <button class="key-btn" onclick="App.typeKey('1')">1</button>
                    <button class="key-btn" onclick="App.typeKey('2')">2</button>
                    <button class="key-btn" onclick="App.typeKey('3')">3</button>
                    <button class="key-btn op" onclick="App.typeKey(':')">:</button>
                    <button class="key-btn" onclick="App.typeKey('4')">4</button>
                    <button class="key-btn" onclick="App.typeKey('5')">5</button>
                    <button class="key-btn" onclick="App.typeKey('6')">6</button>
                    <button class="key-btn op" onclick="App.typeKey('/')">/</button>
                    <button class="key-btn" onclick="App.typeKey('7')">7</button>
                    <button class="key-btn" onclick="App.typeKey('8')">8</button>
                    <button class="key-btn" onclick="App.typeKey('9')">9</button>
                    <button class="key-btn op" onclick="App.typeKey('.')">.</button>
                    <button class="key-btn op" onclick="App.typeKey('$')">$</button>
                    <button class="key-btn" onclick="App.typeKey('0')">0</button>
                    <button class="key-btn op wide" onclick="App.typeKey('BACK')">&larr; Backspace</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="feedback-overlay"></div>

<script>
// ==========================================
// 1. PROCEDURAL ENGINE & STEM MATRIX
// ==========================================
const Utils = {
    rInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
    pick: (arr) => arr[Math.floor(Math.random() * arr.length)],
    shuffle: (arr) => arr.sort(() => Math.random() - 0.5),
    
    // Syntactic Stems for Math Generation
    genContext: () => Utils.pick([
        { type: "money", n: Utils.pick(["Leo","Mia","Sam"]), act1: "earned", unit: "$", per: "per hour", act2: "spent", isSub: true },
        { type: "distance", n: Utils.pick(["Zoe","David","Chloe"]), act1: "ran", unit: "miles", per: "per day", act2: "walked back", isSub: true },
        { type: "inventory", n: Utils.pick(["Carlos","Emma","Jamal"]), act1: "bought boxes of", unit: "stickers", per: "per box", act2: "was given more", isSub: false }
    ]),

    genOpts: (corr, genFn) => {
        const s = new Set([corr.toString()]);
        let failsafe = 0;
        while(s.size < 4 && failsafe < 100) { s.add(genFn().toString()); failsafe++; }
        let fall = 1; while(s.size < 4) { s.add((parseInt(corr)||0 + fall).toString()); fall++; }
        return Array.from(s).sort(() => Math.random() - 0.5).map(x => ({t:x, c:x===corr.toString()}));
    }
};

// ==========================================
// 2. TEI RENDERER (Part A / Part B Native)
// ==========================================
const TEI = {
    barGraph: (a, b) => {
        const max = Math.max(a,b) + 3; const step = 150/max;
        let s = `<line x1="30" y1="180" x2="170" y2="180" stroke="#333" stroke-width="2"/><line x1="30" y1="10" x2="30" y2="180" stroke="#333" stroke-width="2"/>`;
        s += `<rect id="barA" x="50" y="180" width="40" height="0" fill="#003366" /><text x="70" y="195" text-anchor="middle" font-weight="bold">Item 1</text>`;
        for(let i=1; i<=max; i++) s += `<g class="bar-zone" onclick="document.getElementById('barA').setAttribute('height', ${i*step}); document.getElementById('barA').setAttribute('y', ${180-i*step}); App.data.a=${i}; App.enableBtn();"><rect x="50" y="${180-i*step}" width="40" height="${step}" fill="transparent" stroke="#ccc" stroke-dasharray="2" /></g>`;
        s += `<rect id="barB" x="110" y="180" width="40" height="0" fill="#ff9900" /><text x="130" y="195" text-anchor="middle" font-weight="bold">Item 2</text>`;
        for(let i=1; i<=max; i++) s += `<g class="bar-zone" onclick="document.getElementById('barB').setAttribute('height', ${i*step}); document.getElementById('barB').setAttribute('y', ${180-i*step}); App.data.b=${i}; App.enableBtn();"><rect x="110" y="${180-i*step}" width="40" height="${step}" fill="transparent" stroke="#ccc" stroke-dasharray="2" /></g>`;
        for(let i=0; i<=max; i+=2) s += `<text x="25" y="${180-i*step + 5}" font-size="12" text-anchor="end">${i}</text>`;
        return `<svg width="100%" height="250" viewBox="0 0 200 200">${s}</svg><p style="color:#666;font-size:0.9rem;text-align:center;">(Click grid lines to build graph)</p>`;
    },
    dropdown: (id, parts) => { 
        return parts.map(p => {
            if(p.opts) {
                const options = `<option value="">[ Select ]</option>` + p.opts.map(o => `<option value="${o}">${o}</option>`).join('');
                return `<select class="inline-drop drop-${id}" data-c="${p.c}" onchange="App.enableBtn()">${options}</select>`;
            }
            return `<span>${p.t}</span>`;
        }).join('');
    },
    geoSym: (type) => {
        const s = 'fill="#e6f0fa" stroke="#003366" stroke-width="3"';
        const line = `<line x1="50" y1="5" x2="50" y2="95" stroke="red" stroke-width="4" stroke-dasharray="6"/>`;
        if(type === 'half-rect') return `<svg width="100" height="100"><rect x="10" y="30" width="40" height="40" ${s}/>${line}</svg>`;
        if(type === 'full-rect') return `<svg width="100" height="100"><rect x="10" y="30" width="80" height="40" ${s}/>${line}</svg>`;
        if(type === 'wrong-rect') return `<svg width="100" height="100"><rect x="10" y="30" width="40" height="40" ${s}/><rect x="50" y="10" width="40" height="40" ${s}/>${line}</svg>`;
        if(type === 'wrong-para') return `<svg width="100" height="100"><path d="M10 70 L50 70 L30 30 Z" ${s}/><path d="M90 70 L50 70 L70 30 Z" ${s}/>${line}</svg>`;
    },
    lShape: (w1,h1,w2,h2) => { const sc=25; return `<svg width="${(w1+w2)*sc+40}" height="${(h1+h2)*sc+40}"><path d="M20 20 H${20+w1*sc} V${20+h1*sc} H${20+(w1+w2)*sc} V${20+(h1+h2)*sc} H20 Z" fill="#e6f0fa" stroke="#003366" stroke-width="3"/><text x="${20+w1*sc/2}" y="15" text-anchor="middle" font-weight="bold">${w1}</text><text x="10" y="${20+(h1+h2)*sc/2}" text-anchor="middle" font-weight="bold">${h1+h2}</text><text x="${20+w1*sc+w2*sc/2}" y="${20+h1*sc-5}" text-anchor="middle" font-weight="bold">${w2}</text><text x="${20+(w1+w2)*sc+10}" y="${20+h1*sc+h2*sc/2}" text-anchor="middle" font-weight="bold">${h2}</text></svg>`; }
};

// ==========================================
// 3. MULTI-PART QUESTION BANK
// ==========================================
const Bank = {
    "MA.3.AR.1.2": { desc: "Multi-Step Word Problems", scenarios: [
        { gen: () => { 
            const ctx = Utils.genContext();
            const a = Utils.rInt(3,6), b = Utils.rInt(4,8), c = Utils.rInt(2,10);
            const total = a*b; const final = ctx.isSub ? total-c : total+c;
            return { 
                text: `<b>Multi-Step Scenario:</b><br>${ctx.n} ${ctx.act1} ${b} ${ctx.unit} ${ctx.per} for ${a} iterations. Then, they ${ctx.act2} ${c} ${ctx.unit}.`, 
                tasks: [
                    { id: "t1", type: "eq", label: "Part A", text: "How many did they have before the second action?", ans: total.toString() },
                    { id: "t2", type: "eq", label: "Part B", text: "What is the final amount?", ans: final.toString() }
                ]
            }; 
        }}
    ]},
    
    "MA.3.FR.2.2": { desc: "Fraction Equivalence & Justification", scenarios: [
        { gen: () => { 
            return { 
                left: `<div style="font-size:3rem; font-weight:bold; color:#003366; text-align:center; padding:50px;">2 / 4</div>`,
                text: `Analyze the fraction shown.`, 
                tasks: [
                    { id: "t1", type: "radio", label: "Part A", text: "Select the equivalent fraction.", options: Utils.shuffle([{t:"1/2",c:true},{t:"1/3",c:false},{t:"2/3",c:false},{t:"4/2",c:false}]) },
                    { id: "t2", type: "drop", label: "Part B", text: "Justify your answer.", html: TEI.dropdown('t2', [{t:"They are equal because the numerator and denominator were "}, {opts:["added by 2", "multiplied by the same amount", "swapped"], c:"multiplied by the same amount"}, {t:"."}]) }
                ]
            }; 
        }}
    ]},

    "MA.3.DP.1.1": { desc: "Data Analysis & Graphing", scenarios: [
        { gen: () => { 
            const a=Utils.rInt(3,6), b=Utils.rInt(2,5);
            let raw = []; for(let i=0;i<a;i++) raw.push("Item 1"); for(let i=0;i<b;i++) raw.push("Item 2"); raw=Utils.shuffle(raw);
            return { 
                left: `<div style="background:white; padding:20px; border:1px solid #ccc;"><b>Raw Data Log:</b><br><br>${raw.join(", ")}</div>`,
                text: `Process the raw data log.`, 
                tasks: [
                    { id: "t1", type: "eq", label: "Part A", text: "How many total items were recorded?", ans: (a+b).toString() },
                    { id: "t2", type: "interact", label: "Part B", text: "Build the graph to represent the data.", html: TEI.barGraph(a,b), check:()=>App.data.a===a && App.data.b===b }
                ]
            }; 
        }}
    ]},

    "MA.3.GR.2.4": { desc: "Composite Area (Reverse)", scenarios: [
        { gen: () => { 
            const w1=3, h1=4, w2=2, h2=3; const total = (w1*(h1+h2))+(w2*h2);
            return { 
                left: TEI.lShape(w1,h1,w2,h2),
                text: `<b>Reverse Engineering:</b> The total area of this entire figure is <b>${total}</b> square units.`, 
                tasks: [
                    { id: "t1", type: "eq", label: "Part A", text: "What is the area of the large left rectangle?", ans: (w1*(h1+h2)).toString() },
                    { id: "t2", type: "eq", label: "Part B", text: "Using the total, what must the area of the smaller right rectangle be?", ans: (w2*h2).toString() }
                ]
            }; 
        }}
    ]},

    "MA.3.GR.1.3": { desc: "Symmetry Completion", scenarios: [
        { gen: () => { 
            return { 
                left: TEI.geoSym('half-rect'),
                text: `The figure on the left is exactly half of a shape, split by a line of symmetry.`, 
                tasks: [
                    { id: "t1", type: "radio", label: "Part A", text: "Which image correctly completes the figure?", options: Utils.shuffle([{t:TEI.geoSym('full-rect'),c:true},{t:TEI.geoSym('wrong-rect'),c:false},{t:TEI.geoSym('wrong-para'),c:false},{t:TEI.geoSym('half-rect'),c:false}]) }
                ]
            }; 
        }}
    ]},

    "MA.3.NSO.1.1": { desc: "Word Form Distractors", scenarios: [
        { gen: () => { 
            const n=Utils.rInt(4000,9000) + Utils.rInt(10,50); // e.g. 4052
            return { 
                text: `Number Sense Mastery`, 
                tasks: [
                    { id: "t1", type: "radio", label: "Part A", text: `Select the exact word form for ${n}.`, options: Utils.genSmartOpts(Utils.numWords(n), 'word') }
                ]
            }; 
        }}
    ]}
};

// ==========================================
// 4. APP CONTROLLER (Multi-Task Renderer)
// ==========================================
const App = {
    currStd: null, currQ: null, score: 0, qCount: 1, history: {}, data: {}, activeInput: null,

    init: function() {
        const m = document.getElementById('menu');
        const order = ["MA.3.NSO", "MA.3.AR", "MA.3.FR", "MA.3.GR", "MA.3.DP"];
        order.forEach(prefix => {
            const h = document.createElement('div'); h.className = 'cat-title'; h.innerText = prefix; m.appendChild(h);
            Object.keys(Bank).filter(k => k.startsWith(prefix)).forEach(id => {
                const b = document.createElement('div'); b.className = 'std-btn';
                b.innerHTML = `<strong>${id}</strong><br><small>${Bank[id].desc}</small>`;
                b.onclick = () => { document.querySelectorAll('.std-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); App.startPractice(id); };
                m.appendChild(b);
            });
        });
    },

    startPractice: function(id) {
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('test-interface').style.display = 'flex';
        this.load(id);
    },

    startTest: function() {
        this.score = 0; this.qCount = 1;
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('test-interface').style.display = 'flex';
        this.nextTestQ();
    },

    exitToMenu: function() {
        document.getElementById('test-interface').style.display = 'none';
        document.getElementById('dashboard').style.display = 'flex';
    },

    nextTestQ: function() {
        this.load(Utils.pick(Object.keys(Bank)), true);
    },

    load: function(id, isTest=false) {
        this.currStd = id; this.data = {}; this.activeInput = null;
        document.getElementById('test-title').innerText = isTest ? `FAST Mock Test` : `Practice: ${id}`;
        document.getElementById('q-counter').innerText = `Q ${this.qCount}`;
        
        // Setup Procedural Scenario
        const count = Bank[id].scenarios.length;
        if (!this.history[id]) this.history[id] = [];
        let next; do { next = Math.floor(Math.random() * count); } while (this.history[id].includes(next) && this.history[id].length < count);
        this.history[id].push(next);
        if(this.history[id].length >= count) this.history[id] = []; 

        const q = Bank[id].scenarios[next].gen();
        this.currQ = q;

        // Reset UI
        const stim = document.getElementById('stimulus-pane');
        const resp = document.getElementById('q-response-area');
        const kp = document.getElementById('keypad-container');
        stim.innerHTML = ''; resp.innerHTML = ''; kp.style.display = 'none';
        
        if(q.left) { stim.innerHTML = q.left; stim.style.display = 'flex'; } else { stim.style.display = 'none'; }
        document.getElementById('q-text').innerHTML = q.text;

        // Render Multi-Task Array
        q.tasks.forEach(t => {
            const block = document.createElement('div'); block.className = 'task-block';
            block.innerHTML = `<div class="task-label">${t.label}</div><div style="margin-bottom:15px;">${t.text || ''}</div>`;
            
            if(t.type === 'radio' || t.type === 'multi') {
                const list = document.createElement('div'); list.className = t.options[0].t.includes('<svg') ? 'opt-list grid' : 'opt-list';
                t.options.forEach((o,i) => {
                    const el = document.createElement('div'); el.className = `opt-item`;
                    el.innerHTML = `<div class="opt-icon"></div> <div>${o.t}</div>`;
                    el.onclick = () => {
                        if(t.type === 'radio') { list.querySelectorAll('.opt-item').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); t.sel = i; } 
                        else { el.classList.toggle('selected'); o.sel = !o.sel; }
                        App.enableBtn();
                    };
                    list.appendChild(el);
                });
                block.appendChild(list);
            } 
            else if (t.type === 'eq') {
                block.innerHTML += `<input type="text" id="${t.id}" class="eq-input" placeholder="Tap to type..." onclick="App.setActive('${t.id}')" onkeyup="App.enableBtn()" readonly>`;
                kp.style.display = 'block'; 
            }
            else if (t.type === 'interact' || t.type === 'drop') {
                block.innerHTML += t.html;
            }
            resp.appendChild(block);
        });

        // Set initial focus for keypad if exists
        const firstEq = q.tasks.find(t => t.type === 'eq');
        if(firstEq) this.setActive(firstEq.id);

        document.getElementById('btn-check').innerText = "Submit & Next \u2192"; 
        document.getElementById('btn-check').disabled = true;
    },

    setActive: function(id) {
        document.querySelectorAll('.eq-input').forEach(el => el.classList.remove('active-focus'));
        const target = document.getElementById(id);
        if(target) { target.classList.add('active-focus'); this.activeInput = target; }
    },

    typeKey: function(k) {
        if(!this.activeInput) return;
        if(k === 'BACK') this.activeInput.value = this.activeInput.value.slice(0,-1);
        else this.activeInput.value += k;
        App.enableBtn();
    },

    enableBtn: function() { document.getElementById('btn-check').disabled = false; },

    check: function() {
        let allOk = true; 
        
        this.currQ.tasks.forEach(t => {
            let ok = false;
            if(t.type === 'radio') ok = t.options[t.sel] && t.options[t.sel].c;
            if(t.type === 'eq') ok = document.getElementById(t.id).value.trim() === t.ans;
            if(t.type === 'interact') ok = t.check();
            if(t.type === 'drop') {
                const sels = document.querySelectorAll(`.drop-${t.id}`); ok = true;
                sels.forEach(s => { if(s.value !== s.dataset.c) ok = false; });
            }
            if(!ok) allOk = false;
        });

        const fb = document.getElementById('feedback-overlay');
        fb.className = allOk ? 'correct-fb' : 'wrong-fb';
        fb.innerText = allOk ? "Correct!" : "Incorrect. Try again or skip.";
        fb.style.display = 'block';
        setTimeout(() => { fb.style.display = 'none'; }, 1500);

        if(allOk) {
            this.score++; this.qCount++;
            setTimeout(() => { this.load(this.currStd); }, 1500);
        }
    }
};

App.init();
</script>
</body>
</html>
