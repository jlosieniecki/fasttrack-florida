<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FAST Grade 3 - Official Blue</title>
    <style>
        /* --- RESET & BASICS --- */
        body { margin: 0; padding: 0; font-family: 'Arial', sans-serif; background-color: #f0f0f0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        button { cursor: pointer; border: none; outline: none; }
        
        /* --- COLORS (Hardcoded for Safety) --- */
        .bg-blue { background-color: #003057; color: white; } /* FL Deep Blue */
        .bg-light { background-color: #ffffff; color: #333; }
        .text-blue { color: #003057; font-weight: bold; }
        
        /* --- SCREENS --- */
        .screen { display: none; height: 100%; width: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* --- MENU SCREEN --- */
        .menu-header { padding: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .menu-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .menu-card { background: white; width: 100%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 20px; }
        .card-header { background: #00609C; color: white; padding: 15px; font-size: 1.1em; font-weight: bold; }
        .card-content { padding: 15px; }

        .btn-main { width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; color: white; background: #003057; border-radius: 5px; margin-bottom: 15px; border: 2px solid #003057; }
        .btn-main:hover { background: #004a80; }

        .btn-sub { width: 100%; padding: 12px; text-align: left; background: white; border-bottom: 1px solid #eee; color: #444; font-size: 0.95em; }
        .btn-sub:hover { background: #eef6ff; color: #00609C; font-weight: bold; }

        /* --- TEST SCREEN --- */
        .top-bar { height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: #fff; border-bottom: 2px solid #003057; }
        
        .main-stage { flex: 1; display: flex; overflow: hidden; background: #e9e9e9; padding: 10px; }
        .split-container { display: flex; width: 100%; height: 100%; gap: 10px; }
        
        .pane { background: white; border-radius: 5px; border: 1px solid #ccc; overflow-y: auto; padding: 20px; }
        .pane-left { width: 40%; display: flex; justify-content: center; align-items: center; background: #fdfdfd; }
        .pane-right { width: 60%; }
        
        /* Mobile Stack */
        @media (max-width: 700px) {
            .split-container { flex-direction: column; }
            .pane-left { width: 100%; height: 35%; border-bottom: 2px solid #003057; }
            .pane-right { width: 100%; height: 65%; }
        }

        .nav-bar { height: 60px; background: #ddd; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; border-top: 1px solid #999; }
        .btn-nav { padding: 10px 25px; font-weight: bold; border-radius: 4px; border: 1px solid #555; background: white; }
        .btn-nav.primary { background: #003057; color: white; border-color: #003057; }

        /* --- ITEM STYLES --- */
        .q-tag { display: inline-block; background: #eee; padding: 4px 8px; font-size: 0.8em; border-radius: 3px; margin-bottom: 10px; color: #555; }
        .prompt { font-size: 1.3em; margin-bottom: 20px; line-height: 1.5; }

        /* Rounding Table */
        .round-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .round-table th { background: #003057; color: white; padding: 10px; }
        .round-table td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        .table-input { width: 90%; padding: 8px; font-size: 1.1em; text-align: center; border: 2px solid #555; border-radius: 4px; }

        /* Hot Text */
        .hot-box { font-size: 1.4em; padding: 20px; border: 2px dashed #ccc; background: #fff; line-height: 2.2; border-radius: 5px; }
        .hot-word { padding: 5px 8px; border: 2px solid transparent; border-radius: 4px; cursor: pointer; margin: 0 2px; }
        .hot-word:hover { background: #eee; }
        .hot-word.selected { background: #fff2cc; border-color: #003057; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Graphing */
        svg { width: 100%; max-height: 300px; display: block; }
        .bar { cursor: pointer; transition: 0.2s; }
        .bar:hover { opacity: 0.8; }

        /* Multiselect */
        .opt-row { display: flex; align-items: center; padding: 15px; border: 1px solid #ccc; margin-bottom: 8px; background: white; cursor: pointer; border-radius: 4px; }
        .opt-row.selected { background: #e3f2fd; border: 2px solid #003057; }
        .chk { width: 20px; height: 20px; border: 2px solid #555; margin-right: 15px; background: white; }
        .selected .chk { background: #003057; border-color: #003057; }

        /* Editing */
        .drop-select { font-size: 1em; padding: 5px; border: 2px solid #003057; background: #eef; font-weight: bold; border-radius: 4px; }

        /* Eq Editor */
        .eq-input { font-size: 1.5em; padding: 10px; width: 150px; text-align: center; border: 2px solid #000; border-radius: 5px; display: block; margin: 10px auto; }
    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <div class="menu-header bg-blue">
            <h1>FAST G3 Mathematics</h1>
            <p>Official Item Types ‚Ä¢ High Contrast</p>
        </div>
        <div class="menu-body">
            <div class="menu-card">
                <div class="card-header">Start Assessment</div>
                <div class="card-content">
                    <button class="btn-main" onclick="startSession('ALL', 40)">üöÄ Full Mock Exam (40 Items)</button>
                    <p style="text-align:center; color:#666; margin-bottom:10px;">- OR SELECT SKILL -</p>
                    
                    <button class="btn-sub" onclick="startSession('MA.3.NSO.1.4', 5)">üî¢ Rounding (Multi-Part Table)</button>
                    <button class="btn-sub" onclick="startSession('MA.3.NSO.1.1', 5)">üî¢ Place Value (Hot Text)</button>
                    <button class="btn-sub" onclick="startSession('MA.3.NSO.1.2', 5)">üî¢ Composition (Editing)</button>
                    <button class="btn-sub" onclick="startSession('MA.3.FR.1.1', 5)">üçï Fraction Models</button>
                    <button class="btn-sub" onclick="startSession('MA.3.AR.1.1', 5)">üß† Properties (Matching)</button>
                    <button class="btn-sub" onclick="startSession('MA.3.DP.1.1', 5)">üìä Graphing (Interactive)</button>
                    <button class="btn-sub" onclick="startSession('MA.3.GR.1.2', 5)">üìê Geometry (Multiselect)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-test" class="screen">
        <div class="top-bar">
            <span class="text-blue">FAST Grade 3</span>
            <button onclick="location.reload()" style="background:none; border:1px solid #333; padding:5px 10px; border-radius:4px;">EXIT</button>
        </div>

        <div class="main-stage">
            <div id="split-view" class="split-container">
                </div>
        </div>

        <div class="nav-bar">
            <button class="btn-nav" onclick="navQ(-1)">BACK</button>
            <div style="font-weight:bold; font-size:1.2em;">Item <span id="cur-idx">1</span> / <span id="total-idx">40</span></div>
            <button class="btn-nav primary" onclick="navQ(1)" id="btn-next">NEXT</button>
        </div>
    </div>

    <script>
        // --- 1. HELPERS ---
        const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
        
        // --- 2. SVG DRAWING ---
        const SVG = {
            pie: (d, sel) => {
                let p="";
                for(let i=0; i<d; i++){
                    let s=(i*360/d-90)*Math.PI/180, e=((i+1)*360/d-90)*Math.PI/180;
                    let x1=50+45*Math.cos(s), y1=50+45*Math.sin(s), x2=50+45*Math.cos(e), y2=50+45*Math.sin(e);
                    let f = (sel||[]).includes(i) ? '#003057' : 'white';
                    p+=`<path d="M50,50 L${x1},${y1} A45,45 0 0,1 ${x2},${y2} Z" fill="${f}" stroke="#333" stroke-width="2" onclick="handlePie(${i})"/>`;
                }
                return `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="46" fill="white" stroke="#333" stroke-width="2"/>${p}</svg>`;
            },
            graph: (data, ans) => {
                let b="";
                data.labels.forEach((l,i)=>{
                    let v = (ans&&ans[i]!==undefined)?ans[i]:0;
                    let h = (v/data.max)*250;
                    b+=`<rect x="${50+i*80}" y="${280-h}" width="50" height="${h}" fill="#003057" stroke="#333" class="bar"/>`;
                    b+=`<text x="${75+i*80}" y="300" text-anchor="middle" font-weight="bold">${l}</text>`;
                    b+=`<text x="${75+i*80}" y="${270-h}" text-anchor="middle" fill="#003057" font-weight="bold">${v}</text>`;
                    b+=`<rect x="${50+i*80}" y="20" width="50" height="260" fill="transparent" onclick="handleGraph(${i}, ${data.step}, ${data.max})"/>`;
                });
                return `<svg viewBox="0 0 400 320"><line x1="30" y1="280" x2="380" y2="280" stroke="#333" stroke-width="3"/><line x1="30" y1="20" x2="30" y2="280" stroke="#333" stroke-width="3"/>${b}</svg>`;
            }
        };

        // --- 3. QUESTION GENERATORS ---
        const ENGINE = {
            "MA.3.NSO.1.4": () => { // ROUNDING TABLE
                const n = rand(1235, 8864);
                return {
                    id: "NSO14", cat: "MA.3.NSO.1.4", type: "TABLE",
                    prompt: `Round <b>${n.toLocaleString()}</b> to the nearest 10, 100, and 1,000.`,
                    data: { rows:[n.toLocaleString()], cols:["Nearest 10", "Nearest 100", "Nearest 1,000"], ans:[[Math.round(n/10)*10, Math.round(n/100)*100, Math.round(n/1000)*1000]] }
                };
            },
            "MA.3.NSO.1.1": () => { // HOT TEXT
                const n = rand(1000,9999); const d = n.toString().split('');
                return {
                    id: "NSO11", cat: "MA.3.NSO.1.1", type: "HOT_TEXT",
                    prompt: `Select the digit in the <b>hundreds</b> place.`,
                    data: { text: `The number is ${d[0]},${d[1]}${d[2]}${d[3]}`, chunks: d, ans: [1] }
                };
            },
            "MA.3.NSO.1.2": () => { // EDITING
                const n = rand(2100, 8900);
                return {
                    id: "NSO12", cat: "MA.3.NSO.1.2", type: "EDITING",
                    prompt: `Complete the sentence for <b>${n.toLocaleString()}</b>.`,
                    data: {
                        sentence: `${n} is composed of [DROP1] thousands and [DROP2] hundreds.`,
                        drops: [{opts:[Math.floor(n/1000), Math.floor(n/1000)-1]}, {opts:[Math.floor((n%1000)/100), Math.floor((n%1000)/100)+10]}]
                    }
                };
            },
            "MA.3.DP.1.1": () => { // GRAPHING
                const v=[rand(2,10), rand(2,10), rand(2,10)];
                return {
                    id: "DP11", cat: "MA.3.DP.1.1", type: "GRAPHING", layout: "split",
                    prompt: `Create a bar graph:<br><b>Red: ${v[0]}, Blue: ${v[1]}, Green: ${v[2]}</b>`,
                    data: { labels: ["Red", "Blue", "Green"], max: 12, step: 1, ans: v }
                };
            },
            "MA.3.FR.1.1": () => { // FRACTION
                const d=pick([4,6,8]); const n=rand(1, d-1);
                return {
                    id: "FR11", cat: "MA.3.FR.1.1", type: "FRACTION", layout: "split",
                    prompt: `Click to shade <b>${n}/${d}</b>.`,
                    data: { den: d, ans: n }
                };
            },
            "MA.3.AR.1.1": () => ({ // MATCHING
                id: "AR11", cat: "MA.3.AR.1.1", type: "MATCHING",
                prompt: "Match the equivalent expressions.",
                data: { rows: ["6 x 7", "6 x 4"], cols: ["(6x5)+(6x2)", "(6x2)+(6x2)"] }
            }),
            "MA.3.GR.1.2": () => ({ // MULTISELECT
                id: "GR12", cat: "MA.3.GR.1.2", type: "MULTISELECT",
                prompt: "Select <b>all</b> quadrilaterals.",
                opts: ["Square", "Triangle", "Trapezoid", "Circle", "Rhombus"]
            }),
            "AUTO": (id) => ({ // FALLBACK
                id: "AUTO", cat: id, type: "MULTISELECT", prompt: `Level 4 Question for ${id}`, opts: ["Option A", "Option B"]
            })
        };

        // --- 4. SESSION LOGIC ---
        let queue=[], cur=0, resp={};

        function startSession(id, count) {
            queue=[]; resp={}; cur=0;
            let keys = (id==='ALL') ? Object.keys(ENGINE).filter(k=>k!=='AUTO') : [id];
            for(let i=0; i<count; i++) {
                let k = pick(keys);
                queue.push( (ENGINE[k]||(()=>ENGINE.AUTO(k)))() );
            }
            document.getElementById('screen-menu').classList.remove('active');
            document.getElementById('screen-test').classList.add('active');
            document.getElementById('total-idx').innerText = queue.length;
            render();
        }

        function render() {
            let item = queue[cur];
            let ans = resp[cur];
            let sv = document.getElementById('split-view');
            
            // Generate Visual (Left Pane if Split)
            let vis = "";
            if(item.type === "GRAPHING") vis = SVG.graph(item.data, ans);
            else if(item.type === "FRACTION") vis = SVG.pie(item.data.den, ans);
            else if(item.type === "EQUATION") vis = `<div style="font-size:3em;text-align:center;padding:40px">?</div>`;

            let left = vis ? `<div class="pane pane-left">${vis}</div>` : "";
            let rightClass = vis ? "pane pane-right" : "pane";
            let rightStyle = vis ? "" : "width:100%";

            // Generate Interaction (Right Pane)
            let interact = `<div class="q-tag">${item.cat}</div><div class="prompt">${item.prompt}</div>`;
            
            if(item.type === "TABLE") {
                interact += `<table class="round-table"><thead><tr><th>Number</th>`;
                item.data.cols.forEach(c => interact+=`<th>${c}</th>`);
                interact += `</tr></thead><tbody>`;
                item.data.rows.forEach((r, ri) => {
                    interact+=`<tr><td>${r}</td>`;
                    item.data.cols.forEach((c, ci) => {
                        let v = (ans&&ans[ri]&&ans[ri][ci])?ans[ri][ci]:"";
                        interact+=`<td><input class="table-input" value="${v}" onchange="saveTable(${ri},${ci},this.value)"></td>`;
                    });
                    interact+=`</tr>`;
                });
                interact += `</tbody></table>`;
            }
            else if(item.type === "HOT_TEXT") {
                interact += `<div class="hot-box">The number is `;
                item.data.chunks.forEach((c,i)=>{
                    let s = (ans&&ans.includes(i))?'selected':'';
                    interact += `<span class="hot-word ${s}" onclick="saveHot(${i})">${c}</span>`;
                });
                interact += `</div>`;
            }
            else if(item.type === "EDITING") {
                let s = item.data.sentence;
                item.data.drops.forEach((d,i)=>{
                    let v = (ans&&ans[i])?ans[i]:"";
                    let sel = `<select class="drop-select" onchange="saveEdit(${i},this.value)"><option value="" disabled ${v===""?'selected':''}>Select...</option>`;
                    d.opts.forEach(o=>sel+=`<option value="${o}" ${v==o?'selected':''}>${o}</option>`);
                    sel+=`</select>`;
                    s = s.replace(`[DROP${i+1}]`, sel);
                });
                interact += `<div style="font-size:1.3em; line-height:2.0">${s}</div>`;
            }
            else if(item.type === "MULTISELECT") {
                item.opts.forEach((o,i)=>{
                    let s = (ans&&ans.includes(i))?'selected':'';
                    interact += `<div class="opt-row ${s}" onclick="saveMulti(${i})"><div class="chk ${s}"></div>${o}</div>`;
                });
            }
            else if(item.type === "MATCHING") {
                interact += `<table class="round-table"><thead><tr><th></th>`;
                item.data.cols.forEach(c=>interact+=`<th>${c}</th>`);
                interact+=`</tr></thead><tbody>`;
                item.data.rows.forEach((r,ri)=>{
                    interact+=`<tr><td><b>${r}</b></td>`;
                    item.data.cols.forEach((c,ci)=>{
                        let chk = (ans&&ans[ri]===ci)?'checked':'';
                        interact+=`<td><input type="radio" name="r${ri}" style="transform:scale(1.5)" ${chk} onclick="saveMatch(${ri},${ci})"></td>`;
                    });
                    interact+=`</tr>`;
                });
                interact+=`</tbody></table>`;
            }
            else if(item.type === "GRAPHING") interact += `<p>Click the columns on the left.</p>`;
            else if(item.type === "FRACTION") interact += `<p>Click the pie slices on the left.</p>`;

            sv.innerHTML = left + `<div class="${rightClass}" style="${rightStyle}">${interact}</div>`;
            document.getElementById('cur-idx').innerText = cur + 1;
            document.getElementById('btn-next').innerText = (cur === queue.length-1) ? "Submit" : "Next";
        }

        // --- SAVERS ---
        window.saveTable = (r,c,v) => { let a=resp[cur]||{}; if(!a[r])a[r]={}; a[r][c]=v; resp[cur]=a; };
        window.saveHot = (i) => { let a=resp[cur]||[]; if(a.includes(i)) a=a.filter(x=>x!==i); else a=[i]; resp[cur]=a; render(); };
        window.saveEdit = (i,v) => { let a=resp[cur]||{}; a[i]=v; resp[cur]=a; };
        window.saveMulti = (i) => { let a=resp[cur]||[]; if(a.includes(i)) a=a.filter(x=>x!==i); else a.push(i); resp[cur]=a; render(); };
        window.saveMatch = (r,c) => { let a=resp[cur]||{}; a[r]=c; resp[cur]=a; };
        window.handleGraph = (i,s,m) => { let a=resp[cur]||{}; let v=a[i]||0; v+=s; if(v>m) v=0; a[i]=v; resp[cur]=a; render(); };
        window.handlePie = (i) => { let a=resp[cur]||[]; if(a.includes(i)) a=a.filter(x=>x!==i); else a.push(i); resp[cur]=a; render(); };

        window.navQ = (d) => {
            if(cur+d >= 0 && cur+d < queue.length) { cur+=d; render(); }
            else if(cur+d === queue.length) { alert("Done!"); location.reload(); }
        };
    </script>
</body>
</html>
