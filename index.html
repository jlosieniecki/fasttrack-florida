<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAST Grade 3 Math | Ultimate TEI Simulator</title>
    <style>
        :root {
            --primary: #004d40; --secondary: #e65100; --bg: #f4f7f6; 
            --white: #ffffff; --border: #cfd8dc; --text: #263238;
            --correct: #c8e6c9; --wrong: #ffcdd2; --sel: #e0f2f1;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 350px; background: var(--white); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; height: 100vh; }
        .logo { padding: 25px; background: var(--primary); color: white; flex-shrink: 0; }
        .logo h1 { margin: 0; font-size: 1.3rem; letter-spacing: 0.5px; }
        .logo p { margin: 5px 0 0; font-size: 0.85rem; opacity: 0.9; }
        
        .test-btn {
            margin: 20px; padding: 15px; background: var(--secondary); color: white; text-align: center;
            border-radius: 6px; font-weight: bold; cursor: pointer; border: 2px solid #ef6c00;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1); transition: 0.2s; flex-shrink: 0;
        }
        .test-btn:hover { transform: translateY(-2px); }

        .menu { flex: 1; overflow-y: auto; padding: 0 10px 30px; }
        .cat-title { font-size: 0.8rem; text-transform: uppercase; color: #546e7a; font-weight: 800; margin: 25px 0 8px 5px; border-bottom: 2px solid #eceff1; padding-bottom: 5px; }
        .std-btn { display: block; width: 100%; text-align: left; padding: 10px; margin-bottom: 4px; background: transparent; border: 1px solid transparent; border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: #37474f; transition: 0.1s; }
        .std-btn:hover { background: #eceff1; }
        .std-btn.active { background: var(--sel); color: var(--primary); font-weight: bold; border-color: #b2dfdb; }
        .std-btn small { display: block; font-size: 0.75rem; margin-top: 2px; opacity: 0.75; font-weight: 400; }

        /* MAIN CONTENT */
        .main { flex: 1; display: flex; flex-direction: column; padding: 30px; overflow-y: auto; align-items: center; }
        .card { background: var(--white); padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); width: 100%; max-width: 900px; border-top: 6px solid var(--primary); min-height: 600px; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f5; padding-bottom: 15px; }
        .badge { background: #eceff1; padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; color: #455a64; }
        .score { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .q-text { font-size: 1.3rem; line-height: 1.6; margin-bottom: 30px; }

        /* TEI ZONES */
        .interactive-stage { background: #fafafa; border: 2px dashed #cfd8dc; border-radius: 8px; padding: 30px; margin-bottom: 30px; text-align: center; min-height: 200px; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .interactive-stage svg { max-width: 100%; height: auto; overflow: visible; }
        
        /* Interactive SVGs */
        .clk-slice { cursor: pointer; transition: 0.2s; }
        .clk-slice:hover { opacity: 0.8; stroke: var(--secondary); stroke-width: 3px; }
        .bar-zone { cursor: pointer; }
        .bar-zone:hover rect { fill: #b2dfdb; }

        /* Hot Text & Dropdown */
        .hot-text { cursor: pointer; padding: 4px 8px; border-radius: 4px; border: 2px solid transparent; margin: 0 4px; transition: 0.2s; background: #fff; font-weight: bold; color: #1976d2; text-decoration: underline; }
        .hot-text:hover { background: #e3f2fd; border-color: #90caf9; }
        .hot-text.selected { background: #1565c0; color: white; border-color: #0d47a1; text-decoration: none; }
        .inline-drop { padding: 6px 12px; font-size: 1.1rem; border: 2px solid #546e7a; border-radius: 6px; background: #f8f9fa; cursor: pointer; margin: 0 5px; font-weight: bold; }

        /* OPTIONS */
        .options-list { display: grid; gap: 15px; }
        .options-list.grid-2 { grid-template-columns: 1fr 1fr; }
        .opt-btn { display: flex; align-items: center; padding: 18px; border: 2px solid #e9ecef; border-radius: 8px; background: white; cursor: pointer; transition: 0.15s; font-size: 1.1rem; }
        .opt-btn:hover { background: #f8f9fa; border-color: #b0bec5; }
        .opt-btn.selected { background: var(--sel); border-color: var(--primary); box-shadow: inset 0 0 0 1px var(--primary); }
        .opt-btn.visual-mode { flex-direction: column; text-align: center; padding: 15px; height: 160px; justify-content: center; }
        .icon { width: 24px; height: 24px; border: 2px solid #6c757d; margin-right: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .multi .icon { border-radius: 4px; }
        .selected .icon { background: var(--primary); border-color: var(--primary); }
        .selected .icon::after { content: ''; width: 10px; height: 10px; background: white; border-radius: 50%; }
        .multi.selected .icon::after { content: '‚úî'; background: transparent; color: white; font-size: 16px; font-weight: bold; width: auto; height: auto; }

        /* EQ INPUT */
        .eq-input { width: 100%; padding: 15px; font-size: 1.5rem; border: 2px solid #546e7a; border-radius: 6px; outline: none; text-align: center; }
        .eq-input:focus { border-color: var(--primary); box-shadow: 0 0 5px rgba(0,77,64,0.3); }

        /* TABLE TEI */
        .tei-table { border-collapse: collapse; margin: 0 auto; font-size: 1.2rem; background: white; }
        .tei-table td, .tei-table th { border: 2px solid #cfd8dc; padding: 15px 30px; text-align: center; }
        .tei-table th { background: #eceff1; }
        .tei-table input { width: 80px; padding: 8px; font-size: 1.2rem; text-align: center; border: 2px solid #546e7a; border-radius: 4px; }

        /* FEEDBACK */
        .feedback { margin-top: 30px; padding: 20px; border-radius: 8px; display: none; font-size: 1.1rem; line-height: 1.5; }
        .feedback.correct { background: var(--correct); color: #1b5e20; border: 1px solid #a5d6a7; }
        .feedback.wrong { background: var(--wrong); color: #b71c1c; border: 1px solid #ef9a9a; }

        .btn { float: right; margin-top: 30px; padding: 15px 40px; background: var(--primary); color: white; border: none; border-radius: 6px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .btn:disabled { background: #cfd8dc; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">
        <h1>FAST Gr 3 Math</h1>
        <p>Level 5 TEI Engine</p>
    </div>
    <div class="test-btn" onclick="App.startTest()">üìù Start Mock FAST Test</div>
    <div class="menu" id="menu"></div>
</div>

<div class="main">
    <div class="card">
        <div class="header">
            <span class="badge" id="q-badge">System Ready</span>
            <span id="score" class="score">Score: 0</span>
        </div>
        
        <div id="q-content">
            <div class="q-text" id="q-text">
                Select a standard on the left to begin targeted practice, or click <strong>Start Mock FAST Test</strong> to generate a comprehensive, weighted blueprint exam.
            </div>
            <div class="interactive-stage" id="q-interact" style="display:none;"></div>
            <div class="options-list" id="q-options"></div>
        </div>

        <div class="feedback" id="feedback"></div>
        <button class="btn" id="btn-check" onclick="App.check()" disabled>Check Answer</button>
    </div>
</div>

<script>
// ==========================================
// 1. UTILITIES & ALGORITHMS
// ==========================================
const Utils = {
    rInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
    pick: (arr) => arr[Math.floor(Math.random() * arr.length)],
    shuffle: (arr) => arr.sort(() => Math.random() - 0.5),
    
    pickScenario: (count, lastIdx) => {
        if (count <= 1) return 0;
        let next;
        do { next = Math.floor(Math.random() * count); } while (next === lastIdx);
        return next;
    },

    genOpts: (corr, genFn) => {
        const s = new Set([corr.toString()]);
        let failsafe = 0;
        while(s.size < 4 && failsafe < 100) {
            const val = genFn().toString();
            if(val !== corr.toString()) s.add(val);
            failsafe++;
        }
        let fallback = 1;
        while(s.size < 4) {
            s.add((parseInt(corr) + fallback).toString());
            fallback++;
        }
        return Array.from(s).sort(() => Math.random() - 0.5).map(x => ({t:x, c:x===corr.toString()}));
    },

    numWords: (n) => {
        const o=['','one','two','three','four','five','six','seven','eight','nine'];
        const ty=['','','twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];
        const te=['ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'];
        if(n===0) return 'zero';
        let s='';
        if(n>=1000){s+=o[Math.floor(n/1000)]+' thousand '; n%=1000;}
        if(n>=100){s+=o[Math.floor(n/100)]+' hundred '; n%=100;}
        if(n>=20){s+=ty[Math.floor(n/10)]+(n%10!==0?' ':'')+o[n%10];}
        else if(n>=10){s+=te[n-10];}
        else if(n>0){s+=o[n];}
        return s.trim();
    }
};

// ==========================================
// 2. TEI RENDERER (Dynamic HTML/SVG)
// ==========================================
const TEI = {
    dropdown: (parts) => { 
        return parts.map(p => {
            if(p.opts) {
                const options = `<option value="">[ Select ]</option>` + p.opts.map(o => `<option value="${o}">${o}</option>`).join('');
                return `<select class="inline-drop" data-c="${p.c}" onchange="App.enableBtn()">${options}</select>`;
            }
            return `<span>${p.t}</span>`;
        }).join('');
    },

    hotText: (parts) => { 
        return parts.map((p, i) => {
            if(p.hot) return `<span class="hot-text" id="hot-${i}" data-c="${p.c}" onclick="this.classList.toggle('selected'); App.enableBtn();">${p.t}</span>`;
            return `<span>${p.t}</span>`;
        }).join('');
    },

    fracCirc: (n, d) => {
        let p = '';
        for(let i=0; i<d; i++) {
            const start = (i*360)/d, end = ((i+1)*360)/d;
            const x1 = 100 + 90 * Math.sin(Math.PI*start/180), y1 = 100 - 90 * Math.cos(Math.PI*start/180);
            const x2 = 100 + 90 * Math.sin(Math.PI*end/180), y2 = 100 - 90 * Math.cos(Math.PI*end/180);
            p += `<path d="M100 100 L${x1} ${y1} A90 90 0 0 1 ${x2} ${y2} Z" fill="white" stroke="#333" stroke-width="2" class="clk-slice" onclick="this.setAttribute('fill', this.getAttribute('fill')==='white'?'#ff6f00':'white'); App.enableBtn();" />`;
        }
        return `<svg width="200" height="200" viewBox="0 0 200 200"><circle cx="100" cy="100" r="90" fill="#fff"/>${p}</svg><br><small>(Click slices to shade)</small>`;
    },
    
    barGraph: (a, b) => {
        const max = Math.max(a,b) + 3; const step = 150/max;
        let s = `<line x1="30" y1="180" x2="170" y2="180" stroke="black" stroke-width="2"/><line x1="30" y1="10" x2="30" y2="180" stroke="black" stroke-width="2"/>`;
        s += `<rect id="barA" x="50" y="180" width="40" height="0" fill="#00838f" /><text x="70" y="195" text-anchor="middle">A</text>`;
        for(let i=1; i<=max; i++) s += `<g class="bar-zone" onclick="document.getElementById('barA').setAttribute('height', ${i*step}); document.getElementById('barA').setAttribute('y', ${180-i*step}); App.data.a=${i}; App.enableBtn();"><rect x="50" y="${180-i*step}" width="40" height="${step}" fill="transparent" stroke="#eee" stroke-dasharray="2" /></g>`;
        s += `<rect id="barB" x="110" y="180" width="40" height="0" fill="#ef6c00" /><text x="130" y="195" text-anchor="middle">B</text>`;
        for(let i=1; i<=max; i++) s += `<g class="bar-zone" onclick="document.getElementById('barB').setAttribute('height', ${i*step}); document.getElementById('barB').setAttribute('y', ${180-i*step}); App.data.b=${i}; App.enableBtn();"><rect x="110" y="${180-i*step}" width="40" height="${step}" fill="transparent" stroke="#eee" stroke-dasharray="2" /></g>`;
        return `<svg width="200" height="200" viewBox="0 0 200 200">${s}</svg><br><small>(Click above bars to set height)</small>`;
    },

    areaModel: (h, w1, w2) => `<svg width="${(w1+w2)*20+40}" height="${h*20+40}" viewBox="0 0 ${(w1+w2)*20+40} ${h*20+40}"><rect x="20" y="20" width="${w1*20}" height="${h*20}" fill="#b2dfdb" stroke="#004d40" stroke-width="2"/><text x="${20+(w1*20)/2}" y="${20+(h*20)/2+5}" text-anchor="middle" font-weight="bold">${h}x${w1}</text><rect x="${20+w1*20}" y="20" width="${w2*20}" height="${h*20}" fill="#ffe0b2" stroke="#ef6c00" stroke-width="2"/><text x="${20+w1*20+(w2*20)/2}" y="${20+(h*20)/2+5}" text-anchor="middle" font-weight="bold">${h}x${w2}</text></svg>`,
    lShape: (w1,h1,w2,h2) => { const sc=25; return `<svg width="${(w1+w2)*sc+40}" height="${(h1+h2)*sc+40}" viewBox="0 0 ${(w1+w2)*sc+40} ${(h1+h2)*sc+40}"><path d="M20 20 H${20+w1*sc} V${20+h1*sc} H${20+(w1+w2)*sc} V${20+(h1+h2)*sc} H20 Z" fill="#e0f2f1" stroke="#004d40" stroke-width="3"/><text x="${20+w1*sc/2}" y="15" text-anchor="middle" font-weight="bold">${w1}</text><text x="10" y="${20+(h1+h2)*sc/2}" text-anchor="middle" font-weight="bold">${h1+h2}</text><text x="${20+w1*sc+w2*sc/2}" y="${20+h1*sc-5}" text-anchor="middle" font-weight="bold">${w2}</text><text x="${20+(w1+w2)*sc+10}" y="${20+h1*sc+h2*sc/2}" text-anchor="middle" font-weight="bold">${h2}</text></svg>`; },
    rulerQuarter: (len) => { let t=''; for(let i=0;i<=5;i++){ t+=`<line x1="${10+i*40}" y1="30" x2="${10+i*40}" y2="50" stroke="black" stroke-width="2"/>`; if(i<5) t+=`<line x1="${30+i*40}" y1="35" x2="${30+i*40}" y2="50" stroke="black"/><line x1="${20+i*40}" y1="40" x2="${20+i*40}" y2="50" stroke="black"/><line x1="${40+i*40}" y1="40" x2="${40+i*40}" y2="50" stroke="black"/>`; t+=`<text x="${10+i*40}" y="25" text-anchor="middle" font-size="10">${i}</text>`; } return `<svg width="250" height="70"><rect x="10" y="50" width="220" height="15" fill="#eee" stroke="black"/><rect x="10" y="55" width="${len*40}" height="5" fill="#ffca28" stroke="black"/>${t}</svg>`; },
    thermometer: (v) => `<svg width="60" height="150"><rect x="20" y="10" width="20" height="120" rx="10" fill="#fff" stroke="#333" stroke-width="2"/><rect x="22" y="${130-v}" width="16" height="${v}" fill="#d32f2f"/><circle cx="30" cy="130" r="15" fill="#d32f2f"/><text x="45" y="25" font-size="10">100</text><text x="45" y="75" font-size="10">50</text><text x="45" y="125" font-size="10">0</text></svg>`,
    clock: (h,m) => { let t=''; for(let i=0;i<60;i++) t+=`<line x1="50" y1="6" x2="50" y2="${i%5?7:10}" transform="rotate(${i*6} 50 50)" stroke="#333" stroke-width="${i%5?1:2}"/>`; return `<svg width="150" height="150" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" stroke="#333" fill="#fff" stroke-width="2"/>${t}<line x1="50" y1="50" x2="50" y2="28" stroke="black" stroke-width="4" stroke-linecap="round" transform="rotate(${(h%12)*30+m*0.5} 50 50)"/><line x1="50" y1="50" x2="50" y2="15" stroke="#d32f2f" stroke-width="2" stroke-linecap="round" transform="rotate(${m*6} 50 50)"/><circle cx="50" cy="50" r="4"/></svg>`; },
    numLine: (t) => `<svg width="300" height="60"><line x1="20" y1="30" x2="280" y2="30" stroke="black" stroke-width="2"/><circle cx="150" cy="30" r="6" fill="#00695c"/><text x="150" y="50" text-anchor="middle" font-weight="bold">${t}</text><text x="20" y="50">${t-50}</text><text x="280" y="50">${t+50}</text></svg>`,
    geoShapes: (t, drawSym) => {
        const style = 'fill="#e0f2f1" stroke="#004d40" stroke-width="3"';
        const sym = drawSym ? `<line x1="50" y1="10" x2="50" y2="70" stroke="red" stroke-width="3" stroke-dasharray="5"/>` : '';
        if(t==='perp') return `<svg width="100" height="100"><line x1="50" y1="10" x2="50" y2="90" stroke="black" stroke-width="3"/><line x1="10" y1="50" x2="90" y2="50" stroke="black" stroke-width="3"/><rect x="50" y="50" width="10" height="10" fill="none" stroke="black"/></svg>`;
        if(t==='para') return `<svg width="100" height="100"><line x1="30" y1="20" x2="30" y2="80" stroke="black" stroke-width="3"/><line x1="70" y1="20" x2="70" y2="80" stroke="black" stroke-width="3"/></svg>`;
        if(t==='trap') return `<svg width="100" height="80"><path d="M20 60 L80 60 L70 20 L30 20 Z" ${style}/></svg>`;
        if(t==='rhomb') return `<svg width="100" height="80"><path d="M50 10 L80 40 L50 70 L20 40 Z" ${style}/></svg>`;
        if(t==='rect') return `<svg width="100" height="80"><rect x="10" y="20" width="80" height="40" ${style}/></svg>`;
        if(t==='tri') return `<svg width="100" height="80"><path d="M10 70 L90 70 L50 10 Z" ${style}/>${sym}</svg>`;
        return `<svg width="100" height="80"><rect x="30" y="20" width="40" height="40" ${style}/></svg>`; // Square
    },
    tiled: (w, h) => {
        let s=''; for(let i=0;i<w;i++) for(let j=0;j<h;j++) s+=`<rect x="${i*25}" y="${j*25}" width="25" height="25" fill="#e0f2f1" stroke="#004d40" stroke-width="1"/>`;
        return `<svg width="${w*25}" height="${h*25}">${s}</svg>`;
    }
};

// ==========================================
// 3. MASTER QUESTION BANK (All 34 Standards)
// ==========================================
const Bank = {
    // --- NUMBER SENSE (NSO) ---
    "MA.3.NSO.1.1": { desc: "Read/Write Numbers", scenarios: [
        { type: 'drop', gen: () => { const n=Utils.rInt(2000,9000), h=Math.floor((n%1000)/100); return { text:"Editing Task", html: TEI.dropdown([{t:`In the number ${n}, the value of the hundreds digit is `}, {opts:[h, h*10, h*100], c:h*100}, {t:"."}]), fb:`Digit ${h} in hundreds place = ${h*100}.` }; }},
        { type: 'hot', gen: () => { const n=Utils.rInt(1001,9999); return { text: `Select the value of the <strong>thousands digit</strong> in ${n}.`, html: TEI.hotText([{t:(Math.floor(n/1000)*100).toString(), hot:true, c:false}, {t:" , "}, {t:(Math.floor(n/1000)*1000).toString(), hot:true, c:true}]), fb: "Value = Digit x Place." }; }},
        { type: 'radio', gen: () => { const n=Utils.rInt(1000,9999); return { text: `Select the word form for ${n}.`, options: Utils.genOpts(Utils.numWords(n), ()=>Utils.numWords(Utils.rInt(1000,9999))), fb:"Check place values."}; }}
    ]},
    "MA.3.NSO.1.2": { desc: "Compose/Decompose", scenarios: [
        { type: 'eq', gen: () => { const h=Utils.rInt(1,5), t=Utils.rInt(12,35); return { text: `Level 5 Rigor: What number is equal to <strong>${h} hundreds and ${t} tens</strong>?`, ans: (h*100+t*10).toString(), fb:`Regroup: ${h}00 + ${t}0 = ${h*100+t*10}.`}; }},
        { type: 'radio', gen: () => { const n=Utils.rInt(2000,8000); return { text:`Which decomposition is equal to ${n}?`, options: Utils.shuffle([{t:`${Math.floor(n/1000)*1000} + ${n%1000}`,c:true},{t:`${n+100}`,c:false},{t:`${n*10}`,c:false},{t:`${n-100}`,c:false}]), fb:"Add the parts."}; }}
    ]},
    "MA.3.NSO.1.3": { desc: "Compare", scenarios: [
        { type: 'hot', gen: () => { const a=Utils.rInt(1000,4000), b=a+Utils.rInt(10,50); return { text: `Select the correct symbol: ${a} [ ? ] ${b}`, html: TEI.hotText([{t:" > ",hot:true,c:false},{t:" < ",hot:true,c:true},{t:" = ",hot:true,c:false}]), fb:`${a} is smaller.`}; }},
        { type: 'radio', gen: () => { const a=Utils.rInt(5000,9000), b=a-Utils.rInt(100,500); return { text: "Select the TRUE statement.", options: Utils.shuffle([{t:`${a} > ${b}`,c:true},{t:`${b} > ${a}`,c:false},{t:`${a} < ${b}`,c:false},{t:`${a} = ${b}`,c:false}]), fb:"Compare left to right."}; }}
    ]},
    "MA.3.NSO.1.4": { desc: "Rounding", scenarios: [
        { type: 'multi', gen: () => { const t=Utils.rInt(2,8)*100; return { text: `Select <strong>ALL</strong> numbers that round to ${t} (nearest 100).`, options: Utils.shuffle([{t:(t-10).toString(),c:true},{t:(t+40).toString(),c:true},{t:(t+60).toString(),c:false},{t:(t-60).toString(),c:false}]), fb:`Range is ${t-50} to ${t+49}.`}; }},
        { type: 'eq', gen: () => { const n=Utils.rInt(150,850); return { text:`Round ${n} to the nearest 100.`, ans: (Math.round(n/100)*100).toString(), fb:"5 or more rounds up."}; }}
    ]},
    "MA.3.NSO.2.1": { desc: "Add/Sub", scenarios: [
        { type: 'eq', gen: () => { const a=Utils.rInt(2000,5000), b=Utils.rInt(1000,1999); return { text: `Find the difference: ${a} - ${b} = ?`, ans: (a-b).toString(), fb:"Standard algorithm, regroup carefully."}; }},
        { type: 'radio', gen: () => { const a=Utils.rInt(1000,4000), b=Utils.rInt(1000,4000); return { text: `Student error analysis: A student added ${a} + ${b} and got ${(a+b)-100}. What mistake was likely made?`, options: Utils.shuffle([{t:"Failed to regroup the hundreds correctly.",c:true},{t:"Added the thousands place wrong.",c:false},{t:"Subtracted instead of adding.",c:false},{t:"No mistake, it is correct.",c:false}]), fb:"Check the hundreds place addition."}; }}
    ]},
    "MA.3.NSO.2.2": { desc: "Mult/Div Facts", scenarios: [
        { type: 'drop', gen: () => { const a=Utils.rInt(6,12), b=Utils.rInt(6,12); return { text:"Complete the related fact.", html: TEI.dropdown([{t:`If ${a} x ${b} = ${a*b}, then ${a*b} √∑ `},{opts:[a, a+1, a-1],c:a},{t:` = ${b}`}]), fb:"Fact families."}; }},
        { type: 'eq', gen: () => { const a=Utils.rInt(7,12), b=Utils.rInt(7,12); return { text: `Solve: ${a} x ${b} = ?`, ans: (a*b).toString(), fb:"Fact recall."}; }}
    ]},
    "MA.3.NSO.2.3": { desc: "Mult by 10s", scenarios: [
        { type: 'eq', gen: () => { const a=Utils.rInt(4,9), b=Utils.pick([20,30,40,50,60]); return { text: `Solve: ${a} x ${b} = ?`, ans: (a*b).toString(), fb:`Multiply ${a} x ${b/10}, then add 0.`}; }}
    ]},
    "MA.3.NSO.2.4": { desc: "Mult 1dx2d", scenarios: [
        { type: 'eq', gen: () => { const a=Utils.rInt(3,8), b=Utils.rInt(13,25); return { text: `A theater has ${b} rows. Each row has ${a} seats. How many seats total?`, ans:(a*b).toString(), fb:`${a} x ${b}.`}; }}
    ]},

    // --- ALGEBRA (AR) ---
    "MA.3.AR.1.1": { desc: "Distributive Prop", scenarios: [
        { type: 'radio', gen: () => { const a=Utils.rInt(4,9), b=Utils.rInt(12,18); return { text: `Which expression represents the Area Model for ${a} x ${b}?`, html: `<div class="interactive-stage">${TEI.areaModel(a,10,b-10)}</div>`, options: Utils.shuffle([{t:`(${a}x10) + (${a}x${b-10})`,c:true},{t:`${a} + 10 + ${b-10}`,c:false},{t:`(${a}x10) x (${a}x${b-10})`,c:false},{t:`${a} x 100`,c:false}]), fb:"Add the two sub-areas." }; }},
        { type: 'multi', gen: () => { const a=5, b=14; return { text: `Select ALL expressions equal to 5 x 14.`, options: Utils.shuffle([{t:"(5x10) + (5x4)",c:true},{t:"70",c:true},{t:"5 + 14",c:false},{t:"(5x10) x (5x4)",c:false}]), fb:"14 breaks into 10 and 4."}; }}
    ]},
    "MA.3.AR.1.2": { desc: "Multi-Step Word Probs", scenarios: [
        { type: 'eq', gen: () => { const a=Utils.rInt(3,6), b=Utils.rInt(4,8), c=Utils.rInt(2,10); return { text: `Level 5 Rigor: Jon buys ${a} packs of cards. Each pack has ${b} cards. He gives ${c} cards to his sister. How many does he have left?`, ans: ((a*b)-c).toString(), fb:`(${a} x ${b}) - ${c}.`}; }},
        { type: 'eq', gen: () => { const a=Utils.rInt(4,9), b=Utils.rInt(3,7); return { text: `There are ${a} tables. Each table has ${b} chairs. How many chairs total?`, ans: (a*b).toString(), fb:`${a} x ${b}.`}; }}
    ]},
    "MA.3.AR.2.1": { desc: "Inverse Ops", scenarios: [
        { type: 'hot', gen: () => { const a=Utils.rInt(6,9), p=a*Utils.rInt(6,9); return { text: `Select the equation that can be used to solve <strong>${p} √∑ ${a} = ?</strong>`, html: TEI.hotText([{t:`${a} x ? = ${p}`,hot:true,c:true},{t:" / "},{t:`${p} - ${a} = ?`,hot:true,c:false},{t:" / "},{t:`${a} + ? = ${p}`,hot:true,c:false}]), fb:"Multiplication is the inverse of division."}; }}
    ]},
    "MA.3.AR.2.2": { desc: "Equality", scenarios: [
        { type: 'drop', gen: () => { const a=Utils.rInt(4,8), b=Utils.rInt(4,8); return { text:"Make the equation true.", html: TEI.dropdown([{t:`${a} x ${b} = `},{opts:[a*b, a+b, a*b+1],c:a*b},{t:` + 0`}]), fb:"Both sides must equal the same amount."}; }}
    ]},
    "MA.3.AR.2.3": { desc: "Missing Factor", scenarios: [
        { type: 'eq', gen: () => { const a=Utils.rInt(6,9), p=a*Utils.rInt(4,9); return { text: `Find the missing factor: ${a} x [ ? ] = ${p}`, ans: (p/a).toString(), fb:`Divide ${p} by ${a}.`}; }}
    ]},
    "MA.3.AR.3.1": { desc: "Even/Odd", scenarios: [
        { type: 'table', gen: () => { const n1=Utils.rInt(10,30)*2, n2=Utils.rInt(10,30)*2+1; return { text:"Enter 'Even' or 'Odd'.", inputs:[n1, n2, n1+10], outputs:['Even','?','Even'], missing:1, ans:"Odd", fb:"Check the ones digit."}; }},
        { type: 'radio', gen: () => { const n=Utils.rInt(10,99); return { text:`Is <strong>${n}</strong> Even or Odd?`, options:[{t:"Even",c:n%2===0},{t:"Odd",c:n%2!==0}], fb:"Check ones place." }; }}
    ]},
    "MA.3.AR.3.2": { desc: "Multiples", scenarios: [
        { type: 'multi', gen: () => { const base = Utils.pick([3,4,6]); return { text: `Select ALL multiples of ${base}.`, options: Utils.shuffle([{t:(base*2).toString(),c:true},{t:(base*5).toString(),c:true},{t:(base*2+1).toString(),c:false},{t:(base*3-1).toString(),c:false}]), fb:`Count by ${base}s.`}; }}
    ]},
    "MA.3.AR.3.3": { desc: "Patterns", scenarios: [
        { type: 'eq', gen: () => { const rule=Utils.pick([4,5]); const input=Utils.rInt(6,9); return { text: `Rule: Multiply by ${rule}. If the input is ${input}, what is the output?`, ans:(rule*input).toString(), fb:`${input} x ${rule}.`}; }}
    ]},

    // --- FRACTIONS (FR) ---
    "MA.3.FR.1.1": { desc: "Visual Fractions", scenarios: [
        { type: 'interact', gen: () => { const d=Utils.pick([4,6,8]), n=Utils.rInt(1,d-1); return { text:`Shade the model to show <strong>${n}/${d}</strong>.`, html: TEI.fracCirc(n,d), check: ()=>document.querySelectorAll('path[fill="#ff6f00"]').length===n, fb:`Click exactly ${n} slices.`}; }}
    ]},
    "MA.3.FR.1.2": { desc: "Unit/Whole", scenarios: [
        { type: 'radio', gen: () => { return { text: "Which fraction is equal to exactly 1 whole?", options: Utils.shuffle([{t:"4/4",c:true},{t:"4/1",c:false},{t:"1/4",c:false},{t:"3/4",c:false}]), fb:"Numerator must equal denominator."}; }}
    ]},
    "MA.3.FR.1.3": { desc: "Word Form", scenarios: [
        { type: 'hot', gen: () => { return { text: "Select the fraction that represents <strong>'Five-Eighths'</strong>.", html: TEI.hotText([{t:"8/5",hot:true,c:false},{t:", "},{t:"5/8",hot:true,c:true},{t:", "},{t:"1/8",hot:true,c:false}]), fb:"5 on top, 8 on bottom."}; }}
    ]},
    "MA.3.FR.2.1": { desc: "Compare", scenarios: [
        { type: 'radio', gen: () => { const d1=Utils.pick([3,4]), d2=Utils.pick([6,8]); return { text: `Compare: 1/${d1} and 1/${d2}.`, options: Utils.shuffle([{t:`1/${d1} > 1/${d2}`,c:true},{t:`1/${d1} < 1/${d2}`,c:false},{t:`1/${d1} = 1/${d2}`,c:false}]), fb:"Smaller denominator = larger piece."}; }}
    ]},
    "MA.3.FR.2.2": { desc: "Equivalence", scenarios: [
        { type: 'multi', gen: () => { return { text: "Select ALL fractions equal to 1/2.", options: Utils.shuffle([{t:"2/4",c:true},{t:"3/6",c:true},{t:"4/8",c:true},{t:"1/3",c:false}]), fb:"Top must be half of bottom."}; }}
    ]},

    // --- GEOMETRY (GR) ---
    "MA.3.GR.1.1": { desc: "Points/Lines", scenarios: [
        { type: 'radio', gen: () => { return { text: "Which image shows <strong>Perpendicular Lines</strong>?", type:'visual-mode', options: Utils.shuffle([{t:TEI.geoShapes('perp'),c:true},{t:TEI.geoShapes('para'),c:false},{t:TEI.geoShapes('trap'),c:false},{t:TEI.geoShapes('tri'),c:false}]), fb:"They intersect at 90-degree right angles."}; }},
        { type: 'hot', gen: () => { return { text: "Select the term for a line with one endpoint and one arrow.", html: TEI.hotText([{t:"Line Segment",hot:true,c:false},{t:" / "},{t:"Ray",hot:true,c:true},{t:" / "},{t:"Line",hot:true,c:false}]), fb:"Rays start at a point and go forever in one direction."}; }}
    ]},
    "MA.3.GR.1.2": { desc: "Attributes", scenarios: [
        { type: 'multi', gen: () => { return { text: "Select ALL shapes that MUST have 4 right angles by definition.", options: Utils.shuffle([{t:"Square",c:true},{t:"Rectangle",c:true},{t:"Rhombus",c:false},{t:"Trapezoid",c:false}]), fb:"Squares and Rectangles."}; }},
        { type: 'radio', gen: () => { return { text: "Click the shape that is a Rhombus.", type:'visual-mode', options: Utils.shuffle([{t:TEI.geoShapes('rhomb'),c:true},{t:TEI.geoShapes('rect'),c:false},{t:TEI.geoShapes('trap'),c:false},{t:TEI.geoShapes('tri'),c:false}]), fb:"Rhombus has 4 equal sides."}; }}
    ]},
    "MA.3.GR.1.3": { desc: "Symmetry", scenarios: [
        { type: 'radio', gen: () => { return { text: "Which figure shows a correct line of symmetry?", type:'visual-mode', options: Utils.shuffle([{t:TEI.geoShapes('tri',true),c:true},{t:TEI.geoShapes('trap',true),c:false},{t:TEI.geoShapes('rect',true),c:true}]).slice(0,2), fb:"The line must cut the shape into perfect mirror images."}; }}
    ]},
    "MA.3.GR.2.1": { desc: "Area", scenarios: [
        { type: 'eq', gen: () => { const w=Utils.rInt(4,7), h=Utils.rInt(3,5); return { text: "Find the Area of the rectangle.", html:`<div class="interactive-stage">${TEI.tiled(w,h)}</div>`, ans:(w*h).toString(), fb:"Count the squares or multiply length x width."}; }}
    ]},
    "MA.3.GR.2.2": { desc: "Distributive Area", scenarios: [
        { type: 'radio', gen: () => { const a=Utils.rInt(4,8), b=Utils.rInt(12,15); return { text: `Which shows the area of a ${a}x${b} rectangle broken apart?`, options: Utils.shuffle([{t:`(${a}x10) + (${a}x${b-10})`,c:true},{t:`${a}+10+${b-10}`,c:false},{t:`(${a}x10) x (${a}x${b-10})`,c:false},{t:`${a}x10`,c:false}]), fb:"Decompose the larger number."}; }}
    ]},
    "MA.3.GR.2.3": { desc: "Perimeter", scenarios: [
        { type: 'eq', gen: () => { const w=Utils.rInt(4,9), h=Utils.rInt(4,9); return { text: `A rectangle has a length of ${w} and width of ${h}. What is its perimeter?`, ans:(2*w+2*h).toString(), fb:`${w}+${w}+${h}+${h}.`}; }},
        { type: 'eq', gen: () => { const w=Utils.rInt(3,7), l=Utils.rInt(5,9), p=2*w+2*l; return { text: `Level 5 Rigor: The perimeter of a rectangle is ${p}. The width is ${w}. What is the length?`, ans:l.toString(), fb:`Subtract 2 widths (${w*2}) from ${p}, then divide by 2.`}; }}
    ]},
    "MA.3.GR.2.4": { desc: "Composite Area", scenarios: [
        { type: 'eq', gen: () => { const w1=Utils.rInt(3,6), h1=Utils.rInt(4,8), w2=Utils.rInt(2,5), h2=Utils.rInt(2,4); return { text: "Level 5 Rigor: Find the Total Area of this composite figure.", html: `<div class="interactive-stage">${TEI.lShape(w1,h1,w2,h2)}</div>`, ans:((w1*(h1+h2))+(w2*h2)).toString(), fb:"Decompose the shape into two rectangles."}; }}
    ]},

    // --- MEASUREMENT (M) ---
    "MA.3.M.1.1": { desc: "Tools", scenarios: [
        { type: 'radio', gen: () => { const l=Utils.pick([2.25, 3.5, 4.75]); return { text: "To the nearest quarter inch, what is the length?", html: `<div class="interactive-stage">${TEI.rulerQuarter(l)}</div>`, options: Utils.shuffle([{t:`${l} in`,c:true},{t:`${l+0.25} in`,c:false},{t:`${Math.floor(l)} in`,c:false},{t:`${l-0.25} in`,c:false}]), fb:"Check the small tick marks."}; }},
        { type: 'eq', gen: () => { const t=Utils.pick([30,60,90]); return { text: "What is the temperature in degrees?", html:`<div class="interactive-stage">${TEI.thermometer(t)}</div>`, ans:t.toString(), fb:"Read the red line."}; }}
    ]},
    "MA.3.M.1.2": { desc: "Mass/Vol Probs", scenarios: [
        { type: 'eq', gen: () => { const w=Utils.rInt(6,12), c=Utils.rInt(3,7); return { text: `One water jug holds ${w} Liters. How many Liters in ${c} jugs?`, ans:(w*c).toString(), fb:`${w} x ${c}.`}; }}
    ]},
    "MA.3.M.2.1": { desc: "Time", scenarios: [
        { type: 'radio', gen: () => { const h=Utils.rInt(1,11), m=Utils.pick([15,30,45]); return { text: "What time is shown on the clock?", html: `<div class="interactive-stage">${TEI.clock(h,m)}</div>`, options: Utils.shuffle([{t:`${h}:${m}`,c:true},{t:`${h+1}:${m}`,c:false},{t:`${h}:${m===15?45:15}`,c:false},{t:`${h===1?12:h-1}:${m}`,c:false}]), fb:"Short hand is hour, long hand is minutes."}; }}
    ]},
    "MA.3.M.2.2": { desc: "Elapsed Time", scenarios: [
        { type: 'eq', gen: () => { const s=Utils.rInt(1,5), e=Utils.pick([15,25,35,45]); return { text: `A class starts at ${s}:00 and ends at ${s}:${e}. How many minutes did it last?`, ans:e.toString(), fb:`${e} - 0 = ${e}.`}; }}
    ]},

    // --- DATA (DP) ---
    "MA.3.DP.1.1": { desc: "Graphing", scenarios: [
        { type: 'interact', gen: () => { const a=Utils.rInt(3,7), b=Utils.rInt(3,7); return { text: `Create a bar graph where <strong>A = ${a}</strong> and <strong>B = ${b}</strong>.`, html: TEI.barGraph(a,b), check:()=>App.data.a===a && App.data.b===b, fb:`Click to adjust the bars.`}; }}
    ]},
    "MA.3.DP.1.2": { desc: "Interpret", scenarios: [
        { type: 'eq', gen: () => { const k=Utils.pick([2,5,10]), count=Utils.rInt(3,8); return { text: `In a pictograph, the key says 1 Circle = ${k} students. If there are ${count} circles for Class A, how many students are in Class A?`, ans:(k*count).toString(), fb:`${count} circles x ${k}.`}; }}
    ]}
};

// ==========================================
// 4. APP CONTROLLER
// ==========================================
const App = {
    currStd: null, currQ: null, score: 0, mode: 'practice',
    history: {}, data: {}, 

    init: function() {
        const m = document.getElementById('menu');
        const order = ["MA.3.NSO", "MA.3.AR", "MA.3.FR", "MA.3.GR", "MA.3.M", "MA.3.DP"];
        
        order.forEach(prefix => {
            const h = document.createElement('div'); h.className = 'cat-title'; 
            h.innerText = prefix.replace("MA.3.",""); m.appendChild(h);
            
            Object.keys(Bank).filter(k => k.startsWith(prefix)).forEach(id => {
                const b = document.createElement('div');
                b.className = 'std-btn';
                b.innerHTML = `<strong>${id}</strong><br><small>${Bank[id].desc}</small>`;
                b.onclick = () => { document.querySelectorAll('.std-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); App.load(id); };
                m.appendChild(b);
            });
        });
    },

    startTest: function() {
        this.mode = 'test'; this.score = 0;
        document.getElementById('q-badge').innerText = "Mock FAST Test";
        document.getElementById('score').innerText = "Score: 0";
        document.querySelectorAll('.std-btn').forEach(x=>x.classList.remove('active'));
        this.nextTestQ();
    },

    nextTestQ: function() {
        // FAST Blueprint Weights: ~25% NSO, ~25% AR, ~25% FR, ~25% GR/M/DP
        const r = Math.random();
        let p = "MA.3.NSO";
        if(r > 0.25) p = "MA.3.AR";
        if(r > 0.50) p = "MA.3.FR";
        if(r > 0.75) p = Utils.pick(["MA.3.GR", "MA.3.M", "MA.3.DP"]);
        
        const keys = Object.keys(Bank).filter(k => k.startsWith(p));
        this.load(Utils.pick(keys), true);
    },

    load: function(id, isTest=false) {
        if(!isTest) this.mode = 'practice';
        this.currStd = id;
        this.data = {};
        
        const count = Bank[id].scenarios.length;
        const last = this.history[id] !== undefined ? this.history[id] : -1;
        const next = Utils.pickScenario(count, last);
        this.history[id] = next;

        const q = Bank[id].scenarios[next].gen();
        this.currQ = q; 
        this.currQ.type = Bank[id].scenarios[next].type;

        // Render UI
        document.getElementById('q-badge').innerText = isTest ? `Test Mode: ${id}` : id;
        document.getElementById('q-text').innerHTML = q.text;
        
        const interact = document.getElementById('q-interact');
        const opts = document.getElementById('q-options');
        interact.style.display = 'none'; opts.innerHTML = '';

        if(q.html) { interact.style.display = 'flex'; interact.innerHTML = q.html; }

        if(q.type === 'radio' || q.type === 'multi') {
            if(q.options[0].t.includes('<svg')) opts.classList.add('grid-2'); else opts.classList.remove('grid-2');
            
            q.options.forEach((o,i) => {
                const el = document.createElement('div');
                el.className = o.t.includes('<svg') ? `opt-btn visual-mode ${this.currQ.type}` : `opt-btn ${this.currQ.type}`;
                el.innerHTML = `<div class="icon"></div> <div>${o.t}</div>`;
                el.onclick = () => {
                    if(q.type === 'radio') {
                        document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
                        el.classList.add('selected');
                        App.sel = i;
                    } else {
                        el.classList.toggle('selected');
                        o.sel = !o.sel;
                    }
                    App.enableBtn();
                };
                opts.appendChild(el);
            });
        } else if (this.currQ.type === 'eq') {
            opts.innerHTML = `<input type="text" id="inp" class="eq-input" placeholder="Type answer here..." onkeyup="App.enableBtn()">`;
            opts.classList.remove('grid-2');
        } else if (this.currQ.type === 'table') {
            let h = `<table class="tei-table"><tr><th>In</th><th>Out</th></tr>`;
            q.inputs.forEach((val, i) => { h += `<tr><td>${val}</td><td>${i === q.missing ? `<input id="inp" type="number" onkeyup="App.enableBtn()">` : q.outputs[i]}</td></tr>`; });
            opts.innerHTML = h + `</table>`;
            opts.classList.remove('grid-2');
        } else if (this.currQ.type === 'drop') {
            opts.innerHTML = q.html;
            opts.classList.remove('grid-2');
        }

        document.getElementById('feedback').style.display = 'none';
        const btn = document.getElementById('btn-check');
        btn.innerText = "Check Answer"; btn.disabled = true;
        btn.onclick = () => App.check();
    },

    enableBtn: function() { document.getElementById('btn-check').disabled = false; },

    check: function() {
        let ok = false;
        const q = this.currQ;
        
        if(q.type === 'radio') ok = q.options[App.sel].c;
        if(q.type === 'multi') ok = q.options.every(o => !!o.sel === o.c);
        if(q.type === 'eq' || q.type === 'table') ok = document.getElementById('inp').value.trim() === q.ans;
        if(q.type === 'interact') ok = q.check();
        if(q.type === 'hot') {
            const spans = document.querySelectorAll('.hot-text');
            ok = true;
            spans.forEach(s => { if(s.classList.contains('selected') !== (s.dataset.c === "true")) ok = false; });
        }
        if(q.type === 'drop') {
            const sels = document.querySelectorAll('.inline-drop');
            ok = true;
            sels.forEach(s => { if(s.value !== s.dataset.c) ok = false; });
        }

        const fb = document.getElementById('feedback');
        fb.style.display = 'block';
        fb.className = `feedback ${ok?'correct':'wrong'}`;
        fb.innerHTML = `<strong>${ok?'Correct!':'Incorrect.'}</strong> ${q.fb}`;
        
        if(ok) document.getElementById('score').innerText = `Score: ${++this.score}`;
        
        const btn = document.getElementById('btn-check');
        btn.innerText = "Next Question";
        btn.onclick = () => this.mode === 'test' ? this.nextTestQ() : this.load(this.currStd);
    }
};

App.init();
</script>
</body>
</html>
