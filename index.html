<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAST Math Accelerated | Ultimate Simulator 4.0</title>
    <style>
        :root {
            --primary: #005ea2; /* FL DOE Blue */
            --dark: #1b1b1b;
            --light: #f4f6f8;
            --correct: #2e8540;
            --incorrect: #cd2026;
            --warning: #e5a000;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- NAVIGATION --- */
        .top-bar {
            background: white;
            border-bottom: 3px solid #000;
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .logo { font-size: 1.2rem; font-weight: 800; color: var(--primary); }
        .session-info { font-weight: 600; }

        .toolbar { display: flex; gap: 10px; }
        .tool-btn {
            background: white; border: 1px solid #333; padding: 5px 12px;
            border-radius: 4px; cursor: pointer; font-size: 0.9rem;
        }
        .tool-btn:hover { background: #eee; }

        /* --- SCREENS --- */
        .screen { display: none; height: 100%; overflow-y: auto; padding: 20px; }
        .screen.active { display: block; }

        /* --- DASHBOARD --- */
        .dashboard-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px;
            max-width: 1000px; margin: 40px auto;
        }
        .mode-card {
            background: white; padding: 30px; border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid var(--primary);
            cursor: pointer; transition: transform 0.2s;
        }
        .mode-card:hover { transform: translateY(-5px); }
        .domain-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;
        }
        .domain-btn {
            background: #e7f1ff; border: 1px solid var(--primary); color: var(--primary);
            padding: 10px; border-radius: 4px; text-align: center; cursor: pointer; font-size: 0.9rem;
        }
        .domain-btn:hover { background: var(--primary); color: white; }

        /* --- TEST INTERFACE --- */
        .test-container {
            max-width: 1100px; margin: 0 auto; background: white;
            min-height: 80vh; display: flex; box-shadow: 0 0 15px rgba(0,0,0,0.05);
        }
        .question-area { flex: 3; padding: 40px; border-right: 1px solid #ddd; }
        .sidebar { flex: 1; padding: 20px; background: #fcfcfc; }
        
        .q-header {
            display: flex; justify-content: space-between; margin-bottom: 20px;
            color: #666; font-size: 0.9rem;
        }
        .q-text { font-size: 1.3rem; line-height: 1.6; margin-bottom: 25px; }

        /* --- VISUALS (SVG/CSS) --- */
        .visual-container {
            margin: 20px 0; padding: 20px; background: #fff;
            display: flex; justify-content: center; align-items: center;
        }
        
        /* Bar Graph CSS */
        .bar-graph { display: flex; align-items: flex-end; height: 200px; gap: 20px; border-bottom: 2px solid #333; border-left: 2px solid #333; padding: 10px; }
        .bar-col { width: 40px; background: var(--primary); text-align: center; color: white; transition: height 0.5s; position: relative; }
        .bar-label { position: absolute; bottom: -25px; width: 100%; color: #000; font-size: 0.8rem; }
        
        /* Circle Graph (Pie) */
        .pie-chart { width: 200px; height: 200px; border-radius: 50%; border: 1px solid #333; position: relative; }
        .pie-legend { margin-left: 20px; font-size: 0.9rem; }

        /* Clock */
        .clock-svg { width: 200px; height: 200px; }

        /* --- INPUTS --- */
        .option-item {
            display: flex; align-items: center; padding: 15px;
            border: 2px solid #ccc; border-radius: 6px; cursor: pointer; margin-bottom: 10px;
        }
        .option-item:hover { background: #f9f9f9; border-color: #999; }
        .option-item.selected { border-color: var(--primary); background: #eef6fc; border-width: 3px; }
        
        .radio-circle, .checkbox-box {
            width: 20px; height: 20px; border: 2px solid #555; margin-right: 15px;
            display: flex; align-items: center; justify-content: center;
        }
        .radio-circle { border-radius: 50%; }
        .selected .radio-circle::after { content:''; width:10px; height:10px; background:var(--primary); border-radius:50%; }
        .selected .checkbox-box::after { content:'‚úî'; font-size:14px; color:var(--primary); }

        .equation-input {
            width: 100%; padding: 15px; font-size: 1.2rem;
            border: 2px solid #333; border-radius: 4px; margin-top: 10px;
        }

        /* --- FOOTER & FEEDBACK --- */
        .test-footer {
            background: #333; padding: 15px; color: white; display: flex; justify-content: space-between;
        }
        .nav-btn {
            padding: 10px 25px; border: none; border-radius: 4px; font-size: 1rem;
            cursor: pointer; background: var(--primary); color: white;
        }
        .nav-btn.secondary { background: #666; }

        .feedback-panel {
            margin-top: 20px; padding: 15px; border-radius: 6px; display: none;
        }
        .feedback-panel.correct { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .feedback-panel.incorrect { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }

    </style>
</head>
<body>

    <div class="top-bar">
        <div class="logo">FAST Accelerated Simulator 4.0</div>
        <div class="toolbar">
            <button class="tool-btn" onclick="app.toggleFlag()">üö© Flag for Review</button>
            <div id="timer-display" style="padding: 5px 10px; font-weight:bold; color:#cd2026;">--:--</div>
        </div>
    </div>

    <div id="screen-home" class="screen active">
        <div class="dashboard-grid">
            <div class="mode-card" onclick="app.startSession('sim')">
                <h2>üìù Test Simulation</h2>
                <p>60 Minutes. 20 Questions. No immediate feedback. Real test conditions.</p>
                <button class="nav-btn" style="width:100%">Start Mock Test</button>
            </div>
            <div class="mode-card">
                <h2>üéØ Domain Practice</h2>
                <p>Select a standard. Instant feedback enabled.</p>
                <div class="domain-grid">
                    <div class="domain-btn" onclick="app.startSession('practice', 'NSO')">Number Sense</div>
                    <div class="domain-btn" onclick="app.startSession('practice', 'FR')">Fractions</div>
                    <div class="domain-btn" onclick="app.startSession('practice', 'AR')">Algebra</div>
                    <div class="domain-btn" onclick="app.startSession('practice', 'GR')">Geometry</div>
                    <div class="domain-btn" onclick="app.startSession('practice', 'DP')">Data & Time</div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-test" class="screen">
        <div class="test-container">
            <div class="question-area">
                <div class="q-header">
                    <span id="q-counter">Question 1</span>
                    <span id="q-standard" style="background:#eee; padding:2px 6px; border-radius:4px;">Standard</span>
                </div>

                <div id="q-content" class="q-text"></div>
                
                <div id="q-visual" class="visual-container" style="display:none;"></div>

                <div id="q-input-area"></div>

                <div id="feedback-area" class="feedback-panel"></div>
            </div>

            <div class="sidebar">
                <h3>Question Map</h3>
                <div id="q-map" style="display:grid; grid-template-columns:repeat(5, 1fr); gap:5px;"></div>
                <hr>
                <p style="font-size:0.8rem; color:#666;">
                    <strong>Tech-Enhanced Items:</strong><br>
                    - Equation Editor<br>
                    - Multi-Select<br>
                    - Dynamic Graphs<br>
                    - Analog Clocks
                </p>
            </div>
        </div>
    </div>

    <div class="test-footer" id="test-footer" style="display:none;">
        <button class="nav-btn secondary" onclick="app.prevQ()">Back</button>
        <button class="nav-btn secondary" id="btn-submit" onclick="app.submitAnswer()">Check / Submit</button>
        <button class="nav-btn" onclick="app.nextQ()">Next</button>
    </div>

    <script>
        /**
         * FAST SIMULATOR 4.0 ENGINE
         * Features: SVG Generation, Anti-Repeat Logic, Tech-Enhanced Items
         */

        const Utils = {
            rInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
            
            // Draw Analog Clock SVG
            drawClock: (h, m) => {
                const mDeg = m * 6;
                const hDeg = (h % 12) * 30 + (m * 0.5);
                return `
                <svg class="clock-svg" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" stroke="black" stroke-width="2" fill="white" />
                    <text x="50" y="15" text-anchor="middle" font-size="8">12</text>
                    <text x="85" y="52" text-anchor="middle" font-size="8">3</text>
                    <text x="50" y="90" text-anchor="middle" font-size="8">6</text>
                    <text x="15" y="52" text-anchor="middle" font-size="8">9</text>
                    <line x1="50" y1="50" x2="50" y2="25" stroke="black" stroke-width="3" transform="rotate(${hDeg} 50 50)" stroke-linecap="round"/>
                    <line x1="50" y1="50" x2="50" y2="15" stroke="black" stroke-width="2" transform="rotate(${mDeg} 50 50)" stroke-linecap="round"/>
                    <circle cx="50" cy="50" r="2" fill="black" />
                </svg>`;
            },

            // Draw Bar Graph
            drawBarGraph: (data) => {
                const max = Math.max(...data.map(d => d.val));
                let html = `<div class="bar-graph">`;
                data.forEach(d => {
                    const h = (d.val / max) * 100; // percent height
                    html += `
                    <div class="bar-col" style="height:${h}%">
                        ${d.val}
                        <div class="bar-label">${d.label}</div>
                    </div>`;
                });
                html += `</div>`;
                return html;
            },

            // Draw Pie Chart (CSS Conic Gradient)
            drawPie: (p1, p2, p3) => {
                const t = p1 + p2 + p3;
                const d1 = (p1/t)*100;
                const d2 = d1 + (p2/t)*100;
                return `
                <div style="display:flex; align-items:center;">
                    <div class="pie-chart" style="background: conic-gradient(
                        #005ea2 0% ${d1}%, 
                        #e5a000 ${d1}% ${d2}%, 
                        #cd2026 ${d2}% 100%
                    );"></div>
                    <div class="pie-legend">
                        <div style="color:#005ea2">‚óè Blue: ${p1} votes</div>
                        <div style="color:#e5a000">‚óè Yellow: ${p2} votes</div>
                        <div style="color:#cd2026">‚óè Red: ${p3} votes</div>
                    </div>
                </div>`;
            }
        };

        class QuestionFactory {
            constructor() {
                this.usedIDs = []; // Anti-repeat memory
            }

            getUniqueId(prefix) {
                let id;
                do { id = prefix + Utils.rInt(1, 10000); } while(this.usedIDs.includes(id));
                this.usedIDs.push(id);
                return id;
            }

            /* --- GENERATOR 1: NSO (Number Sense) --- */
            generateNSO() {
                const type = Utils.rInt(1, 2);
                
                // Type 1: Rounding Multi-Select (Level 4)
                if(type === 1) {
                    const target = Utils.rInt(20, 80) * 10;
                    return {
                        id: this.getUniqueId('NSO'),
                        standard: "MA.3.NSO.1.4 (Acc)",
                        text: `Select <strong>ALL</strong> numbers that round to <strong>${target}</strong> when rounded to the nearest 10.`,
                        type: "multiselect",
                        visual: null,
                        options: [
                            { text: `${target - 4}`, correct: true },
                            { text: `${target + 3}`, correct: true },
                            { text: `${target - 6}`, correct: false },
                            { text: `${target + 5}`, correct: false },
                            { text: `${target + 1}`, correct: true }
                        ],
                        ald: "Level 4: Rounds whole numbers to the nearest 10 or 100 in context."
                    };
                }
                
                // Type 2: Composition (Level 4)
                const thousands = Utils.rInt(2, 8);
                const tens = Utils.rInt(2, 9);
                return {
                    id: this.getUniqueId('NSO'),
                    standard: "MA.3.NSO.1.2",
                    text: `A number has a <strong>${thousands}</strong> in the thousands place and a <strong>${tens}</strong> in the tens place. Zeros are used in all other places. What is the number?`,
                    type: "radio",
                    visual: null,
                    options: [
                        { text: `${thousands}0${tens}0`, correct: true },
                        { text: `${thousands}${tens}00`, correct: false },
                        { text: `${thousands}00${tens}`, correct: false },
                        { text: `${thousands}0${tens}`, correct: false }
                    ],
                    ald: "Level 4: Composes and decomposes 4-digit numbers."
                };
            }

            /* --- GENERATOR 2: DP (Data & Time - VISUALS!) --- */
            generateDP() {
                const type = Utils.rInt(1, 3);

                // Type 1: Analog Clock (Level 3/4)
                if (type === 1) {
                    const h = Utils.rInt(1, 12);
                    const m = Utils.rInt(0, 11) * 5; // multiple of 5 for clear reading
                    const mStr = m === 0 ? "00" : (m < 10 ? "0"+m : m);
                    return {
                        id: this.getUniqueId('DP'),
                        standard: "MA.3.M.2.1",
                        text: "What time is shown on the clock?",
                        type: "radio",
                        visual: Utils.drawClock(h, m),
                        options: [
                            { text: `${h}:${mStr}`, correct: true },
                            { text: `${h === 1 ? 12 : h-1}:${mStr}`, correct: false },
                            { text: `${m === 0 ? 12 : m/5}:${h < 10 ? "0"+h : h}`, correct: false }, // confused hands
                            { text: `${h}:${m === 0 ? "12" : m}`, correct: false }
                        ],
                        ald: "Level 3: Tells and writes time to the nearest minute using analog clocks."
                    };
                }

                // Type 2: Bar Graph (Level 4 Analysis)
                if (type === 2) {
                    const d = [
                        { label: 'Pizza', val: Utils.rInt(5, 15) },
                        { label: 'Tacos', val: Utils.rInt(5, 15) },
                        { label: 'Salad', val: Utils.rInt(2, 8) }
                    ];
                    const diff = Math.abs(d[0].val - d[1].val);
                    return {
                        id: this.getUniqueId('DP'),
                        standard: "MA.3.DP.1.1",
                        text: "Based on the bar graph below, how many more students voted for Pizza or Tacos (whichever is higher) than the other?",
                        type: "equation",
                        visual: Utils.drawBarGraph(d),
                        correctValue: diff.toString(),
                        ald: "Level 4: Interprets data in scaled bar graphs to solve one-step problems."
                    };
                }

                // Type 3: Circle Graph (Acc/Grade 4 overlap)
                const v1 = 10, v2 = 20, v3 = 10; // Fixed simplified ratios for rendering
                return {
                    id: this.getUniqueId('DP'),
                    standard: "MA.3.DP.1.1 (Acc)",
                    text: "The circle graph shows the results of a class vote. If 40 students voted in total, how many students voted for Yellow?",
                    type: "radio",
                    visual: Utils.drawPie(v1, v2, v3),
                    options: [
                        { text: "20 students", correct: true },
                        { text: "10 students", correct: false },
                        { text: "25 students", correct: false },
                        { text: "15 students", correct: false }
                    ],
                    ald: "Level 4: Interprets data in circle graphs."
                };
            }

            /* --- GENERATOR 3: FR (Fractions) --- */
            generateFR() {
                // Number Line Logic (Acc)
                const num = Utils.rInt(1, 3);
                const den = 4;
                return {
                    id: this.getUniqueId('FR'),
                    standard: "MA.3.FR.2.1",
                    text: `Which fraction is represented by the point on the number line? (Visual: Point is at mark ${num} of ${den})`,
                    type: "radio",
                    visual: `<svg width="300" height="50">
                        <line x1="10" y1="25" x2="290" y2="25" stroke="black" stroke-width="2"/>
                        <line x1="10" y1="20" x2="10" y2="30" stroke="black" stroke-width="2"/>
                        <text x="5" y="45" font-size="12">0</text>
                        <line x1="290" y1="20" x2="290" y2="30" stroke="black" stroke-width="2"/>
                        <text x="285" y="45" font-size="12">1</text>
                        <line x1="80" y1="22" x2="80" y2="28" stroke="black" />
                        <line x1="150" y1="22" x2="150" y2="28" stroke="black" />
                        <line x1="220" y1="22" x2="220" y2="28" stroke="black" />
                        <circle cx="${10 + (280 * (num/den))}" cy="25" r="5" fill="red" />
                    </svg>`,
                    options: [
                        { text: `${num}/${den}`, correct: true },
                        { text: `${den}/${num}`, correct: false },
                        { text: `${num}/${den+1}`, correct: false },
                        { text: `${num+1}/${den}`, correct: false }
                    ],
                    ald: "Level 3: Identifies fractions on a number line."
                };
            }

            /* --- GENERATOR 4: AR (Algebra) --- */
            generateAR() {
                const f1 = Utils.rInt(6, 9);
                const f2 = Utils.rInt(6, 9);
                const prod = f1 * f2;
                return {
                    id: this.getUniqueId('AR'),
                    standard: "MA.3.AR.1.2",
                    text: `Solve for the unknown <strong>n</strong>: <br><br> $$ ${prod} \\div n = ${f1} $$`,
                    type: "equation",
                    visual: null,
                    correctValue: f2.toString(),
                    ald: "Level 3: Solves one-step division problems."
                };
            }

            /* --- GENERATOR 5: GR (Geometry) --- */
            generateGR() {
                return {
                    id: this.getUniqueId('GR'),
                    standard: "MA.3.GR.1.2",
                    text: "Select <strong>ALL</strong> shapes that always have 4 right angles.",
                    type: "multiselect",
                    visual: null,
                    options: [
                        { text: "Rectangle", correct: true },
                        { text: "Square", correct: true },
                        { text: "Rhombus", correct: false },
                        { text: "Trapezoid", correct: false },
                        { text: "Parallelogram", correct: false }
                    ],
                    ald: "Level 3: Identifies attributes of quadrilaterals."
                };
            }
        }

        // --- APP CONTROLLER ---
        const app = {
            factory: new QuestionFactory(),
            state: {
                mode: null,
                questions: [],
                currentIndex: 0,
                responses: {},
                flags: [],
                timer: 3600
            },

            startSession: function(mode, domain) {
                this.state.mode = mode;
                this.state.questions = [];
                this.state.responses = {};
                this.state.flags = [];
                this.state.currentIndex = 0;
                this.state.timer = 3600;

                const count = mode === 'sim' ? 15 : 5;
                const domains = ['NSO','FR','AR','GR','DP'];

                for(let i=0; i<count; i++) {
                    const d = mode === 'practice' && domain ? domain : domains[Utils.rInt(0,4)];
                    this.state.questions.push(this.factory[`generate${d}`]());
                }

                // Switch Screens
                document.getElementById('screen-home').classList.remove('active');
                document.getElementById('screen-test').classList.add('active');
                document.getElementById('test-footer').style.display = 'flex';
                
                // Start Timer
                if(mode === 'sim') this.startTimer();
                else document.getElementById('timer-display').innerText = "Practice";

                this.renderQ();
                this.renderMap();
            },

            renderQ: function() {
                const q = this.state.questions[this.state.currentIndex];
                const resp = this.state.responses[this.state.currentIndex];

                document.getElementById('q-counter').innerText = `Question ${this.state.currentIndex + 1}`;
                document.getElementById('q-standard').innerText = q.standard;
                document.getElementById('q-content').innerHTML = q.text;
                document.getElementById('feedback-area').style.display = 'none';

                // Render Visuals
                const vBox = document.getElementById('q-visual');
                if (q.visual) {
                    vBox.style.display = 'flex';
                    vBox.innerHTML = q.visual;
                } else {
                    vBox.style.display = 'none';
                }

                // Render Inputs
                const iBox = document.getElementById('q-input-area');
                iBox.innerHTML = '';

                if(q.type === 'radio' || q.type === 'multiselect') {
                    q.options.forEach((opt, idx) => {
                        const el = document.createElement('div');
                        const isSel = q.type === 'radio' 
                            ? resp === idx 
                            : (resp || []).includes(idx);
                        
                        el.className = `option-item ${isSel ? 'selected' : ''}`;
                        el.innerHTML = `<div class="${q.type === 'radio' ? 'radio-circle' : 'checkbox-box'}"></div> ${opt.text}`;
                        el.onclick = () => this.handleInput(q, idx);
                        iBox.appendChild(el);
                    });
                } else if (q.type === 'equation') {
                    const inp = document.createElement('input');
                    inp.className = 'equation-input';
                    inp.placeholder = "Type number here...";
                    inp.value = resp || '';
                    inp.oninput = (e) => {
                        this.state.responses[this.state.currentIndex] = e.target.value;
                        this.renderMap();
                    };
                    iBox.appendChild(inp);
                }
            },

            handleInput: function(q, idx) {
                if(q.type === 'radio') {
                    this.state.responses[this.state.currentIndex] = idx;
                } else {
                    const curr = this.state.responses[this.state.currentIndex] || [];
                    if(curr.includes(idx)) this.state.responses[this.state.currentIndex] = curr.filter(x => x !== idx);
                    else this.state.responses[this.state.currentIndex] = [...curr, idx];
                }
                this.renderQ();
                this.renderMap();
            },

            renderMap: function() {
                const map = document.getElementById('q-map');
                map.innerHTML = '';
                this.state.questions.forEach((q, i) => {
                    const btn = document.createElement('div');
                    const answered = this.state.responses[i] !== undefined && this.state.responses[i] !== "";
                    const flagged = this.state.flags.includes(i);
                    
                    btn.style.cssText = `border:1px solid #ccc; padding:8px; text-align:center; cursor:pointer; background:${this.state.currentIndex===i ? '#333' : '#fff'}; color:${this.state.currentIndex===i?'#fff':'#000'};`;
                    btn.innerText = (flagged ? "üö©" : "") + (answered ? "‚úî " : "") + (i+1);
                    btn.onclick = () => { this.state.currentIndex = i; this.renderQ(); this.renderMap(); };
                    map.appendChild(btn);
                });
            },

            submitAnswer: function() {
                if(this.state.mode === 'sim') {
                    alert("Simulation Mode: Feedback is hidden until the end.");
                    return;
                }
                
                // Practice Mode Feedback
                const q = this.state.questions[this.state.currentIndex];
                const r = this.state.responses[this.state.currentIndex];
                const fb = document.getElementById('feedback-area');
                let correct = false;

                if(q.type === 'radio') correct = q.options[r]?.correct;
                if(q.type === 'equation') correct = (r == q.correctValue);
                if(q.type === 'multiselect') {
                    const target = q.options.map((o,i)=>o.correct?i:null).filter(x=>x!==null);
                    if(r && r.length === target.length && r.every(v=>target.includes(v))) correct = true;
                }

                fb.style.display = 'block';
                fb.className = `feedback-panel ${correct ? 'correct' : 'incorrect'}`;
                fb.innerHTML = `<strong>${correct?'Correct!':'Incorrect.'}</strong><br>${q.ald}`;
            },

            nextQ: function() {
                if(this.state.currentIndex < this.state.questions.length-1) {
                    this.state.currentIndex++; this.renderQ(); this.renderMap();
                }
            },
            prevQ: function() {
                if(this.state.currentIndex > 0) {
                    this.state.currentIndex--; this.renderQ(); this.renderMap();
                }
            },
            toggleFlag: function() {
                const i = this.state.currentIndex;
                if(this.state.flags.includes(i)) this.state.flags = this.state.flags.filter(x=>x!==i);
                else this.state.flags.push(i);
                this.renderMap();
            },
            startTimer: function() {
                const t = document.getElementById('timer-display');
                setInterval(() => {
                    this.state.timer--;
                    const m = Math.floor(this.state.timer/60);
                    const s = this.state.timer%60;
                    t.innerText = `${m}:${s<10?'0'+s:s}`;
                }, 1000);
            }
        };
    </script>
</body>
</html>
