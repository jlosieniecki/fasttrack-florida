                    <summary>üçï Fractions (FR)</summary>
                    <button class="sub-btn" onclick="startTest('MA.3.FR.1.1', 5)">FR.1.1: Represent Fractions</button>
                    <button class="sub-btn" onclick="startTest('MA.3.FR.1.2', 5)">FR.1.2: Number Lines (Lv 4)</button>
                    <button class="sub-btn" onclick="startTest('MA.3.FR.1.3', 5)">FR.1.3: Whole Numbers</button>
                    <button class="sub-btn" onclick="startTest('MA.3.FR.2.1', 5)">FR.2.1: Comparing Fractions</button>
                    <button class="sub-btn" onclick="startTest('MA.3.FR.2.2', 5)">FR.2.2: Equivalent Fractions</button>
                </details>

                <details>
                    <summary>üß† Algebraic Reasoning (AR)</summary>
                    <button class="sub-btn" onclick="startTest('MA.3.AR.1.1', 5)">AR.1.1: Distributive Property</button>
                    <button class="sub-btn" onclick="startTest('MA.3.AR.1.2', 5)">AR.1.2: Multi-Step Problems (Lv 5)</button>
                    <button class="sub-btn" onclick="startTest('MA.3.AR.2.1', 5)">AR.2.1: Inverse Operations</button>
                    <button class="sub-btn" onclick="startTest('MA.3.AR.2.2', 5)">AR.2.2: Interpreting Equations</button>
                    <button class="sub-btn" onclick="startTest('MA.3.AR.2.3', 5)">AR.2.3: Missing Factors</button>
                    <button class="sub-btn" onclick="startTest('MA.3.AR.3.1', 5)">AR.3.1: Number Patterns</button>
                    <button class="sub-btn" onclick="startTest('MA.3.AR.3.2', 5)">AR.3.2: Pattern Rules</button>
                    <button class="sub-btn" onclick="startTest('MA.3.AR.3.3', 5)">AR.3.3: Input/Output Tables</button>
                </details>

                <details>
                    <summary>üìê Geometry (GR)</summary>
                    <button class="sub-btn" onclick="startTest('MA.3.GR.1.1', 5)">GR.1.1: Points, Lines, Rays</button>
                    <button class="sub-btn" onclick="startTest('MA.3.GR.1.2', 5)">GR.1.2: Quad Attributes (Lv 4)</button>
                    <button class="sub-btn" onclick="startTest('MA.3.GR.1.3', 5)">GR.1.3: Symmetry</button>
                    <button class="sub-btn" onclick="startTest('MA.3.GR.2.1', 5)">GR.2.1: Area (Tiling)</button>
                    <button class="sub-btn" onclick="startTest('MA.3.GR.2.2', 5)">GR.2.2: Area (Formula)</button>
                    <button class="sub-btn" onclick="startTest('MA.3.GR.2.3', 5)">GR.2.3: Perimeter</button>
                    <button class="sub-btn" onclick="startTest('MA.3.GR.2.4', 5)">GR.2.4: Area vs Perimeter (Lv 5)</button>
                </details>

                <details>
                    <summary>üìä Data & Measurement (M/DP)</summary>
                    <button class="sub-btn" onclick="startTest('MA.3.M.1.1', 5)">M.1.1: Measurement Conversions</button>
                    <button class="sub-btn" onclick="startTest('MA.3.M.1.2', 5)">M.1.2: Mass & Volume</button>
                    <button class="sub-btn" onclick="startTest('MA.3.M.2.1', 5)">M.2.1: Telling Time</button>
                    <button class="sub-btn" onclick="startTest('MA.3.M.2.2', 5)">M.2.2: Elapsed Time (Lv 4)</button>
                    <button class="sub-btn" onclick="startTest('MA.3.DP.1.1', 5)">DP.1.1: Scaled Graphs</button>
                    <button class="sub-btn" onclick="startTest('MA.3.DP.1.2', 5)">DP.1.2: Interpreting Data</button>
                </details>
            </div>
        </div>
    </div>

    <div id="screen-test" class="screen">
        <div class="top-bar">
            <div><strong>FAST Simulator</strong> | Level 4/5 Mode</div>
            <div>
                <button class="tool-btn" onclick="toggleZoom()">üîç Zoom</button>
                <button class="tool-btn" style="color:#D32F2F; border-color:#D32F2F;" onclick="location.reload()">Exit</button>
            </div>
        </div>

        <div id="stage" class="main-stage"></div>

        <div class="nav-bar">
            <button class="nav-btn" onclick="prevQ()">Back</button>
            <div style="font-weight:bold; color:#555;">Item <span id="q-idx">1</span> of <span id="q-total">40</span></div>
            <button class="nav-btn primary" onclick="nextQ()" id="btn-next">Next</button>
        </div>
    </div>

    <div id="screen-report" class="screen">
        <div class="menu-container" style="background: #f4f4f4; color: #333; justify-content: center;">
            <div class="menu-card">
                <h2>Performance Report</h2>
                <div id="final-badge" class="level-badge l3">Calculating...</div>
                <div id="report-grid" style="text-align:left; margin-top:20px;"></div>
                <button class="main-btn" style="margin-top:30px;" onclick="location.reload()">Return to Menu</button>
            </div>
        </div>
    </div>

    <script>
        // --- VISUAL DRAWING FUNCTIONS ---
        function drawRect(l, w, missingSide=false) {
            let max = Math.max(l, w);
            let scale = 220 / max;
            let svgW = l * scale;
            let svgH = w * scale;
            let x = (300 - svgW) / 2;
            let y = (250 - svgH) / 2;
            let labelL = missingSide === 'L' ? "?" : l + ' ft';
            let labelW = missingSide === 'W' ? "?" : w + ' ft';

            return `<svg viewBox="0 0 300 250">
                <rect x="${x}" y="${y}" width="${svgW}" height="${svgH}" fill="#EAEAEA" stroke="#333" stroke-width="3"/>
                <text x="${150}" y="${y - 10}" text-anchor="middle" font-weight="bold" font-size="16">${labelL}</text>
                <text x="${x - 15}" y="${125}" text-anchor="middle" font-weight="bold" font-size="16" transform="rotate(-90, ${x-15}, 125)">${labelW}</text>
            </svg>`;
        }

        function drawClock(h, m, title="") {
            let hAng = ((h % 12) * 30 + (m / 2)) * (Math.PI / 180) - (Math.PI / 2);
            let mAng = (m * 6) * (Math.PI / 180) - (Math.PI / 2);
            let ticks = "";
            for(let i=0; i<12; i++){
                let ang = (i*30-90)*Math.PI/180;
                ticks += `<line x1="${50+38*Math.cos(ang)}" y1="${50+38*Math.sin(ang)}" x2="${50+44*Math.cos(ang)}" y2="${50+44*Math.sin(ang)}" stroke="#333" stroke-width="2"/>`;
            }

            return `<svg viewBox="0 0 100 120">
                <text x="50" y="15" text-anchor="middle" font-weight="bold" font-size="12">${title}</text>
                <circle cx="50" cy="70" r="45" fill="white" stroke="#333" stroke-width="3"/>
                ${ticks}
                <line x1="50" y1="70" x2="${50 + 24 * Math.cos(hAng)}" y2="${70 + 24 * Math.sin(hAng)}" stroke="black" stroke-width="4" stroke-linecap="round"/>
                <line x1="50" y1="70" x2="${50 + 36 * Math.cos(mAng)}" y2="${70 + 36 * Math.sin(mAng)}" stroke="#00609C" stroke-width="3" stroke-linecap="round"/>
                <circle cx="50" cy="70" r="3" fill="#333"/>
            </svg>`;
        }

        function drawPie(d, n, interactive=false) {
             let path = "";
            for(let i=0; i<n; i++) {
                let start = (i * 360 / d - 90) * Math.PI/180;
                let end = ((i+1) * 360 / d - 90) * Math.PI/180;
                let x1=50+45*Math.cos(start), y1=50+45*Math.sin(start);
                let x2=50+45*Math.cos(end), y2=50+45*Math.sin(end);
                path += `M50,50 L${x1},${y1} A45,45 0 0,1 ${x2},${y2} Z `;
            }
            let lines = "";
            for(let i=0; i<d; i++) {
                let ang = (i*360/d - 90) * Math.PI/180;
                lines += `<line x1="50" y1="50" x2="${50+45*Math.cos(ang)}" y2="${50+45*Math.sin(ang)}" stroke="#333" stroke-width="2"/>`;
            }
            return `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="white" stroke="#333" stroke-width="2"/><path d="${path}" fill="#00609C" stroke="#333"/>${lines}</svg>`;
        }

        // --- MASTER DATA: LEVEL 4/5 VARIATIONS ---
        const STANDARDS = {
            // NSO
            "MA.3.NSO.1.1": [
                () => { let n=1000+Math.floor(Math.random()*8000); return {id:`NSO11A`, cat:"NSO.1.1", type:"choice", layout:"full", text:`A student writes <b>${n}</b> in expanded form. Which expression correctly represents the value of the hundreds digit?`, opts:[(Math.floor((n%1000)/100)*100).toString(), Math.floor((n%1000)/100).toString(), (Math.floor(n/1000)*1000).toString()], ans:(Math.floor((n%1000)/100)*100).toString()} },
                () => { let n=Math.floor(Math.random()*9000); return {id:`NSO11B`, cat:"NSO.1.1", type:"multi-select", layout:"full", text:`Select <b>all</b> ways to represent <b>${n.toLocaleString()}</b>.`, opts:[`${Math.floor(n/1000)} thousands, ${n%1000} ones`, `${n} ones`, `${Math.floor(n/100)} hundreds`, `${Math.floor(n/10)} tens`], ans:[0,1,3]} }
            ],
            "MA.3.NSO.1.2": [
                () => { return {id:`NSO12A`, cat:"NSO.1.2", type:"choice", layout:"full", text:`Analyze this decomposition: <b>2,300 = 1 thousand + 13 hundreds</b>. Is it correct?`, opts:["Yes, because 1,000 + 1,300 = 2,300.", "No, because you cannot have 13 hundreds."], ans:"Yes, because 1,000 + 1,300 = 2,300."} },
                () => { let n=3500; return {id:`NSO12B`, cat:"NSO.1.2", type:"input", layout:"full", text:`3,500 = 2 thousands + ? hundreds`, ans:"15"} }
            ],
            "MA.3.NSO.1.3": [
                () => { let a=Math.floor(Math.random()*9000); return {id:`NSO13A`, cat:"NSO.1.3", type:"inline", layout:"full", text:`Compare ${a} and ${a+10}.`, sentence:[{text:`${a}`},{type:"select",opts:[">","<","="],ans:"<"},{text:`${a+10}`}]} }
            ],
            "MA.3.NSO.1.4": [
                () => { let n=Math.floor(Math.random()*800)+100; return {id:`NSO14A`, cat:"NSO.1.4", type:"input", layout:"full", text:`Round <b>${n}</b> to the nearest 100.`, ans:(Math.round(n/100)*100).toString()} }
            ],
            "MA.3.NSO.2.1": [
                 () => { let a=Math.floor(Math.random()*4000)+1000; return {id:`NSO21A`, cat:"NSO.2.1", type:"input", layout:"full", text:`${a} + 2,345 = ?`, ans:(a+2345).toString()} }
            ],
            "MA.3.NSO.2.2": [
                 () => { return {id:`NSO22A`, cat:"NSO.2.2", type:"choice", layout:"full", text:`Which equation is related to 56 √∑ 8 = 7?`, opts:["7 √ó 8 = 56", "56 + 8 = 64", "8 + 7 = 15"], ans:"7 √ó 8 = 56"} }
            ],
            "MA.3.NSO.2.3": [ () => ({id:`NSO23A`, cat:"NSO.2.3", type:"choice", layout:"full", text:"Which property explains why 4x5 = 5x4?", opts:["Commutative", "Associative", "Distributive"], ans:"Commutative"}) ],
            "MA.3.NSO.2.4": [ () => ({id:`NSO24A`, cat:"NSO.2.4", type:"input", layout:"full", text:"63 √∑ 9 = ?", ans:"7"}) ],

            // AR
            "MA.3.AR.1.1": [ () => ({id:`AR11A`, cat:"AR.1.1", type:"choice", layout:"full", text:"Apply Distributive Property: 8 x 7", opts:["(8x5) + (8x2)", "8 + 7", "8 x 5 + 2"], ans:"(8x5) + (8x2)"}) ],
            "MA.3.AR.1.2": [ 
                () => { return {id:`AR12A`, cat:"AR.1.2", type:"choice", layout:"full", text:`Mia buys 3 packs of 6 pencils. She gives 5 to a friend. Which equation finds how many are left?`, opts:["(3 √ó 6) ‚àí 5 = 13", "(3 + 6) ‚àí 5 = 4", "3 √ó 6 + 5 = 23"], ans:"(3 √ó 6) ‚àí 5 = 13"} }
            ],
            "MA.3.AR.2.1": [ () => ({id:`AR21A`, cat:"AR.2.1", type:"input", layout:"full", text:"24 √∑ 3 = ?", ans:"8"}) ],
            "MA.3.AR.2.2": [ () => ({id:`AR22A`, cat:"AR.2.2", type:"choice", layout:"full", text:"Which situation matches 4 x 5?", opts:["4 bags with 5 apples each", "4 apples and 5 oranges"], ans:"4 bags with 5 apples each"}) ],
            "MA.3.AR.2.3": [ () => ({id:`AR23A`, cat:"AR.2.3", type:"input", layout:"full", text:"42 √∑ ? = 6", ans:"7"}) ],
            "MA.3.AR.3.1": [ () => ({id:`AR31A`, cat:"AR.3.1", type:"choice", layout:"full", text:"2, 5, 8, 11... Rule?", opts:["Add 3", "Multiply 2"], ans:"Add 3"}) ],
            "MA.3.AR.3.2": [ () => ({id:`AR32A`, cat:"AR.3.2", type:"choice", layout:"full", text:"Multiples of 2 are always:", opts:["Even", "Odd"], ans:"Even"}) ],
            "MA.3.AR.3.3": [ () => ({id:`AR33A`, cat:"AR.3.3", type:"input", layout:"full", text:"Rule: +6. In: 5, Out: ?", ans:"11"}) ],

            // FR
            "MA.3.FR.1.1": [
                () => { let d=[4,6,8][Math.floor(Math.random()*3)]; return {id:`FR11A`, cat:"FR.1.1", type:"choice", layout:"split", visual:drawPie(d,1), text:"What fraction is shaded?", opts:[`1/${d}`, `1/${d+1}`], ans:`1/${d}`} }
            ],
            "MA.3.FR.1.2": [ () => ({id:`FR12A`, cat:"FR.1.2", type:"choice", layout:"full", text:"Where is 3/4 on number line?", opts:["Between 0 and 1", "Between 1 and 2"], ans:"Between 0 and 1"}) ],
            "MA.3.FR.1.3": [ () => ({id:`FR13A`, cat:"FR.1.3", type:"input", layout:"full", text:"Fraction for 3 wholes?", ans:"3/1"}) ],
            "MA.3.FR.2.1": [ () => ({id:`FR21A`, cat:"FR.2.1", type:"choice", layout:"full", text:"Which is larger?", opts:["1/3", "1/6"], ans:"1/3"}) ],
            "MA.3.FR.2.2": [ () => ({id:`FR22A`, cat:"FR.2.2", type:"choice", layout:"full", text:"Equivalent to 1/2?", opts:["2/4", "2/5"], ans:"2/4"}) ],

            // GR
            "MA.3.GR.1.1": [ () => ({id:`GR11A`, cat:"GR.1.1", type:"choice", layout:"full", text:"Line with 1 endpoint?", opts:["Ray", "Line Segment"], ans:"Ray"}) ],
            "MA.3.GR.1.2": [ () => ({id:`GR12A`, cat:"GR.1.2", type:"multi-select", layout:"full", text:"Select Rectangles.", opts:["Square", "Trapezoid"], ans:[0]}) ],
            "MA.3.GR.1.3": [ () => ({id:`GR13A`, cat:"GR.1.3", type:"input", layout:"full", text:"Lines of symmetry in Square?", ans:"4"}) ],
            "MA.3.GR.2.1": [ () => ({id:`GR21A`, cat:"GR.2.1", type:"choice", layout:"split", visual:drawRect(3,2), text:"Area?", opts:["6", "5"], ans:"6"}) ],
            "MA.3.GR.2.2": [ () => ({id:`GR22A`, cat:"GR.2.2", type:"input", layout:"full", text:"Rect: 5x6. Area?", ans:"30"}) ],
            "MA.3.GR.2.3": [ () => ({id:`GR23A`, cat:"GR.2.3", type:"input", layout:"split", visual:drawRect(5,4), text:"Perimeter?", ans:"18"}) ],
            "MA.3.GR.2.4": [ () => ({id:`GR24A`, cat:"GR.2.4", type:"choice", layout:"full", text:"Same Area, Diff Perimeter?", opts:["Possible", "Impossible"], ans:"Possible"}) ],

            // M & DP
            "MA.3.M.1.1": [ () => ({id:`M11A`, cat:"M.1.1", type:"input", layout:"full", text:"3 ft = ? in", ans:"36"}) ],
            "MA.3.M.1.2": [ () => ({id:`M12A`, cat:"M.1.2", type:"input", layout:"full", text:"2000g = ? kg", ans:"2"}) ],
            "MA.3.M.2.1": [
                () => { let h=Math.floor(Math.random()*11)+1; return {id:`M21A`, cat:"M.2.1", type:"choice", layout:"split", visual:drawClock(h,30), text:"Time?", opts:[`${h}:30`, `${h+1}:30`], ans:`${h}:30`} }
            ],
            "MA.3.M.2.2": [ () => ({id:`M22A`, cat:"M.2.2", type:"input", layout:"full", text:"Start 2:00. End 2:45. Mins?", ans:"45"}) ],
            "MA.3.DP.1.1": [ () => ({id:`DP11A`, cat:"DP.1.1", type:"choice", layout:"full", text:"Graph Scale is 5. Bar is at 20.", opts:["Value is 20", "Value is 4"], ans:"Value is 20"}) ],
            "MA.3.DP.1.2": [ () => ({id:`DP12A`, cat:"DP.1.2", type:"choice", layout:"full", text:"Most people liked:", opts:["Pizza", "Salad"], ans:"Pizza"}) ]
        };

        // --- SESSION LOGIC ---
        let queue = [], curIdx = 0, answers = [];
        let sessionHistory = new Set(); 

        function startTest(mode, count) {
            queue = []; answers = [];
            sessionHistory.clear();
            
            let attempts = 0;
            // Generate Queue
            while(queue.length < count && attempts < 400) {
                attempts++;
                let keys = Object.keys(STANDARDS);
                if(mode !== 'ALL') keys = keys.filter(k => k.includes(mode));
                
                if(keys.length === 0) { alert("Standard not found in database."); return; }
                
                let k = keys[Math.floor(Math.random()*keys.length)];
                let gens = STANDARDS[k];
                let q = gens[Math.floor(Math.random()*gens.length)]();

                queue.push(q);
            }

            if(queue.length === 0) { alert("No questions found!"); return; }

            curIdx = 0;
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
            document.getElementById('screen-test').classList.add('active');
            renderQ();
        }

        function renderQ() {
            const q = queue[curIdx];
            const stage = document.getElementById('stage');
            const ans = answers[curIdx] || {};

            let left = q.layout === 'split' ? `<div class="left-pane">${q.visual}</div>` : "";
            let rStyle = q.layout === 'full' ? "width:100%" : "width:55%";

            let html = "";
            if(q.type === 'choice') {
                q.opts.forEach(o => {
                    let sel = ans === o ? 'selected' : '';
                    html += `<div class="opt-row ${sel}" onclick="save('${o}')"><div class="bubble"></div>${o}</div>`;
                });
            } 
            else if(q.type === 'multi-select') {
                q.opts.forEach((o, i) => {
                    let arr = answers[curIdx] || [];
                    let sel = arr.includes(i) ? 'selected'
