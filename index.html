<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAST Grade 3 Accelerated | Master Simulator (Fixed)</title>
    <style>
        :root {
            --primary: #004d40; /* FL B.E.S.T. Green */
            --accent: #e65100;  /* FL Orange */
            --bg: #eceff1;
            --panel: #ffffff;
            --text: #263238;
            --border: #cfd8dc;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: 320px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; height: 100vh; }
        
        .logo-area { padding: 20px; background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        .logo-area h1 { margin: 0; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .sim-btn {
            margin: 15px; padding: 15px; background: var(--accent); color: white; text-align: center;
            border-radius: 8px; font-weight: bold; cursor: pointer; border: 2px solid #ef6c00;
            transition: transform 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .sim-btn:hover { transform: translateY(-2px); }

        .menu-scroll { flex: 1; overflow-y: auto; padding: 0 15px 20px; }
        
        .menu-cat { 
            font-size: 0.75rem; text-transform: uppercase; color: #78909c; font-weight: 800; 
            margin: 20px 0 8px; border-bottom: 2px solid #eee; padding-bottom: 5px;
        }
        
        .std-btn { 
            display: block; width: 100%; text-align: left; padding: 12px; margin-bottom: 6px; 
            background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; cursor: pointer; transition: 0.1s;
            font-size: 0.9rem;
        }
        .std-btn:hover { background: #e0f2f1; border-color: var(--primary); }
        .std-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .std-btn small { display: block; font-size: 0.75rem; margin-top: 3px; opacity: 0.7; }

        /* --- MAIN STAGE --- */
        .main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 30px; }
        
        .q-container { 
            background: white; padding: 40px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); max-width: 900px; margin: 0 auto; width: 100%; 
            border-top: 6px solid var(--primary);
        }
        
        .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .badge { background: #eceff1; color: #455a64; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; border: 1px solid #cfd8dc; }
        
        .q-text { font-size: 1.35rem; line-height: 1.5; margin-bottom: 30px; color: #263238; }

        /* --- VISUALS --- */
        .visual-stage { 
            background: #fafafa; border: 2px dashed #cfd8dc; border-radius: 8px; 
            padding: 30px; margin-bottom: 30px; display: flex; justify-content: center; align-items: center; 
        }

        /* --- INPUTS --- */
        .options-list { display: grid; gap: 12px; }
        .opt-btn { 
            display: flex; align-items: center; padding: 18px; border: 2px solid #e0e0e0; border-radius: 8px; 
            background: white; cursor: pointer; font-size: 1.1rem; transition: 0.2s;
        }
        .opt-btn:hover { border-color: #b0bec5; background: #f5f5f5; }
        .opt-btn.selected { border-color: var(--primary); background: #e0f2f1; box-shadow: inset 0 0 0 1px var(--primary); }
        
        .icon { width: 22px; height: 22px; border: 2px solid #546e7a; margin-right: 15px; display: flex; justify-content: center; align-items: center; }
        .radio .icon { border-radius: 50%; }
        .check .icon { border-radius: 4px; }
        .selected .radio .icon { border-color: var(--primary); }
        .selected .radio .icon::after { content:''; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; }
        .selected .check .icon::after { content:'âœ”'; color: var(--primary); font-size: 16px; font-weight: bold; }

        .eq-input { width: 100%; padding: 15px; font-size: 1.4rem; border: 2px solid #455a64; border-radius: 6px; }
        
        /* Table TEI */
        .tei-table { border-collapse: collapse; margin: 0 auto; }
        .tei-table td, .tei-table th { border: 1px solid #555; padding: 10px 20px; text-align: center; font-size: 1.1rem; }
        .tei-table input { width: 80px; padding: 5px; font-size: 1.1rem; text-align: center; border: 2px solid #000; }

        /* --- FEEDBACK --- */
        .feedback { margin-top: 25px; padding: 20px; border-radius: 8px; display: none; }
        .feedback.correct { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
        .feedback.wrong { background: #ffebee; color: #b71c1c; border: 1px solid #ffcdd2; }

        .btn-action { 
            margin-top: 25px; padding: 12px 30px; background: var(--primary); color: white; border: none; 
            border-radius: 6px; font-size: 1rem; font-weight: bold; cursor: pointer; float: right; 
        }
        .btn-action:disabled { background: #b0bec5; cursor: not-allowed; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-area">
            <h1>FAST Gr3 Acc.</h1>
            <p>Master Simulator</p>
        </div>
        
        <div class="sim-btn" onclick="App.startSim()">
            ðŸš€ Start Full Test Sim
        </div>

        <div class="menu-scroll" id="menu">
            </div>
    </div>

    <div class="main">
        <div class="q-container">
            <div class="q-header">
                <span class="badge" id="q-badge">Select a Standard or Start Sim</span>
                <span style="color:#78909c; font-weight:600;" id="score-display">Score: 0</span>
            </div>

            <div class="q-text" id="q-prompt">
                <strong>Welcome!</strong><br><br>
                1. <strong>Practice Mode:</strong> Click any standard in the left menu to drill that specific topic.<br>
                2. <strong>Test Sim:</strong> Click the Orange button to get a random mix of all standards.
            </div>

            <div class="visual-stage" id="q-visual" style="display:none;"></div>

            <div class="options-list" id="q-options"></div>

            <div class="feedback" id="q-feedback"></div>

            <button class="btn-action" id="btn-action" onclick="App.check()" disabled>Check Answer</button>
        </div>
    </div>

    <script>
        // --- 1. UTILITIES ---
        const Utils = {
            rInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
            pick: (arr) => arr[Math.floor(Math.random() * arr.length)],
            shuffle: (arr) => arr.sort(() => Math.random() - 0.5),

            genOptions: (correct, genFunc, count=3) => {
                const opts = new Set([correct]);
                let safety = 0;
                while(opts.size < count+1 && safety < 50) {
                    const d = genFunc();
                    if(d !== correct) opts.add(d);
                    safety++;
                }
                return Array.from(opts).sort(()=>Math.random()-0.5);
            },

            // --- SVG DRAWER ---
            svg: {
                clock: (h, m) => {
                    const hDeg = (h%12)*30 + m*0.5;
                    const mDeg = m*6;
                    let ticks = '';
                    for(let i=0; i<60; i++) {
                        const isHr = i%5===0;
                        ticks += `<line x1="50" y1="6" x2="50" y2="${isHr?10:7}" transform="rotate(${i*6} 50 50)" stroke="#333" stroke-width="${isHr?2:1}"/>`;
                    }
                    return `<svg width="180" height="180" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="48" stroke="#333" stroke-width="2" fill="white"/>
                        ${ticks}
                        <text x="50" y="22" text-anchor="middle" font-size="8" font-weight="bold">12</text>
                        <text x="82" y="53" text-anchor="middle" font-size="8" font-weight="bold">3</text>
                        <text x="50" y="86" text-anchor="middle" font-size="8" font-weight="bold">6</text>
                        <text x="18" y="53" text-anchor="middle" font-size="8" font-weight="bold">9</text>
                        <line x1="50" y1="50" x2="50" y2="28" stroke="black" stroke-width="3" transform="rotate(${hDeg} 50 50)" stroke-linecap="round"/>
                        <line x1="50" y1="50" x2="50" y2="15" stroke="#d32f2f" stroke-width="2" transform="rotate(${mDeg} 50 50)" stroke-linecap="round"/>
                        <circle cx="50" cy="50" r="3" fill="#333"/>
                    </svg>`;
                },
                rect: (w, h) => {
                    return `<svg width="200" height="150" viewBox="0 0 200 150">
                        <rect x="20" y="20" width="${w*15}" height="${h*15}" fill="#e0f2f1" stroke="#004d40" stroke-width="2"/>
                        <text x="${20 + (w*15)/2}" y="15" text-anchor="middle">${w} ft</text>
                        <text x="10" y="${20 + (h*15)/2}" text-anchor="middle">${h} ft</text>
                    </svg>`;
                },
                fractionLine: (num, den) => {
                     return `<svg width="300" height="60" viewBox="0 0 300 60">
                        <line x1="20" y1="30" x2="280" y2="30" stroke="#333" stroke-width="2"/>
                        <line x1="20" y1="25" x2="20" y2="35" stroke="#333" stroke-width="2"/>
                        <text x="20" y="50" text-anchor="middle" font-size="12">0</text>
                        <line x1="280" y1="25" x2="280" y2="35" stroke="#333" stroke-width="2"/>
                        <text x="280" y="50" text-anchor="middle" font-size="12">1</text>
                        <circle cx="${20 + (num/den)*260}" cy="30" r="6" fill="#e65100"/>
                        <text x="${20 + (num/den)*260}" y="20" text-anchor="middle" font-weight="bold" fill="#e65100">?</text>
                    </svg>`;
                },
                symmetry: (type) => {
                    if(type === 'yes') return `<svg width="100" height="100" viewBox="0 0 100 100"><path d="M50 10 L80 90 L20 90 Z" fill="#e0f2f1" stroke="black"/><line x1="50" y1="0" x2="50" y2="100" stroke="red" stroke-dasharray="4"/></svg>`;
                    return `<svg width="100" height="100" viewBox="0 0 100 100"><path d="M10 10 L80 10 L60 90 L10 90 Z" fill="#e0f2f1" stroke="black"/><line x1="45" y1="0" x2="45" y2="100" stroke="red" stroke-dasharray="4"/></svg>`;
                },
                barGraph: () => {
                    return `<svg width="200" height="120" viewBox="0 0 200 120">
                        <line x1="20" y1="100" x2="180" y2="100" stroke="#333"/>
                        <rect x="30" y="40" width="30" height="60" fill="#004d40"/><text x="45" y="115" text-anchor="middle" font-size="10">Pizza (60)</text>
                        <rect x="80" y="70" width="30" height="30" fill="#004d40"/><text x="95" y="115" text-anchor="middle" font-size="10">Salad (30)</text>
                        <rect x="130" y="20" width="30" height="80" fill="#004d40"/><text x="145" y="115" text-anchor="middle" font-size="10">Tacos (80)</text>
                    </svg>`;
                }
            }
        };

        // --- 2. MASTER QUESTION BANK (Complete) ---
        const Bank = {
            "Number Sense (NSO)": [
                { id: "MA.3.NSO.1.1", desc: "Read/Write Numbers", gen: () => {
                    const n = Utils.rInt(1001,9999);
                    const forms = [
                        {t: "Word Form", v: "Four thousand...", c: false}, 
                        {t: "Expanded Form", v: `${Math.floor(n/1000)*1000} + ${Math.floor((n%1000)/100)*100} + ${Math.floor((n%100)/10)*10} + ${n%10}`, c: true}
                    ];
                    return { text: `Select the correct <strong>Expanded Form</strong> for <strong>${n}</strong>.`, type: 'radio', options: Utils.genOptions(forms[1].v, ()=>`${Utils.rInt(1000,9000)} + ${Utils.rInt(100,900)}...`).map(x=>({t:x,c:x===forms[1].v})), fb: "Level 3: Read/Write numbers to 10,000." };
                }},
                { id: "MA.3.NSO.1.4", desc: "Rounding", gen: () => {
                    const n = Utils.rInt(120, 880);
                    const ans = Math.round(n/100)*100;
                    return { text: `Round <strong>${n}</strong> to the nearest hundred.`, type: 'equation', ans: ans.toString(), fb: "Level 3: Round to nearest 10 or 100." };
                }},
                { id: "MA.3.NSO.2.2", desc: "Multiplication Facts", gen: () => {
                    const a = Utils.rInt(6,9), b = Utils.rInt(7,9);
                    return { text: `Solve: <strong>${a} Ã— ${b}</strong>`, type: 'equation', ans: (a*b).toString(), fb: "Level 3: Recall multiplication facts." };
                }},
                { id: "MA.3.NSO.2.4", desc: "Mult: 1-digit x 2-digit", gen: () => {
                    const a = Utils.rInt(2,5), b = Utils.rInt(12,25);
                    return { text: `Solve: <strong>${b} Ã— ${a}</strong>`, type: 'equation', ans: (a*b).toString(), fb: "Level 3: Multiply 1-digit by 2-digit numbers." };
                }}
            ],
            "Algebraic Reasoning (AR)": [
                { id: "MA.3.AR.1.1", desc: "Distributive Property", gen: () => {
                    const a=Utils.rInt(3,9), b=Utils.rInt(12,19);
                    const ones = b-10;
                    return { text: `Which expression uses the Distributive Property for <strong>${a} Ã— ${b}</strong>?`, type: 'radio', options: Utils.shuffle([{t:`(${a}Ã—10) + (${a}Ã—${ones})`,c:true},{t:`(${a}Ã—10) Ã— (${a}Ã—${ones})`,c:false},{t:`${a} Ã— (10 Ã— ${ones})`,c:false}]), fb: "Level 3: Apply distributive property." };
                }},
                { id: "MA.3.AR.2.3", desc: "Missing Factors", gen: () => {
                    const a=Utils.rInt(4,9), b=Utils.rInt(4,9);
                    return { text: `Find the missing number: <br><strong>? Ã— ${a} = ${a*b}</strong>`, type: 'equation', ans: b.toString(), fb: "Level 3: Determine unknown whole number." };
                }},
                { id: "MA.3.AR.3.3", desc: "Number Patterns (Table)", gen: () => {
                    const rule = Utils.rInt(2,5);
                    return { text: `The rule is <strong>Multiply by ${rule}</strong>. Fill in the missing output.`, type: 'table', inputs:[3,5,9], outputs:[3*rule, 5*rule, 9*rule], missing:2, ans: (9*rule).toString(), fb: "Level 3: Identify patterns in tables." };
                }}
            ],
            "Fractions (FR)": [
                { id: "MA.3.FR.2.1", desc: "Fractions on Number Line", gen: () => {
                    const den = 4, num = Utils.rInt(1,3);
                    return { text: "What fraction is shown?", visual: Utils.svg.fractionLine(num,den), type: 'radio', options: Utils.genOptions(`${num}/${den}`, ()=>`${Utils.rInt(1,4)}/${Utils.rInt(2,5)}`).map(x=>({t:x,c:x===`${num}/${den}`})), fb: "Level 3: Identify fractions on number line." };
                }},
                { id: "MA.3.FR.2.2", desc: "Equivalent Fractions", gen: () => {
                    return { text: "Select <strong>ALL</strong> fractions equal to 1/2.", type: 'multi', options: Utils.shuffle([{t:"2/4",c:true},{t:"3/6",c:true},{t:"1/3",c:false},{t:"4/8",c:true}]), fb: "Level 4: Identify equivalent fractions." };
                }}
            ],
            "Geometry (GR)": [
                { id: "MA.3.GR.1.3", desc: "Symmetry", gen: () => {
                    const isSym = Math.random()>0.5;
                    return { text: "Does the red line show a Line of Symmetry?", visual: Utils.svg.symmetry(isSym?'yes':'no'), type: 'radio', options: [{t:"Yes",c:isSym},{t:"No",c:!isSym}], fb: "Level 3: Identify lines of symmetry." };
                }},
                { id: "MA.3.GR.2.1", desc: "Area", gen: () => {
                    const w=Utils.rInt(4,9), h=Utils.rInt(3,8);
                    return { text: "Find the Area.", visual: Utils.svg.rect(w,h), type: 'equation', ans: (w*h).toString(), fb: "Level 3: Solve area problems." };
                }}
            ],
            "Measurement (M)": [
                { id: "MA.3.M.2.1", desc: "Telling Time", gen: () => {
                    const h=Utils.rInt(1,12), m=Utils.rInt(10,55);
                    return { text: "What time is shown?", visual: Utils.svg.clock(h,m), type: 'radio', options: Utils.genOptions(`${h}:${m}`, ()=>`${Utils.rInt(1,12)}:${Utils.rInt(10,59)}`).map(x=>({t:x,c:x===`${h}:${m}`})), fb: "Level 3: Tell time to nearest minute." };
                }},
                { id: "MA.3.M.2.2", desc: "Elapsed Time", gen: () => {
                    return { text: "Start: 2:15 PM. Duration: 45 min. End time?", type: 'radio', options: [{t:"3:00 PM",c:true},{t:"2:50 PM",c:false},{t:"3:15 PM",c:false}], fb: "Level 4: Solve elapsed time problems." };
                }}
            ],
            "Data (DP)": [
                { id: "MA.3.DP.1.1", desc: "Interpreting Graphs", gen: () => {
                    return { text: "Based on the graph, how many more people chose Tacos (80) than Pizza (60)?", visual: Utils.svg.barGraph(), type: 'equation', ans: "20", fb: "Level 3: Solve problems using bar graphs." };
                }}
            ]
        };

        // --- 3. APP CONTROLLER ---
        const App = {
            mode: 'practice', 
            currentQ: null,
            score: 0,
            
            init: function() {
                const menu = document.getElementById('menu');
                // FIX: Use createElement instead of innerHTML to preserve logic
                for(const cat in Bank) {
                    const header = document.createElement('div');
                    header.className = 'menu-cat';
                    header.innerText = cat;
                    menu.appendChild(header);

                    Bank[cat].forEach(std => {
                        const btn = document.createElement('div');
                        btn.className = 'std-btn';
                        btn.innerHTML = `<strong>${std.id}</strong><small>${std.desc}</small>`;
                        btn.onclick = () => App.loadPractice(std);
                        menu.appendChild(btn);
                    });
                }
            },

            startSim: function() {
                this.mode = 'sim';
                this.score = 0;
                document.getElementById('score-display').innerText = "Score: 0";
                document.getElementById('q-badge').innerText = "Test Simulation Mode";
                
                // Flatten standards for random pick
                this.allGens = [];
                for(const cat in Bank) Bank[cat].forEach(s => this.allGens.push(s));
                
                this.nextSimQ();
            },

            nextSimQ: function() {
                const std = Utils.pick(this.allGens);
                this.loadQ(std.gen(), std.id);
            },

            loadPractice: function(std) {
                this.mode = 'practice';
                this.currentStd = std;
                this.loadQ(std.gen(), std.id);
            },

            loadQ: function(q, stdId) {
                this.currentQ = q;
                
                // UI Update
                document.getElementById('q-badge').innerText = this.mode === 'sim' ? `Sim Mode: ${stdId}` : `Practice: ${stdId}`;
                document.getElementById('q-prompt').innerHTML = q.text;
                
                // Visuals
                const v = document.getElementById('q-visual');
                v.style.display = q.visual ? 'flex' : 'none';
                v.innerHTML = q.visual || '';
                
                // Reset Input Area
                const list = document.getElementById('q-options');
                list.innerHTML = '';
                const btnAction = document.getElementById('btn-action');
                btnAction.innerText = "Check Answer";
                btnAction.disabled = true;
                btnAction.onclick = () => App.check();
                
                document.getElementById('q-feedback').style.display = 'none';

                // Render Inputs
                if(q.type === 'radio' || q.type === 'multi') {
                    q.options.forEach((opt, i) => {
                        const btn = document.createElement('div');
                        btn.className = `opt-btn ${q.type}`;
                        btn.innerHTML = `<div class="icon"></div> ${opt.t}`;
                        btn.onclick = () => {
                            if(q.type === 'radio') {
                                document.querySelectorAll('.opt-btn').forEach(b=>b.classList.remove('selected'));
                                btn.classList.add('selected');
                                App.selection = i;
                            } else {
                                btn.classList.toggle('selected');
                            }
                            btnAction.disabled = false;
                        };
                        list.appendChild(btn);
                    });
                } else if (q.type === 'equation') {
                    list.innerHTML = `<input type="text" class="eq-input" id="user-eq" placeholder="Type answer...">`;
                    // Wait for DOM to append before attaching listener
                    setTimeout(() => {
                        document.getElementById('user-eq').addEventListener('input', (e) => btnAction.disabled = e.target.value === '');
                    }, 0);
                } else if (q.type === 'table') {
                    let html = `<table class="tei-table"><tr><th>In</th><th>Out</th></tr>`;
                    q.inputs.forEach((val, i) => {
                        const cell = i === q.missing ? `<input type="number" id="tbl-in">` : q.outputs[i];
                        html += `<tr><td>${val}</td><td>${cell}</td></tr>`;
                    });
                    html += `</table>`;
                    list.innerHTML = html;
                    setTimeout(() => document.getElementById('tbl-in').addEventListener('input', () => btnAction.disabled = false), 0);
                }
            },

            check: function() {
                const q = this.currentQ;
                let isCorr = false;
                
                if(q.type === 'radio') isCorr = q.options[this.selection].c;
                if(q.type === 'multi') {
                    const sel = [];
                    document.querySelectorAll('.opt-btn').forEach((b,i) => { if(b.classList.contains('selected')) sel.push(i); });
                    const cor = q.options.map((o,i)=>o.c?i:null).filter(x=>x!==null);
                    if(sel.length===cor.length && sel.every(v=>cor.includes(v))) isCorr = true;
                }
                if(q.type === 'equation') isCorr = document.getElementById('user-eq').value.trim() === q.ans;
                if(q.type === 'table') isCorr = document.getElementById('tbl-in').value.trim() === q.ans;

                const fb = document.getElementById('q-feedback');
                fb.style.display = 'block';
                fb.className = `feedback ${isCorr ? 'correct' : 'wrong'}`;
                fb.innerHTML = `<strong>${isCorr ? 'Correct!' : 'Incorrect.'}</strong><br>${q.fb}`;

                if(isCorr) {
                    this.score += 10;
                    document.getElementById('score-display').innerText = `Score: ${this.score}`;
                }

                const btn = document.getElementById('btn-action');
                btn.innerText = "Next Question";
                btn.onclick = () => {
                    if(this.mode === 'sim') this.nextSimQ();
                    else this.loadPractice(this.currentStd);
                };
            }
        };

        // Start
        App.init();

    </script>
</body>
</html>
