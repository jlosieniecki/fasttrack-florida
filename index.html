<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAST Grade 3 Accelerated Math Simulator (Ultimate)</title>
    <style>
        :root {
            --primary: #005ea2; /* FL DOE Blue */
            --secondary: #e1f3f8;
            --text: #1b1b1b;
            --border: #888;
            --success: #2e8540;
            --error: #d93025;
            --flag: #e37400;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f9f9f9;
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER & NAV --- */
        header {
            background: white;
            border-bottom: 4px solid #000;
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h1 { font-size: 1.2rem; margin: 0; color: var(--primary); font-weight: 800; }
        
        .timer-box {
            font-family: monospace;
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            background: #eee;
            padding: 5px 15px;
            border-radius: 4px;
        }

        .tools { display: flex; gap: 10px; }
        .tool-btn {
            background: white; border: 1px solid #333; padding: 5px 12px;
            cursor: pointer; font-size: 0.9rem; border-radius: 4px;
        }
        .tool-btn:hover { background: #eee; }

        /* --- LAYOUTS --- */
        .screen { display: none; height: 100%; overflow-y: auto; padding: 20px; }
        .screen.active { display: block; }

        /* --- HOME DASHBOARD --- */
        .dash-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 1100px;
            margin: 40px auto;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-top: 6px solid var(--primary);
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-5px); }

        .domain-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .domain-btn {
            padding: 12px; border: 1px solid var(--primary); color: var(--primary);
            background: var(--secondary); text-align: center; cursor: pointer; font-weight: bold; border-radius: 4px;
        }
        .domain-btn:hover { background: var(--primary); color: white; }

        /* --- TEST INTERFACE --- */
        .test-wrapper {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 80vh;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            border: 1px solid #ccc;
        }

        .q-panel { flex: 3; padding: 40px; border-right: 1px solid #ddd; }
        .nav-panel { flex: 1; padding: 20px; background: #fafafa; }

        .q-meta { display: flex; justify-content: space-between; margin-bottom: 20px; color: #666; font-size: 0.9rem; }
        .std-badge { background: #eee; padding: 3px 8px; border-radius: 4px; font-weight: bold; }

        .q-text { font-size: 1.3rem; line-height: 1.5; margin-bottom: 25px; }

        /* --- VISUALS --- */
        .visual-area { margin: 20px 0; padding: 20px; border: 1px solid #eee; display: flex; justify-content: center; background: #fff; }

        /* --- INPUTS --- */
        .options-group { display: grid; gap: 12px; }
        .option-row {
            display: flex; align-items: center; padding: 15px;
            border: 2px solid #ccc; border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .option-row:hover { border-color: #999; background: #f9f9f9; }
        .option-row.selected { border-color: var(--primary); background: #eef6fc; border-width: 3px; }

        .bubble {
            width: 24px; height: 24px; border: 2px solid #555; margin-right: 15px;
            display: flex; align-items: center; justify-content: center;
        }
        .radio .bubble { border-radius: 50%; }
        .check .bubble { border-radius: 4px; }
        
        .selected .radio .bubble::after { content: ''; width: 14px; height: 14px; background: var(--primary); border-radius: 50%; }
        .selected .check .bubble::after { content: '‚úî'; font-weight: bold; color: var(--primary); font-size: 16px; }

        .eq-input {
            width: 100%; padding: 15px; font-size: 1.2rem;
            border: 2px solid #333; border-radius: 4px;
        }

        /* --- FEEDBACK & FOOTER --- */
        .feedback-box {
            margin-top: 25px; padding: 20px; border-radius: 6px; display: none;
            border-left: 5px solid transparent;
        }
        .feedback-box.correct { background: #e6f4ea; border-left-color: var(--success); color: #0d5122; }
        .feedback-box.incorrect { background: #fce8e6; border-left-color: var(--error); color: #8a1f1f; }

        .footer { padding: 15px 30px; background: #333; color: white; display: flex; justify-content: space-between; }
        .btn { padding: 10px 25px; cursor: pointer; font-size: 1rem; border: none; border-radius: 4px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-sec { background: #666; color: white; }

        /* --- NAV GRID --- */
        .grid-map { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 10px; }
        .grid-item {
            padding: 8px; border: 1px solid #ccc; text-align: center; cursor: pointer; background: white;
        }
        .grid-item.active { border: 2px solid black; font-weight: bold; }
        .grid-item.answered { background: #e6f4ea; color: var(--success); }
        .grid-item.flagged { border-color: var(--flag); color: var(--flag); }
        .grid-item.flagged::before { content: 'üö© '; font-size: 0.8rem; }

    </style>
</head>
<body>

    <header>
        <h1>FAST Grade 3 Accelerated Simulator</h1>
        <div class="tools">
            <button class="tool-btn" onclick="App.toggleFlag()">üö© Flag Item</button>
            <div id="timer" class="timer-box">--:--</div>
        </div>
    </header>

    <div id="screen-home" class="screen active">
        <div class="dash-grid">
            <div class="card">
                <h2>üìù Full Test Simulation</h2>
                <p><strong>Simulation Mode:</strong></p>
                <ul>
                    <li>60 Minutes</li>
                    <li>32 Questions (All Standards)</li>
                    <li>No Repeats (Unique Session)</li>
                    <li>Feedback hidden until end</li>
                </ul>
                <button class="btn btn-primary" style="width:100%" onclick="App.startSession('sim')">Start Mock Test</button>
            </div>
            
            <div class="card">
                <h2>üéØ Targeted Practice</h2>
                <p>Select a domain to practice. Instant feedback and Level 5 descriptors included.</p>
                <div class="domain-list">
                    <div class="domain-btn" onclick="App.startSession('practice', 'NSO')">Number Sense</div>
                    <div class="domain-btn" onclick="App.startSession('practice', 'FR')">Fractions</div>
                    <div class="domain-btn" onclick="App.startSession('practice', 'AR')">Algebra</div>
                    <div class="domain-btn" onclick="App.startSession('practice', 'GR')">Geometry</div>
                    <div class="domain-btn" onclick="App.startSession('practice', 'DP')">Data/Msmt</div>
                    <div class="domain-btn" onclick="App.startSession('practice', 'M')">Time/Length</div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-test" class="screen">
        <div class="test-wrapper">
            <div class="q-panel">
                <div class="q-meta">
                    <span id="q-counter">Question 1</span>
                    <span id="q-std" class="std-badge">MA.3.NSO.1.1</span>
                </div>
                
                <div id="q-text" class="q-text"></div>
                <div id="q-visual" class="visual-area" style="display:none;"></div>
                <div id="q-input"></div>

                <div id="feedback" class="feedback-box"></div>
            </div>

            <div class="nav-panel">
                <h3>Session Map</h3>
                <div id="nav-grid" class="grid-map"></div>
                <hr>
                <div style="font-size:0.85rem; color:#555; line-height: 1.6;">
                    <strong>Tech-Enhanced Items:</strong><br>
                    ‚Ä¢ Equation Editor<br>
                    ‚Ä¢ Multi-Select (Checkboxes)<br>
                    ‚Ä¢ Visual Models
                </div>
            </div>
        </div>

        <div class="footer">
            <button class="btn btn-sec" onclick="App.nav(-1)">Back</button>
            <button class="btn btn-primary" id="btn-check" onclick="App.check()">Check Answer</button>
            <button class="btn btn-primary" id="btn-next" style="display:none;" onclick="App.nav(1)">Next Question</button>
        </div>
    </div>

    <script>
        /**
         * ULTIMATE GRADE 3 ACCELERATED ENGINE
         * Features: SVG Clock (w/ Minutes), Anti-Repeat, Full Standards
         */
        
        const Utils = {
            rInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
            shuffle: (arr) => arr.sort(() => Math.random() - 0.5),
            
            // --- SVG GRAPHICS GENERATORS ---
            
            // 1. CLOCK (Precise Minute Hands)
            drawClock: (h, m) => {
                const hDeg = (h % 12) * 30 + (m * 0.5);
                const mDeg = m * 6;
                
                // Generate 60 ticks
                let ticks = '';
                for(let i=0; i<60; i++) {
                    const isHour = i % 5 === 0;
                    const len = isHour ? 10 : 5;
                    const width = isHour ? 2 : 1;
                    const rot = i * 6;
                    ticks += `<line x1="50" y1="5" x2="50" y2="${5+len}" stroke="black" stroke-width="${width}" transform="rotate(${rot} 50 50)" />`;
                }

                return `
                <svg width="200" height="200" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="48" stroke="black" stroke-width="2" fill="white"/>
                    ${ticks}
                    <text x="50" y="22" text-anchor="middle" font-size="8" font-weight="bold">12</text>
                    <text x="82" y="53" text-anchor="middle" font-size="8" font-weight="bold">3</text>
                    <text x="50" y="85" text-anchor="middle" font-size="8" font-weight="bold">6</text>
                    <text x="18" y="53" text-anchor="middle" font-size="8" font-weight="bold">9</text>
                    <line x1="50" y1="50" x2="50" y2="25" stroke="black" stroke-width="3.5" transform="rotate(${hDeg} 50 50)" stroke-linecap="round"/>
                    <line x1="50" y1="50" x2="50" y2="15" stroke="black" stroke-width="2" transform="rotate(${mDeg} 50 50)" stroke-linecap="round"/>
                    <circle cx="50" cy="50" r="3" fill="black"/>
                </svg>`;
            },

            // 2. NUMBER LINE (Fractions)
            drawNumberLine: (num, den) => {
                const step = 260 / den;
                let ticks = '';
                for(let i=0; i<=den; i++) {
                    ticks += `<line x1="${20 + i*step}" y1="20" x2="${20 + i*step}" y2="35" stroke="black" stroke-width="2"/>`;
                }
                const ptX = 20 + (num/den)*260;

                return `
                <svg width="350" height="60" viewBox="0 0 300 60">
                    <line x1="10" y1="28" x2="290" y2="28" stroke="black" stroke-width="2"/>
                    <text x="15" y="55" font-size="12">0</text>
                    <text x="285" y="55" font-size="12">1</text>
                    ${ticks}
                    <circle cx="${ptX}" cy="28" r="7" fill="#cd2026"/>
                </svg>`;
            },

            // 3. BAR GRAPH
            drawBarGraph: (data) => {
                const max = Math.max(...data.map(d=>d.v));
                let bars = '';
                data.forEach((d, i) => {
                    const h = (d.v/max) * 80;
                    bars += `<rect x="${20 + i*50}" y="${100-h}" width="30" height="${h}" fill="#005ea2"/>`;
                    bars += `<text x="${35 + i*50}" y="115" text-anchor="middle" font-size="10">${d.k}</text>`;
                    bars += `<text x="${35 + i*50}" y="${95-h}" text-anchor="middle" font-size="10">${d.v}</text>`;
                });
                return `<svg width="250" height="130" viewBox="0 0 200 130">
                    <line x1="10" y1="100" x2="190" y2="100" stroke="black"/>
                    ${bars}
                </svg>`;
            }
        };

        // --- QUESTION GENERATOR (Anti-Repeat Logic) ---
        class QuestionBank {
            constructor() {
                // Defines the available templates. 
                // We use function generators to ensure unique numbers every time.
                this.templates = {
                    // NSO
                    'NSO': [
                        () => { // Rounding
                            const n = Utils.rInt(100, 900);
                            return { std: "MA.3.NSO.1.4", text: `Round <strong>${n}</strong> to the nearest 100.`, type: "equation", val: Math.round(n/100)*100, ald: "Level 3: Rounds whole numbers to the nearest 10 or 100." };
                        },
                        () => { // Place Value
                            const base = Utils.rInt(1000, 9000);
                            return { std: "MA.3.NSO.1.2", text: `What is the value of the digit <strong>${Math.floor(base/1000)}</strong> in the number ${base}?`, type: "radio", options: [{t:"1,000",c:false},{t:`${Math.floor(base/1000)*1000}`,c:true},{t:`${Math.floor(base/1000)*100}`,c:false}], ald: "Level 3: Composes/Decomposes 4-digit numbers." };
                        },
                        () => { // Addition
                            const a = Utils.rInt(1000, 5000), b = Utils.rInt(1000, 4000);
                            return { std: "MA.3.NSO.2.1", text: `Find the sum: ${a} + ${b}`, type: "equation", val: a+b, ald: "Level 3: Adds multi-digit whole numbers." };
                        }
                    ],
                    // FR
                    'FR': [
                        () => { // Number Line
                            const den = Utils.rInt(3, 8);
                            const num = Utils.rInt(1, den-1);
                            return { std: "MA.3.FR.2.1", text: "What fraction is shown on the number line?", visual: Utils.drawNumberLine(num, den), type: "radio", options: Utils.shuffle([{t:`${num}/${den}`,c:true},{t:`${den}/${num}`,c:false},{t:`1/${den}`,c:false},{t:`${num}/${den+1}`,c:false}]), ald: "Level 3: Identifies fractions on a number line." };
                        },
                        () => { // Equivalence
                            return { std: "MA.3.FR.2.2", text: "Select <strong>ALL</strong> fractions equivalent to 1/3.", type: "check", options: [{t:"2/6",c:true},{t:"3/9",c:true},{t:"2/3",c:false},{t:"4/12",c:true}], ald: "Level 4: Identifies equivalent fractions." };
                        }
                    ],
                    // AR
                    'AR': [
                        () => { // Missing Factor
                            const a = Utils.rInt(4,9), b = Utils.rInt(4,9);
                            return { std: "MA.3.AR.2.3", text: `Fill in the missing number: <br> ? √ó ${a} = ${a*b}`, type: "equation", val: b, ald: "Level 3: Determines unknown whole number in multiplication." };
                        },
                        () => { // Pattern
                            const start = Utils.rInt(2,10), add = Utils.rInt(2,5);
                            return { std: "MA.3.AR.3.2", text: `Identify the rule for the pattern: ${start}, ${start+add}, ${start+add*2}, ${start+add*3}...`, type: "radio", options: Utils.shuffle([{t:`Add ${add}`,c:true},{t:`Multiply by ${add}`,c:false},{t:`Add ${add+1}`,c:false}]), ald: "Level 3: Identifies numerical patterns." };
                        }
                    ],
                    // M / Time
                    'M': [
                        () => { // Clock
                            const h = Utils.rInt(1, 12);
                            const m = Utils.rInt(1, 59); // ANY minute
                            const mStr = m < 10 ? '0'+m : m;
                            return { 
                                std: "MA.3.M.2.1", 
                                text: "What time is shown on the clock?", 
                                visual: Utils.drawClock(h, m),
                                type: "radio", 
                                options: Utils.shuffle([
                                    {t:`${h}:${mStr}`, c:true},
                                    {t:`${h===1?12:h-1}:${mStr}`, c:false},
                                    {t:`${h}:${m<10?m+'0':m+5}`, c:false}
                                ]), 
                                ald: "Level 3: Tells time to the nearest minute." 
                            };
                        }
                    ],
                    // DP
                    'DP': [
                        () => { // Bar Graph
                            const v1=Utils.rInt(5,15), v2=Utils.rInt(5,15);
                            return { 
                                std: "MA.3.DP.1.1", 
                                text: "How many total votes for A and B?", 
                                visual: Utils.drawBarGraph([{k:'A',v:v1},{k:'B',v:v2},{k:'C',v:Utils.rInt(2,8)}]), 
                                type: "equation", 
                                val: v1+v2, 
                                ald: "Level 3: Solves problems using bar graphs." 
                            };
                        }
                    ],
                    // GR
                    'GR': [
                        () => {
                            return { std: "MA.3.GR.1.2", text: "Select <strong>ALL</strong> rectangles.", type: "check", options: [{t:"Square",c:true},{t:"Trapezoid",c:false},{t:"A shape with 4 right angles",c:true}], ald: "Level 3: Identifies quadrilaterals." };
                        }
                    ]
                };
            }

            // Generate a session list
            getQuestions(mode, domain) {
                let list = [];
                let usedSignatures = new Set(); // Prevent Repeats

                // 1. Determine Source
                let keys = (mode === 'sim') ? Object.keys(this.templates) : [domain];
                
                // 2. Loop to fill questions
                const targetCount = (mode === 'sim') ? 20 : 10;
                
                let attempts = 0;
                while(list.length < targetCount && attempts < 1000) {
                    attempts++;
                    
                    // Pick random domain from allowed keys
                    const k = keys[Math.floor(Math.random() * keys.length)];
                    const tmpls = this.templates[k];
                    // Run random generator
                    const qData = tmpls[Math.floor(Math.random() * tmpls.length)]();
                    
                    // 3. Anti-Repeat Check
                    // We create a "signature" based on the text + answer
                    const sig = qData.text + (qData.val || JSON.stringify(qData.options));
                    
                    if(!usedSignatures.has(sig)) {
                        usedSignatures.add(sig);
                        qData.id = list.length;
                        list.push(qData);
                    }
                }
                return list;
            }
        }

        // --- APP CONTROLLER ---
        const App = {
            bank: new QuestionBank(),
            state: {
                mode: null,
                questions: [],
                responses: {},
                flags: [],
                idx: 0,
                timer: 0
            },

            startSession: function(mode, domain) {
                this.state.mode = mode;
                this.state.questions = this.bank.getQuestions(mode, domain);
                this.state.responses = {};
                this.state.flags = [];
                this.state.idx = 0;

                // UI Switch
                document.getElementById('screen-home').classList.remove('active');
                document.getElementById('screen-test').classList.add('active');
                
                // Mode Settings
                const isSim = mode === 'sim';
                document.getElementById('btn-check').style.display = isSim ? 'none' : 'inline-block';
                document.getElementById('btn-next').style.display = isSim ? 'inline-block' : 'none';
                
                // Timer
                this.state.timer = isSim ? 3600 : 0;
                this.runTimer(isSim);

                this.renderQ();
                this.renderGrid();
            },

            renderQ: function() {
                const q = this.state.questions[this.state.idx];
                const r = this.state.responses[this.state.idx];

                // Header
                document.getElementById('q-counter').innerText = `Question ${this.state.idx + 1} of ${this.state.questions.length}`;
                document.getElementById('q-std').innerText = q.std;
                document.getElementById('q-text').innerHTML = q.text;
                document.getElementById('feedback').style.display = 'none';

                // Visual
                const vBox = document.getElementById('q-visual');
                if(q.visual) { vBox.style.display = 'flex'; vBox.innerHTML = q.visual; }
                else { vBox.style.display = 'none'; }

                // Input
                const iBox = document.getElementById('q-input');
                iBox.innerHTML = '';

                if(q.type === 'radio' || q.type === 'check') {
                    const grp = document.createElement('div');
                    grp.className = 'options-group';
                    q.options.forEach((opt, i) => {
                        const row = document.createElement('div');
                        const isSel = q.type === 'radio' ? (r === i) : (r && r.includes(i));
                        
                        row.className = `option-row ${q.type} ${isSel ? 'selected' : ''}`;
                        row.innerHTML = `<div class="bubble"></div> ${opt.t}`;
                        row.onclick = () => {
                            if(q.type === 'radio') this.save(i);
                            else {
                                let curr = this.state.responses[this.state.idx] || [];
                                if(curr.includes(i)) curr = curr.filter(x=>x!==i);
                                else curr.push(i);
                                this.save(curr);
                            }
                        };
                        grp.appendChild(row);
                    });
                    iBox.appendChild(grp);
                } else if (q.type === 'equation') {
                    const inp = document.createElement('input');
                    inp.className = 'eq-input';
                    inp.placeholder = 'Type answer here...';
                    inp.value = r || '';
                    inp.oninput = (e) => this.save(e.target.value);
                    iBox.appendChild(inp);
                }
            },

            save: function(val) {
                this.state.responses[this.state.idx] = val;
                if(this.state.mode !== 'sim') this.renderQ(); // Instant update for practice
                this.renderGrid();
            },

            renderGrid: function() {
                const grid = document.getElementById('nav-grid');
                grid.innerHTML = '';
                this.state.questions.forEach((q, i) => {
                    const el = document.createElement('div');
                    const isAns = this.state.responses[i] !== undefined && this.state.responses[i] !== '';
                    const isFlag = this.state.flags.includes(i);
                    el.className = `grid-item ${i===this.state.idx ? 'active' : ''} ${isAns ? 'answered' : ''} ${isFlag ? 'flagged' : ''}`;
                    el.innerText = i + 1;
                    el.onclick = () => { this.state.idx = i; this.renderQ(); this.renderGrid(); };
                    grid.appendChild(el);
                });
            },

            check: function() {
                const q = this.state.questions[this.state.idx];
                const r = this.state.responses[this.state.idx];
                const fb = document.getElementById('feedback');
                let ok = false;

                if(q.type === 'radio') ok = q.options[r]?.c;
                if(q.type === 'equation') ok = parseInt(r) === q.val;
                if(q.type === 'check') {
                    const needs = q.options.map((o,i)=>o.c?i:null).filter(x=>x!==null);
                    if(r && r.length === needs.length && r.every(v=>needs.includes(v))) ok = true;
                }

                fb.style.display = 'block';
                fb.className = `feedback-box ${ok ? 'correct' : 'incorrect'}`;
                fb.innerHTML = `<strong>${ok ? 'Correct!' : 'Incorrect'}</strong><br>${q.ald}`;
                
                if(ok) document.getElementById('btn-next').style.display = 'inline-block';
            },

            nav: function(dir) {
                const n = this.state.idx + dir;
                if(n >= 0 && n < this.state.questions.length) {
                    this.state.idx = n;
                    this.renderQ();
                    this.renderGrid();
                    // Reset Practice Buttons
                    if(this.state.mode !== 'sim') {
                        document.getElementById('btn-next').style.display = 'none';
                        document.getElementById('feedback').style.display = 'none';
                    }
                }
            },

            toggleFlag: function() {
                const i = this.state.idx;
                if(this.state.flags.includes(i)) this.state.flags = this.state.flags.filter(x=>x!==i);
                else this.state.flags.push(i);
                this.renderGrid();
            },

            runTimer: function(isSim) {
                if(!isSim) { document.getElementById('timer').innerText = "Practice"; return; }
                const t = document.getElementById('timer');
                const int = setInterval(() => {
                    this.state.timer--;
                    const m = Math.floor(this.state.timer / 60);
                    const s = this.state.timer % 60;
                    t.innerText = `${m}:${s<10?'0'+s:s}`;
                    if(this.state.timer <= 0) clearInterval(int);
                }, 1000);
            }
        };

    </script>
</body>
</html>
