<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FAST Grade 3 Math Mastery</title>
    <style>
        :root { --header: #2C3E50; --bg: #F0F4F8; --active: #00609C; --text: #333; }
        
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* SCREENS */
        .screen { display: none; height: 100%; width: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* MENU */
        .menu-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, #003057, #005085); color: white; padding: 15px; }
        .menu-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; color: #333; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .menu-btn { display: block; width: 100%; padding: 15px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 1.05em; cursor: pointer; transition: 0.2s; background: #fff; text-align: left; position: relative; }
        .menu-btn:hover { background: #f0f8ff; border-color: var(--active); padding-left: 20px; }
        .menu-btn strong { display: block; color: #003057; }
        .menu-btn small { color: #666; font-size: 0.85em; }

        /* TEST UI */
        .top-bar { background: #fff; border-bottom: 1px solid #ddd; color: #333; padding: 0 15px; height: 50px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .tool-btn { background: #f9f9f9; border: 1px solid #ccc; color: #555; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; margin-left:5px; }
        
        .main-stage { flex: 1; padding: 10px; overflow: hidden; display: flex; gap: 10px; height: 100%; }
        .pane { background: white; border-radius: 4px; padding: 20px; overflow-y: auto; border: 1px solid #e0e0e0; height: 100%; box-sizing: border-box; }
        
        .left-pane { width: 40%; background: #FAFAFA; border-right: 1px solid #ddd; display: flex; align-items: center; justify-content: center; padding: 10px; }
        .right-pane { width: 60%; }
        @media (max-width: 768px) {
            .main-stage { flex-direction: column; }
            .left-pane { width: 100%; height: 35%; border-right: none; border-bottom: 2px solid #ddd; }
            .right-pane { width: 100%; height: 65%; }
        }

        /* QUESTIONS */
        .q-header { color: #00609C; font-weight: bold; margin-bottom: 10px; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; }
        .q-text { font-size: 1.25em; line-height: 1.5; color: #222; margin-bottom: 20px; }
        svg { width: 100%; height: auto; max-height: 220px; }

        /* INTERACTION TYPES */
        /* Choice */
        .opt-row { display: flex; padding: 12px; margin-bottom: 8px; cursor: pointer; border: 1px solid #eee; border-radius: 6px; align-items: center; background: #fff; transition:0.1s; }
        .opt-row:hover { background: #f9f9f9; border-color: #ccc; }
        .opt-row.selected { background: #E3F2FD; border-color: var(--active); font-weight: bold; border-left: 5px solid var(--active); }
        .bubble { width: 22px; height: 22px; border: 2px solid #7f8c8d; border-radius: 50%; margin-right: 12px; flex-shrink: 0; background: white; }
        .opt-row.selected .bubble { background: var(--active); border-color: var(--active); }
        .bubble.square { border-radius: 4px; } /* Multi-select */

        /* Input */
        .input-box { font-size: 1.3em; padding: 8px; width: 120px; text-align: center; border: 2px solid #ccc; border-radius: 6px; }
        
        /* Inline Choice (Dropdowns) */
        .inline-select { font-size: 1.1em; padding: 5px; border: 2px solid #00609C; border-radius: 4px; background: white; color: #333; font-weight: bold; cursor: pointer; margin: 0 5px; }

        /* Table Match */
        .match-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .match-table th, .match-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .match-table th { background: #f5f5f5; color: #555; }
        .radio-big { width: 20px; height: 20px; accent-color: var(--active); cursor: pointer; }

        /* FOOTER */
        .nav-bar { background: white; border-top: 1px solid #ddd; height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0; }
        .nav-btn { background: var(--active); color: white; border: none; padding: 10px 20px; border-radius: 4px; font-size: 1em; font-weight: bold; cursor: pointer; min-width: 90px; }

        /* REPORT CARD */
        .level-badge { display: inline-block; padding: 8px 20px; border-radius: 20px; color: white; font-weight: bold; font-size: 1.4em; margin: 15px 0; }
        .lvl-1 { background: #D32F2F; } .lvl-2 { background: #F57C00; } .lvl-3 { background: #FBC02D; color: #000; } .lvl-4 { background: #388E3C; } .lvl-5 { background: #00796B; }
        
        .strength-grid { display: grid; grid-template-columns: 1fr; gap: 10px; text-align: left; margin-top: 20px; }
        .strength-box { padding: 12px; border-radius: 6px; background: #f9f9f9; border-left: 5px solid #ccc; font-size: 0.95em; }
        .good { border-left-color: #388E3C; } .bad { border-left-color: #D32F2F; }
    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <div class="menu-container">
            <div class="menu-card">
                <img src="Gemini_Generated_Image_t8043ht8043ht804.png" style="width:70px; border-radius:10px; margin-bottom:15px;" alt="Logo">
                <h2 style="margin:0 0 10px 0;">FAST Math Portal</h2>
                <p style="color:#666; margin-bottom:20px;">Grade 3 B.E.S.T. Standards Mastery</p>
                
                <button class="menu-btn" onclick="initSession('ALL', 35)">
                    <strong>üöÄ Full Mock Exam (35 Items)</strong>
                    <small>Comprehensive test across all 5 domains.</small>
                </button>
                <button class="menu-btn" onclick="initSession('NSO', 15)">
                    <strong>üî¢ Number Sense & Ops</strong>
                    <small>Place Value, Add/Sub, Mult/Div Facts</small>
                </button>
                <button class="menu-btn" onclick="initSession('FR', 15)">
                    <strong>üçï Fractions</strong>
                    <small>Models, Equivalence, Comparisons</small>
                </button>
                <button class="menu-btn" onclick="initSession('AR', 15)">
                    <strong>üß† Algebraic Reasoning</strong>
                    <small>Patterns, Logic, Multi-step Problems</small>
                </button>
                <button class="menu-btn" onclick="initSession('GR', 15)">
                    <strong>üìê Geometry & Measurement</strong>
                    <small>Area, Perimeter, Time, Attributes</small>
                </button>
                <button class="menu-btn" onclick="initSession('DP', 10)">
                    <strong>üìä Data Analysis</strong>
                    <small>Bar Graphs, Pictographs, Scaling</small>
                </button>
            </div>
        </div>
    </div>

    <div id="screen-test" class="screen">
        <div class="top-bar">
            <div><strong>Student: Guest</strong> | <span id="session-label">Test</span></div>
            <div>
                <button class="tool-btn" onclick="toggleZoom()">üîç Zoom</button>
                <button class="tool-btn" onclick="alert('Reference Sheet:\n\n1 ft = 12 in\n1 yd = 3 ft\n1 min = 60 sec')">üìÑ Formulas</button>
                <button class="tool-btn" style="background:#C0392B; color:white; border:none;" onclick="location.reload()">Exit</button>
            </div>
        </div>

        <div id="stage" class="main-stage"></div>

        <div class="nav-bar">
            <button class="nav-btn" style="background:white; color:#333; border:1px solid #ccc;" onclick="prevQ()">Back</button>
            <div style="font-weight:bold; color:#555;">Item <span id="q-idx">1</span> of <span id="q-total">35</span></div>
            <button id="btn-next" class="nav-btn" onclick="nextQ()">Next</button>
        </div>
    </div>

    <div id="screen-report" class="screen">
        <div class="menu-container" style="background: #f4f4f4; color: #333;">
            <div class="menu-card" style="width: 100%; max-width: 600px;">
                <h1 style="margin:0;">Assessment Report</h1>
                <div id="final-badge" class="level-badge lvl-3">Level 3</div>
                <p id="final-msg" style="font-size:1.1em; color:#555;">On Grade Level</p>
                
                <div id="report-grid" class="strength-grid"></div>

                <button class="menu-btn" style="margin-top:25px; text-align:center; background:var(--active); color:white;" onclick="location.reload()">Return to Menu</button>
            </div>
        </div>
    </div>

    <script>
        // --- MASTER GENERATORS (Infinite Variations) ---
        
        const GENERATORS = {
            // NUMBER SENSE (NSO)
            NSO: [
                () => { // Expanded Form (Std. MA.3.NSO.1.1)
                    let n = 1000 + Math.floor(Math.random() * 8999);
                    let th = Math.floor(n/1000)*1000, h = Math.floor((n%1000)/100)*100, t = Math.floor((n%100)/10)*10, o = n%10;
                    return { cat: "NSO", type: "choice", layout: "full", text: `What is the expanded form of <b>${n.toLocaleString()}</b>?`, opts: [`${th} + ${h} + ${t} + ${o}`, `${th} + ${h/10} + ${t} + ${o}`, `${Math.floor(n/1000)} + ${Math.floor((n%1000)/100)} + ${Math.floor((n%100)/10)} + ${o}`].sort(()=>Math.random()-0.5), ans: `${th} + ${h} + ${t} + ${o}` };
                },
                () => { // Rounding (Std. MA.3.NSO.1.4)
                    let n = Math.floor(Math.random()*800)+120;
                    let target = Math.random() > 0.5 ? 10 : 100; 
                    let rounded = Math.round(n/target)*target;
                    return { cat: "NSO", type: "input", layout: "full", text: `Round <b>${n}</b> to the nearest ${target===10?'ten':'hundred'}.`, ans: rounded.toString() };
                },
                () => { // Decompose (Std. MA.3.NSO.1.2) - Multi-Select
                    let n = 2400; // Simplified for demo logic randomization
                    return { cat: "NSO", type: "multi-select", layout: "full", text: `Select <b>ALL</b> ways to represent 2,400.`, opts: ["24 hundreds", "2 thousands + 4 hundreds", "24 tens", "2,000 + 40"], ans: [0, 1] };
                },
                () => { // Multiplication Fact (Std. MA.3.NSO.2.2)
                    let a = Math.floor(Math.random()*8)+2, b = Math.floor(Math.random()*9)+2;
                    return { cat: "NSO", type: "input", layout: "full", text: `Solve: ${a} √ó ${b} = ?`, ans: (a*b).toString() };
                }
            ],
            
            // FRACTIONS (FR)
            FR: [
                () => { // Visual Fraction (Std. MA.3.FR.1.1)
                    let d = [3,4,6,8][Math.floor(Math.random()*4)];
                    return { cat: "FR", type: "choice", layout: "split", visual: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="white" stroke="#333" stroke-width="2"/><path d="M50,50 L50,5 A45,45 0 0,1 ${50 + 45 * Math.sin(2*Math.PI/d)},${50 - 45 * Math.cos(2*Math.PI/d)} Z" fill="#3498DB" stroke="#333"/></svg>`, text: `What fraction is shaded?`, opts: [`1/${d}`, `1/${d-1}`, `${d}/1`], ans: `1/${d}` };
                },
                () => { // Comparisons (Std. MA.3.FR.2.1) - Inline Choice
                    let d1 = 4, d2 = 8;
                    return { cat: "FR", type: "inline", layout: "full", text: "Complete the comparison.", sentence: [{text: "1/4 is "}, {type:"select", opts:["greater than","less than","equal to"], ans:"greater than"}, {text: " 1/8 because fourths are "}, {type:"select", opts:["larger","smaller"], ans:"larger"}, {text:" pieces."}] };
                },
                () => { // Number Line (Std. MA.3.FR.1.2)
                    return { cat: "FR", type: "choice", layout: "split", visual: `<svg viewBox="0 0 300 50"><line x1="10" y1="25" x2="290" y2="25" stroke="black" stroke-width="2"/><circle cx="150" cy="25" r="5" fill="red"/><text x="10" y="45">0</text><text x="290" y="45">1</text></svg>`, text: "The dot is halfway between 0 and 1. What fraction is this?", opts: ["1/2", "1/4", "3/4", "2/1"], ans: "1/2" };
                }
            ],

            // ALGEBRA (AR)
            AR: [
                () => { // Missing Factor (Std. MA.3.AR.2.3)
                    let a = Math.floor(Math.random()*9)+2, b = Math.floor(Math.random()*9)+2;
                    return { cat: "AR", type: "input", layout: "full", text: `Find the unknown number <i>p</i>:<br><br><b>${a} √ó <i>p</i> = ${a*b}</b>`, ans: b.toString() };
                },
                () => { // Patterns (Std. MA.3.AR.3.1)
                    let start = Math.floor(Math.random()*10), rule = Math.floor(Math.random()*5)+2;
                    return { cat: "AR", type: "choice", layout: "full", text: `Identify the rule for the pattern:<br><b>${start}, ${start+rule}, ${start+rule*2}, ${start+rule*3}...</b>`, opts: [`Add ${rule}`, `Multiply by ${rule}`, `Add ${rule+1}`], ans: `Add ${rule}` };
                },
                () => { // Word Problem (Std. MA.3.AR.1.2) - Multi-Step
                    let total = 50, a = Math.floor(Math.random()*10)+10, b = Math.floor(Math.random()*10)+5;
                    return { cat: "AR", type: "input", layout: "full", text: `Mia has 50 stickers. She gives ${a} to Ben and ${b} to Sara. How many stickers does she have left?`, ans: (50-a-b).toString() };
                }
            ],

            // GEOMETRY & MEASUREMENT (GR)
            GR: [
                () => { // Area/Perimeter Switch (Std. MA.3.GR.2.3)
                    let l = Math.floor(Math.random()*8)+3, w = Math.floor(Math.random()*5)+2;
                    let askArea = Math.random() > 0.5;
                    return { 
                        cat: "GR", type: "input", layout: "split", 
                        visual: `<svg viewBox="0 0 200 150"><rect x="50" y="40" width="100" height="70" fill="#ddd" stroke="black" stroke-width="2"/><text x="100" y="30" text-anchor="middle">${l} m</text><text x="160" y="80">${w} m</text></svg>`, 
                        text: `Calculate the <b>${askArea ? 'Area' : 'Perimeter'}</b> of the rectangle.`, 
                        ans: askArea ? (l*w).toString() : (2*l+2*w).toString() 
                    };
                },
                () => { // Table Match Attributes (Std. MA.3.GR.1.2)
                    return {
                        cat: "GR", type: "table", layout: "full",
                        text: "Classify the shape attributes.",
                        rows: ["Has 4 Right Angles", "Has 4 Equal Sides"],
                        cols: ["Rectangle", "Rhombus", "Both"],
                        ans: ["Rectangle", "Rhombus"]
                    };
                },
                () => { // Measurement Conversion (Std. MA.3.M.1.1)
                    let ft = Math.floor(Math.random()*5)+2;
                    return { cat: "GR", type: "input", layout: "full", text: `Convert: <b>${ft} feet = ? inches</b>`, ans: (ft*12).toString() };
                }
            ],

            // DATA (DP)
            DP: [
                () => { // Pictograph Key (Std. MA.3.DP.1.1)
                    let scale = [2,5,10][Math.floor(Math.random()*3)];
                    let count = Math.floor(Math.random()*4)+2;
                    return {
                        cat: "DP", type: "input", layout: "split",
                        visual: `<div style="border:2px solid #333; padding:10px; font-size:1.2em;"><b>Key:</b> ‚≠ê = ${scale} Books<hr><b>Reading:</b> ${"‚≠ê".repeat(count)}</div>`,
                        text: `According to the key, how many books were read?`,
                        ans: (scale*count).toString()
                    };
                }
            ]
        };

        // --- ENGINE ---
        let sessionQ = [], curIdx = 0, userAnswers = [];

        function initSession(mode, count) {
            sessionQ = []; userAnswers = [];
            for(let i=0; i<count; i++) {
                let cat = mode === 'ALL' ? ['NSO','FR','AR','GR','DP'][Math.floor(Math.random()*5)] : mode;
                let gens = GENERATORS[cat];
                if(gens) sessionQ.push(gens[Math.floor(Math.random() * gens.length)]());
            }
            curIdx = 0;
            document.getElementById('session-label').innerText = mode === 'ALL' ? "Full FAST Mock" : mode + " Domain";
            document.getElementById('q-total').innerText = count;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-test').classList.add('active');
            renderQ();
        }

        function renderQ() {
            const q = sessionQ[curIdx];
            const stage = document.getElementById('stage');
            const ans = userAnswers[curIdx] || {};

            let left = q.layout === "split" ? `<div class="left-pane">${q.visual}</div>` : "";
            let rClass = q.layout === "split" ? "right-pane" : "right-pane";
            if(q.layout === 'full') left = "";

            let html = "";
            
            if(q.type === 'choice') {
                q.opts.forEach(o => {
                    let sel = ans === o ? 'selected' : '';
                    html += `<div class="opt-row ${sel}" onclick="save('${o}')"><div class="bubble"></div>${o}</div>`;
                });
            }
            else if (q.type === 'multi-select') {
                q.opts.forEach((o, i) => {
                    let savedArr = userAnswers[curIdx] || [];
                    let sel = savedArr.includes(i) ? 'selected' : '';
                    html += `<div class="opt-row ${sel}" onclick="saveMulti(${i})"><div class="bubble square"></div>${o}</div>`;
                });
            }
            else if (q.type === 'input') {
                html = `<input class="input-box" value="${ans||''}" onchange="save(this.value)" placeholder="?">`;
            }
            else if (q.type === 'table') {
                html += `<table class="match-table"><thead><tr><th></th>`;
                q.cols.forEach(c => html += `<th>${c}</th>`);
                html += `</tr></thead><tbody>`;
                q.rows.forEach((r, rIdx) => {
                    html += `<tr><td><b>${r}</b></td>`;
                    q.cols.forEach(c => {
                        let checked = (ans[rIdx] === c) ? "checked" : "";
                        html += `<td><input type="radio" name="row${rIdx}" class="radio-big" ${checked} onclick="saveTable(${rIdx}, '${c}')"></td>`;
                    });
                    html += `</tr>`;
                });
                html += `</tbody></table>`;
            }
            else if (q.type === 'inline') {
                html += `<div style="line-height:2.5;">`;
                q.sentence.forEach((part, idx) => {
                    if(part.type === 'select') {
                        let val = ans[idx] || "Select...";
                        html += `<select class="inline-select" onchange="saveInline(${idx}, this.value)"><option disabled selected>${val}</option>`;
                        part.opts.forEach(o => html += `<option value="${o}">${o}</option>`);
                        html += `</select>`;
                    } else {
                        html += `<span>${part.text}</span>`;
                    }
                });
                html += `</div>`;
            }

            stage.innerHTML = `
                ${left}
                <div class="pane ${q.layout==='full'?'':'right-pane'}" style="width:${q.layout==='full'?'100%':'60%'}">
                    <div class="q-header">${q.cat} ‚Ä¢ Item ${curIdx+1}</div>
                    <div class="q-text">${q.text}</div>
                    ${html}
                </div>
            `;
            document.getElementById('btn-next').innerText = (curIdx === sessionQ.length-1) ? "Finish" : "Next";
            document.getElementById('q-idx').innerText = curIdx + 1;
        }

        // --- SAVING ---
        window.save = (val) => { userAnswers[curIdx] = val; renderQ(); };
        window.saveMulti = (idx) => { 
            let arr = userAnswers[curIdx] || [];
            if(arr.includes(idx)) arr = arr.filter(x=>x!==idx); else arr.push(idx);
            userAnswers[curIdx] = arr; renderQ();
        };
        window.saveTable = (rIdx, val) => { let cur = userAnswers[curIdx] || {}; cur[rIdx] = val; userAnswers[curIdx] = cur; };
        window.saveInline = (idx, val) => { let cur = userAnswers[curIdx] || {}; cur[idx] = val; userAnswers[curIdx] = cur; };

        window.nextQ = () => { if(curIdx < sessionQ.length-1) { curIdx++; renderQ(); } else { finishSession(); } };
        window.prevQ = () => { if(curIdx > 0) { curIdx--; renderQ(); } };
        window.toggleZoom = () => { document.body.style.zoom = document.body.style.zoom === "1.2" ? "1" : "1.2"; }

        function finishSession() {
            let score = 0;
            let stats = { NSO:{c:0,t:0}, FR:{c:0,t:0}, AR:{c:0,t:0}, GR:{c:0,t:0}, DP:{c:0,t:0} };

            sessionQ.forEach((q, i) => {
                let ans = userAnswers[i];
                let isCorrect = false;

                if (q.type === 'choice' || q.type === 'input') isCorrect = (ans == q.ans);
                else if (q.type === 'multi-select') {
                    if(ans && ans.length === q.ans.length && q.ans.every(v => ans.includes(v))) isCorrect = true;
                }
                else if (q.type === 'table') isCorrect = (ans[0] === q.ans[0] && ans[1] === q.ans[1]);
                else if (q.type === 'inline') {
                    isCorrect = true;
                    q.sentence.forEach((p, idx) => { if(p.type==='select' && ans[idx]!==p.ans) isCorrect=false; });
                }

                if(!stats[q.cat]) stats[q.cat] = {c:0,t:0};
                stats[q.cat].t++;
                if(isCorrect) { score++; stats[q.cat].c++; }
            });

            // REPORT
            let pct = Math.round((score / sessionQ.length) * 100);
            let lvl = 1, txt = "Level 1", cls = "lvl-1", msg = "Intervention Needed";
            if(pct >= 40) { lvl=2; txt="Level 2"; cls="lvl-2"; msg="Below Satisfactory"; }
            if(pct >= 60) { lvl=3; txt="Level 3"; cls="lvl-3"; msg="On Grade Level"; }
            if(pct >= 80) { lvl=4; txt="Level 4"; cls="lvl-4"; msg="Proficient"; }
            if(pct >= 90) { lvl=5; txt="Level 5"; cls="lvl-5"; msg="Mastery!"; }

            document.getElementById('final-badge').className = "level-badge " + cls;
            document.getElementById('final-badge').innerText = txt;
            document.getElementById('final-msg').innerText = `${msg} (${pct}%)`;

            let html = "";
            for(let k in stats) {
                if(stats[k].t === 0) continue;
                let sPct = Math.round((stats[k].c / stats[k].t) * 100);
                let label = sPct >= 60 ? "‚úÖ Strength" : "‚ö†Ô∏è Needs Practice";
                let status = sPct >= 60 ? "good" : "bad";
                html += `<div class="strength-box ${status}"><h3>${k}</h3><div style="display:flex;justify-content:space-between"><span>${stats[k].c}/${stats[k].t}</span><span>${label}</span></div></div>`;
            }
            document.getElementById('report-grid').innerHTML = html;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-report').classList.add('active');
        }
    </script>
</body>
</html>
