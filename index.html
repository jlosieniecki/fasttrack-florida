<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FAST Grade 3 - Mastery Edition (Lv 3-5)</title>
    <style>
        :root { --header: #003057; --bg: #F5F7FA; --active: #003057; --text: #333; }
        
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* SCREENS */
        .screen { display: none; height: 100%; width: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* MENU */
        .menu-container { overflow-y: auto; padding: 20px; text-align: center; background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; min-height: 100%; }
        .menu-btn { background: white; color: #333; border: none; padding: 15px; margin: 5px; width: 100%; max-width: 600px; text-align: left; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .menu-btn:hover { background: #eef6fc; color: var(--active); }
        
        details { background: rgba(255,255,255,0.1); margin: 10px auto; max-width: 600px; border-radius: 4px; text-align: left; }
        summary { padding: 15px; cursor: pointer; font-weight: bold; list-style: none; display: flex; justify-content: space-between; }
        summary:after { content: '+'; }
        details[open] summary:after { content: '-'; }
        details[open] summary { background: rgba(0,0,0,0.2); }

        /* TEST AREA */
        .top-bar { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; }
        .stage { flex: 1; padding: 20px; overflow-y: auto; display: flex; justify-content: center; background: white; }
        .q-card { width: 100%; max-width: 900px; padding-bottom: 100px; }
        
        /* ITEM TYPES */
        h2 { border-bottom: 1px solid #ccc; padding-bottom: 10px; color: #444; font-size: 1.1em; text-transform: uppercase; }
        .prompt { font-size: 1.3em; margin-bottom: 20px; line-height: 1.6; }
        
        .mc-opt { padding: 15px; border: 1px solid #ddd; margin: 8px 0; cursor: pointer; display: flex; align-items: center; border-radius: 4px; transition: 0.2s; }
        .mc-opt:hover { background: #f5f5f5; }
        .mc-opt.selected { background: #e3f2fd; border-color: var(--active); font-weight: bold; }
        .bubble { width: 20px; height: 20px; border: 2px solid #555; border-radius: 50%; margin-right: 15px; background: white; }
        .mc-opt.selected .bubble { background: #003057; border-color: #003057; }
        .bubble.square { border-radius: 3px; }

        .hot-text-box { font-size: 1.4em; line-height: 2; padding: 20px; background: #fafafa; border: 1px solid #ccc; border-radius: 4px; }
        .hot-span { padding: 4px 8px; margin: 0 4px; cursor: pointer; border-radius: 3px; border: 2px solid transparent; }
        .hot-span:hover { background: #e0e0e0; }
        .hot-span.selected { background: #cce5ff; border-color: var(--active); font-weight: bold; }

        .edit-select { font-size: 1.1em; font-weight: bold; padding: 5px; border: 2px solid #333; background: #eef; cursor: pointer; }

        /* VISUALS */
        .visual-container { display: flex; justify-content: center; margin: 20px 0; }
        svg { max-width: 100%; max-height: 300px; }
        
        .fraction-slice { fill: white; stroke: #333; stroke-width: 2; cursor: pointer; }
        .fraction-slice:hover { fill: #eee; }
        .fraction-slice.active { fill: var(--active); }

        .bar-col { fill: var(--active); opacity: 0.7; stroke: #333; cursor: pointer; transition: height 0.3s; }
        .bar-col:hover { opacity: 1; }

        /* NAV */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 70px; background: #eee; border-top: 1px solid #999; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; box-sizing: border-box; }
        .nav-btn { padding: 12px 30px; font-weight: bold; cursor: pointer; border: 1px solid #999; background: white; border-radius: 4px; font-size: 1em; }
        .nav-btn.primary { background: var(--active); color: white; border-color: var(--active); }

    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <div class="menu-container">
            <h1>FAST Math Mastery (Lv 3-5)</h1>
            <button class="menu-btn" onclick="startTest('ALL', 40)" style="text-align:center; margin-bottom:30px;">üöÄ Start Full Mock Exam (40 Items)</button>

            <details open>
                <summary>üî¢ Number Sense (NSO)</summary>
                <button class="menu-btn" onclick="startTest('MA.3.NSO.1.1', 5)">NSO.1.1: Read/Write Numbers</button>
                <button class="menu-btn" onclick="startTest('MA.3.NSO.1.2', 5)">NSO.1.2: Compose/Decompose</button>
                <button class="menu-btn" onclick="startTest('MA.3.NSO.1.3', 5)">NSO.1.3: Comparing Numbers</button>
                <button class="menu-btn" onclick="startTest('MA.3.NSO.1.4', 5)">NSO.1.4: Rounding</button>
                <button class="menu-btn" onclick="startTest('MA.3.NSO.2.1', 5)">NSO.2.1: Add/Sub (Multi-Step)</button>
                <button class="menu-btn" onclick="startTest('MA.3.NSO.2.2', 5)">NSO.2.2: Multiplication Facts</button>
                <button class="menu-btn" onclick="startTest('MA.3.NSO.2.3', 5)">NSO.2.3: Mult Strategies</button>
                <button class="menu-btn" onclick="startTest('MA.3.NSO.2.4', 5)">NSO.2.4: Division Facts</button>
            </details>

            <details>
                <summary>üçï Fractions (FR)</summary>
                <button class="menu-btn" onclick="startTest('MA.3.FR.1.1', 5)">FR.1.1: Represent Fractions</button>
                <button class="menu-btn" onclick="startTest('MA.3.FR.1.2', 5)">FR.1.2: Number Lines</button>
                <button class="menu-btn" onclick="startTest('MA.3.FR.1.3', 5)">FR.1.3: Fraction Equivalence</button>
                <button class="menu-btn" onclick="startTest('MA.3.FR.2.1', 5)">FR.2.1: Comparing Fractions</button>
                <button class="menu-btn" onclick="startTest('MA.3.FR.2.2', 5)">FR.2.2: Equivalent Fractions</button>
            </details>

            <details>
                <summary>üß† Algebraic Reasoning (AR)</summary>
                <button class="menu-btn" onclick="startTest('MA.3.AR.1.1', 5)">AR.1.1: Distributive Property</button>
                <button class="menu-btn" onclick="startTest('MA.3.AR.1.2', 5)">AR.1.2: Two-Step Problems</button>
                <button class="menu-btn" onclick="startTest('MA.3.AR.2.1', 5)">AR.2.1: Division Logic</button>
                <button class="menu-btn" onclick="startTest('MA.3.AR.2.3', 5)">AR.2.3: Missing Factors</button>
                <button class="menu-btn" onclick="startTest('MA.3.AR.3.1', 5)">AR.3.1: Patterns</button>
                <button class="menu-btn" onclick="startTest('MA.3.AR.3.3', 5)">AR.3.3: Input/Output</button>
            </details>

            <details>
                <summary>üìê Geometry & Data (GR/M/DP)</summary>
                <button class="menu-btn" onclick="startTest('MA.3.GR.1.2', 5)">GR.1.2: Attributes of Shapes</button>
                <button class="menu-btn" onclick="startTest('MA.3.GR.2.1', 5)">GR.2.1: Area (Tiling)</button>
                <button class="menu-btn" onclick="startTest('MA.3.GR.2.2', 5)">GR.2.2: Area (Formula)</button>
                <button class="menu-btn" onclick="startTest('MA.3.GR.2.3', 5)">GR.2.3: Perimeter (Missing Side)</button>
                <button class="menu-btn" onclick="startTest('MA.3.M.1.1', 5)">M.1.1: Measurement</button>
                <button class="menu-btn" onclick="startTest('MA.3.M.2.1', 5)">M.2.1: Telling Time (Analog)</button>
                <button class="menu-btn" onclick="startTest('MA.3.M.2.2', 5)">M.2.2: Elapsed Time</button>
                <button class="menu-btn" onclick="startTest('MA.3.DP.1.1', 5)">DP.1.1: Graphing</button>
            </details>
        </div>
    </div>

    <div id="screen-test" class="screen">
        <div class="top-bar">
            <div><strong>Student: Guest</strong> | FAST Math G3</div>
            <button onclick="location.reload()" style="background:none; border:1px solid #333; padding:5px 10px; cursor:pointer;">Exit</button>
        </div>
        <div class="stage">
            <div id="q-container" class="q-card"></div>
        </div>
        <div class="nav-bar">
            <button class="nav-btn" onclick="prevQ()">Back</button>
            <div style="font-weight:bold;">Item <span id="q-idx">1</span> of <span id="q-total">0</span></div>
            <button class="nav-btn primary" onclick="nextQ()">Next</button>
        </div>
    </div>

    <script>
        // --- DRAWING ENGINE (SVG) ---
        
        function drawClock(h, m) {
            // Rotations: Hour hand moves 0.5 deg per minute. Minute hand moves 6 deg per minute.
            let mAng = m * 6;
            let hAng = (h % 12) * 30 + (m * 0.5);
            
            // Convert to coordinates (Center 50,50, Radius 40)
            // Subtract 90deg (PI/2) to adjust for 12 o'clock start
            let mRad = (mAng - 90) * Math.PI / 180;
            let hRad = (hAng - 90) * Math.PI / 180;
            
            let hx = 50 + 25 * Math.cos(hRad), hy = 50 + 25 * Math.sin(hRad);
            let mx = 50 + 35 * Math.cos(mRad), my = 50 + 35 * Math.sin(mRad);

            let ticks = "";
            for(let i=0; i<12; i++) {
                let ang = (i * 30 - 90) * Math.PI / 180;
                let x1 = 50 + 35 * Math.cos(ang), y1 = 50 + 35 * Math.sin(ang);
                let x2 = 50 + 40 * Math.cos(ang), y2 = 50 + 40 * Math.sin(ang);
                ticks += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#333" stroke-width="2"/>`;
            }

            return `<svg viewBox="0 0 100 100" style="height:250px;">
                <circle cx="50" cy="50" r="45" fill="white" stroke="#333" stroke-width="3"/>
                ${ticks}
                <line x1="50" y1="50" x2="${hx}" y2="${hy}" stroke="black" stroke-width="4" stroke-linecap="round"/>
                <line x1="50" y1="50" x2="${mx}" y2="${my}" stroke="#003057" stroke-width="3" stroke-linecap="round"/>
                <circle cx="50" cy="50" r="3" fill="#333"/>
                <text x="50" y="20" text-anchor="middle" font-size="8" font-weight="bold">12</text>
                <text x="85" y="53" text-anchor="middle" font-size="8" font-weight="bold">3</text>
                <text x="50" y="88" text-anchor="middle" font-size="8" font-weight="bold">6</text>
                <text x="15" y="53" text-anchor="middle" font-size="8" font-weight="bold">9</text>
            </svg>`;
        }

        function drawFraction(den, activeIndices) {
            let paths = "";
            for(let i=0; i<den; i++) {
                let start = (i * 360 / den - 90) * Math.PI/180;
                let end = ((i+1) * 360 / den - 90) * Math.PI/180;
                let x1 = 50 + 45*Math.cos(start), y1 = 50 + 45*Math.sin(start);
                let x2 = 50 + 45*Math.cos(end), y2 = 50 + 45*Math.sin(end);
                let active = activeIndices.includes(i);
                paths += `<path d="M50,50 L${x1},${y1} A45,45 0 0,1 ${x2},${y2} Z" 
                          fill="${active ? '#003057' : 'white'}" stroke="#333" stroke-width="2" 
                          onclick="toggleSlice(${i})" style="cursor:pointer;"/>`;
            }
            return `<svg viewBox="0 0 100 100" style="height:250px;">
                <circle cx="50" cy="50" r="45" fill="none"/>
                ${paths}
            </svg>`;
        }

        function drawGraph(vals, max) {
            let bars = "";
            vals.forEach((v, i) => {
                let h = (v / max) * 250;
                let y = 300 - h - 30; // 300 total height, 30 padding bottom
                bars += `<rect x="${50 + i*60}" y="${y}" width="40" height="${h}" 
                         fill="#003057" stroke="#333" opacity="0.8" onclick="clickGraph(event, ${i}, ${max})" />`;
            });
            return `<svg viewBox="0 0 300 300" style="height:300px; width:100%;">
                <line x1="30" y1="30" x2="30" y2="270" stroke="#333" stroke-width="2"/>
                <line x1="30" y1="270" x2="280" y2="270" stroke="#333" stroke-width="2"/>
                ${bars}
                <text x="70" y="290" text-anchor="middle">A</text>
                <text x="130" y="290" text-anchor="middle">B</text>
                <text x="190" y="290" text-anchor="middle">C</text>
            </svg>`;
        }

        // --- GENERATORS (Level 3-5 Only) ---
        const uuid = () => Math.random().toString(36).substr(2,9);
        const randInt = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
        
        const STANDARDS = {
            // NSO --------------------------------------
            "MA.3.NSO.1.1": [
                () => { // Lv 4: Select All
                    let n = randInt(1000,9000);
                    return { id:uuid(), type:'multi', std:'NSO.1.1 (Lv4)', text:`Select <b>ALL</b> ways to represent <b>${n.toLocaleString()}</b>.`, 
                        opts: [
                            {txt:`${Math.floor(n/1000)} thousands, ${n%1000} ones`, corr:true},
                            {txt:`${n} ones`, corr:true},
                            {txt:`${Math.floor(n/100)} hundreds`, corr:false},
                            {txt:`${Math.floor(n/10)} tens, ${n%10} ones`, corr:true}
                        ] };
                },
                () => { // Lv 5: Error Analysis
                    let n = 4502;
                    return { id:uuid(), type:'mc', std:'NSO.1.1 (Lv5)', text:`Student A says 4,502 is "4 thousands, 50 hundreds, and 2 ones." Is the student correct?`, 
                        opts: [
                            {txt:`Yes`, corr:false},
                            {txt:`No, 50 hundreds is 5,000. It should be 5 hundreds.`, corr:true},
                            {txt:`No, they forgot the tens place.`, corr:false},
                            {txt:`No, it should be 45 thousands.`, corr:false}
                        ] };
                }
            ],
            "MA.3.NSO.1.2": [
                () => { // Lv 4: Compose
                   return { id:uuid(), type:'mc', std:'NSO.1.2 (Lv4)', text:`Which number is equal to 14 hundreds and 12 tens?`, 
                       opts:[{txt:"1,520", corr:true}, {txt:"1,412", corr:false}, {txt:"2,600", corr:false}] };
                }
            ],
            "MA.3.NSO.1.4": [
                () => { // Lv 3: Rounding Table
                    let n = randInt(100,900);
                    return { id:uuid(), type:'edit', std:'NSO.1.4 (Lv3)', text:`Round <b>${n}</b>.`, template:`Nearest 10: [D1] <br> Nearest 100: [D2]`, 
                        drops:{ D1:{opts:[Math.round(n/10)*10,(Math.round(n/10)*10)+10],ans:Math.round(n/10)*10}, D2:{opts:[Math.round(n/100)*100, (Math.round(n/100)*100)+100],ans:Math.round(n/100)*100}} };
                }
            ],
            // FR ---------------------------------------
            "MA.3.FR.1.1": [
                 () => { // Lv 3: Visual
                     let d = 8, n = randInt(1,7);
                     return { id:uuid(), type:'fraction', std:'FR.1.1 (Lv3)', text:`Click to shade <b>${n}/${d}</b>.`, total:d, ans:n };
                 }
            ],
            // AR ---------------------------------------
            "MA.3.AR.1.2": [
                () => { // Lv 4: Multi-Step
                    let start=50, sub=12, add=5;
                    return { id:uuid(), type:'eq', std:'AR.1.2 (Lv4)', text:`Start with ${start}. Subtract ${sub}. Then add ${add}. What is the number?`, ans: (start-sub+add).toString() };
                }
            ],
            "MA.3.AR.2.3": [
                () => { // Lv 4: Missing Factor
                    let a=7, b=8;
                    return { id:uuid(), type:'eq', std:'AR.2.3 (Lv4)', text:`Find k: 56 √∑ k = 7`, ans:"8" };
                }
            ],
            // GEOM & DATA ------------------------------
            "MA.3.M.2.1": [
                 () => { // Lv 3: Analog Clock
                     let h = randInt(1,12), m = randInt(0,11)*5;
                     let mStr = m<10?`0${m}`:m;
                     return { id:uuid(), type:'clock', std:'M.2.1 (Lv3)', text:`What time is on the clock?`, h:h, m:m, 
                         opts:[{txt:`${h}:${mStr}`, corr:true}, {txt:`${h+1}:${mStr}`, corr:false}, {txt:`${h>1?h-1:12}:${mStr}`, corr:false}] };
                 }
            ],
            "MA.3.GR.2.3": [
                () => { // Lv 4: Missing Side
                    let p = 24, w = 4; // L = (24 - 8)/2 = 8
                    return { id:uuid(), type:'eq', std:'GR.2.3 (Lv4)', text:`The perimeter of a rectangle is 24 ft. The width is 4 ft. What is the length?`, ans:"8" };
                }
            ],
            "MA.3.DP.1.1": [
                 () => { // Lv 3: Graphing
                     let v = [5, 8, 3];
                     return { id:uuid(), type:'graph', std:'DP.1.1 (Lv3)', text:`Graph the data: A=5, B=8, C=3.`, max:10, ans:v };
                 }
            ]
        };

        // --- RENDERER ---
        let queue=[], curr=0, answers={};

        function startTest(mode, count) {
            queue=[]; answers={}; curr=0;
            let keys = Object.keys(STANDARDS);
            if(mode !== 'ALL') keys = keys.filter(k => k === mode);
            
            for(let i=0; i<count; i++) {
                let k = keys[Math.floor(Math.random()*keys.length)];
                let gens = STANDARDS[k];
                if(gens) queue.push(gens[Math.floor(Math.random()*gens.length)]());
            }
            if(queue.length===0) return alert("Standard not fully implemented yet in this demo.");
            
            document.getElementById('screen-menu').classList.remove('active');
            document.getElementById('screen-test').classList.add('active');
            document.getElementById('q-total').innerText = queue.length;
            render();
        }

        function render() {
            let q = queue[curr];
            let ans = answers[q.id];
            let html = `<h2>${q.std}</h2><div class="prompt">${q.text}</div>`;
            
            if(q.type === 'mc' || q.type === 'clock') {
                q.opts = q.opts || []; // Clock logic might handle opts differently
                if(q.type === 'clock') html += `<div class="visual-container">${drawClock(q.h, q.m)}</div>`;
                q.opts.forEach((o, i) => {
                    let sel = ans === i ? 'selected' : '';
                    html += `<div class="mc-opt ${sel}" onclick="save(${i})"><div class="bubble"></div>${o.txt}</div>`;
                });
            }
            else if(q.type === 'multi') {
                ans = ans || [];
                q.opts.forEach((o, i) => {
                    let sel = ans.includes(i) ? 'selected' : '';
                    html += `<div class="mc-opt ${sel}" onclick="saveMulti(${i})"><div class="bubble square"></div>${o.txt}</div>`;
                });
            }
            else if(q.type === 'eq') {
                html += `<input class="edit-select" style="width:150px; font-size:1.5em;" oninput="save(this.value)" value="${ans||''}" placeholder="?">`;
            }
            else if(q.type === 'edit') {
                let t = q.template;
                for(let k in q.drops) {
                    let saved = ans ? ans[k] : "";
                    let s = `<select class="edit-select" onchange="saveDrop('${k}',this.value)"><option disabled ${saved===''?'selected':''}>?</option>`;
                    q.drops[k].opts.forEach(o => s+=`<option ${saved==o?'selected':''}>${o}</option>`);
                    s += `</select>`;
                    t = t.replace(`[${k}]`, s);
                }
                html += `<div style="font-size:1.4em; line-height:2">${t}</div>`;
            }
            else if(q.type === 'fraction') {
                ans = ans || [];
                html += `<div class="visual-container">${drawFraction(q.total, ans)}</div>`;
            }
            else if(q.type === 'graph') {
                ans = ans || [0,0,0];
                html += `<div class="visual-container">${drawGraph(ans, q.max)}</div><p style="text-align:center">Click bars to set height</p>`;
            }

            document.getElementById('q-container').innerHTML = html;
            document.getElementById('q-idx').innerText = curr+1;
        }

        // --- SAVING ---
        window.save = v => { answers[queue[curr].id] = v; if(queue[curr].type.includes('mc')) render(); };
        window.saveMulti = i => { 
            let a = answers[queue[curr].id] || [];
            if(a.includes(i)) a=a.filter(x=>x!==i); else a.push(i);
            answers[queue[curr].id]=a; render(); 
        };
        window.saveDrop = (k,v) => {
            let a = answers[queue[curr].id] || {};
            a[k]=v; answers[queue[curr].id]=a;
        };
        window.toggleSlice = i => {
             let a = answers[queue[curr].id] || [];
             if(a.includes(i)) a=a.filter(x=>x!==i); else a.push(i);
             answers[queue[curr].id]=a; render();
        };
        window.clickGraph = (e, i, max) => {
             let rect = e.target.parentElement.getBoundingClientRect(); // Get SVG bounds
             // Simple logic for demo: increment height
             let a = answers[queue[curr].id] || [0,0,0];
             a[i] = (a[i]+1) % (max+1);
             answers[queue[curr].id]=a; render();
        };

        window.nextQ = () => { if(curr<queue.length-1){curr++; render();} else alert("Done!"); };
        window.prevQ = () => { if(curr>0){curr--; render();} };

    </script>
</body>
</html>
